import{_ as d,e as k,f as o,i as a,g as s,j as n,h as e,r as p,o as g}from"./app-DYhRGUjb.js";const u={};function c(m,i){const l=p("RouteLink"),h=p("Tabs");return g(),k("div",null,[i[67]||(i[67]=o('<h1 id="安装与配置-nixos-篇" tabindex="-1"><a class="header-anchor" href="#安装与配置-nixos-篇"><span>安装与配置（NixOS 篇）</span></a></h1><details class="hint-container details"><summary>前言</summary><p>早在去年我便说过我的下一个操作系统很有可能是 NixOS。202405 的 OS 课需要做 PPT 汇报，我的选题是包管理器杂谈，又吹了一波 nix，把我自己心吹得痒痒的。</p><p>在考试期间由于压抑的氛围和不情愿的学习，平常想做的事的欲望会被放大许多。但是我预料到 NixOS 的安装肯定会非常折磨（好预测！），所以只在 WSL 里尝尝鲜。而 WSL 终究无法发挥出 Nix 的特色。于是熬到了考完试当晚，我就开始安装 NixOS 了。</p><p>之后由于换台式机，有半年没有再用过 NixOS；后来由于有在多个设备上安装 Linux 的需求，就在 7 月中下旬又捡起了 NixOS，并且大幅改了配置。</p></details><p>NixOS 绝对不适合 Linux 新手使用，如果你想尝试 NixOS，请务必对 Linux 的启动流程有一定了解，并具有稳定的代理/网络环境后再尝试。</p><h2 id="nixos-安装" tabindex="-1"><a class="header-anchor" href="#nixos-安装"><span>NixOS 安装</span></a></h2>',4)),a(h,{id:"20",data:[{id:"默认隐藏，切 tab 查看"},{id:"首次安装"},{id:"二次入坑"},{id:"NixOS-WSL"}]},{title0:n(({value:t,isActive:r})=>i[0]||(i[0]=[e("默认隐藏，切 tab 查看")])),title1:n(({value:t,isActive:r})=>i[1]||(i[1]=[e("首次安装")])),title2:n(({value:t,isActive:r})=>i[2]||(i[2]=[e("二次入坑")])),title3:n(({value:t,isActive:r})=>i[3]||(i[3]=[e("NixOS-WSL")])),tab0:n(({value:t,isActive:r})=>i[4]||(i[4]=[s("p",null,null,-1)])),tab1:n(({value:t,isActive:r})=>[i[19]||(i[19]=s("p",null,[e("安装我看的是"),s("a",{href:"https://nixos-cn.org/tutorials/installation/Subsystem.html",target:"_blank",rel:"noopener noreferrer"},"NixOS 中文"),e("。")],-1)),i[20]||(i[20]=s("p",null,"NixOS 的安装比我想象的要折磨得多。原以为装过 Arch 的我已经无惧困难，结果输得非常彻底。。一大原因是因为没有 Archlinux 那样的顶级文档，而另一个则是群友人数确实更少，解答问题的也更少。不过这些都是后话了。",-1)),i[21]||(i[21]=s("p",null,"我是在还没有学习 nix 语言和特性的情况下装的系统，踩了不少坑。",-1)),s("p",null,[i[8]||(i[8]=e("首先，我")),a(l,{to:"/articles/linux/basic.html#%E8%B0%83%E6%95%B4%E5%A4%A7%E5%B0%8F"},{default:n(()=>i[5]||(i[5]=[e("缩了 ArchLinux 的分区大小")])),_:1}),i[9]||(i[9]=e("，踩了一次 ")),a(l,{to:"/articles/linux/problem.html#cfdisk-%E6%93%8D%E4%BD%9C%E5%88%86%E5%8C%BA"},{default:n(()=>i[6]||(i[6]=[e("cfdisk 的坑")])),_:1}),i[10]||(i[10]=e("。而后下载了 NixOS 的图形化安装程序，用 ventoy 引导启动，一切正常。然而在安装引导的分区时我发现，图形化界面没有提供 btrfs 分区，只提供 ext4。于是我停止使用图形化界面，改用里面的 konsole 终端。结果 channel update 时无法正常重启某些服务（")),i[11]||(i[11]=s("code",null,"xe-daemon.service: NewCachedXenstore error: Cannot locate xenbus dev path...",-1)),i[12]||(i[12]=e("）。我猜测这是图形界面导致的问题，于是我重新打开 arch，下载了 minimal iso，这里面还有一个")),a(l,{to:"/articles/linux/problem.html#%E4%BD%A0%E7%9A%84%E5%A4%8D%E5%88%B6%E6%98%AF%E7%9C%9F%E6%AD%A3%E7%9A%84%E5%A4%8D%E5%88%B6"},{default:n(()=>i[7]||(i[7]=[e("好玩的小插曲")])),_:1}),i[13]||(i[13]=e("。"))]),i[22]||(i[22]=s("p",null,[e("果然进了 minimal iso "),s("s",null,"有一种回家的感觉"),e("，并且确实没有重启服务失败的问题了。一番鼓捣，总结出一些规律：")],-1)),i[23]||(i[23]=s("ul",null,[s("li",null,[e("碰到 "),s("code",null,"HTTP error 200 (curl error: Stream error in the HTTP/2 framing layer)"),e(" 不要管，后台会重试。（说到底，code 200 还报 error 是我没想到的）")]),s("li",null,[e("如果 "),s("code",null,"denpendency fail to build"),e("，换个源重新试。 "),s("ul",null,[s("li",null,"如果换源后碰到同样的问题，把源换回去再试。")])]),s("li",null,[e("安装过程中遇到 "),s("code",null,"core dumped"),e("。。。emmm，这有点脑残了，不过换了个源又好了，可能是因为没拉到缓存，构建时 core dump？")])],-1)),i[24]||(i[24]=s("p",null,[e("就这样，两个源交替查缺补漏，总算是 install success 了。“最终退后三步朝电脑跪拜祈求它能正常开机，至此基本安装教程完毕。”——才怪，sddm 进去后，root 和我都无法登录（保证密码正确）。于是类似 Arch 那样重走挂载流程，"),s("code",null,"nixos-enter"),e(" 进去修。")],-1)),i[25]||(i[25]=s("p",null,"这进去一 rebuild 我就感觉不对劲，此处把报错贴出：",-1)),i[26]||(i[26]=s("div",{class:"language- line-numbers-mode","data-highlighter":"shiki","data-ext":"",style:{"--shiki-light":"#383A42","--shiki-dark":"#abb2bf","--shiki-light-bg":"#FAFAFA","--shiki-dark-bg":"#282c34"}},[s("pre",{class:"shiki shiki-themes one-light one-dark-pro vp-code"},[s("code",null,[s("span",{class:"line"},[s("span",null,"sudo: PAM account management error: Authentication service cannot retrieve authentication info")]),e(`
`),s("span",{class:"line"},[s("span",null,"sudo: a password is required")])])]),s("div",{class:"line-numbers","aria-hidden":"true",style:{"counter-reset":"line-number 0"}},[s("div",{class:"line-number"}),s("div",{class:"line-number"})])],-1)),i[27]||(i[27]=s("p",null,[e("求助群友，群友说 "),s("code",null,"nixos-install"),e(" 与 "),s("code",null,"nixos-rebuild"),e(" 效果基本是一样的，让我去外面用 install 试。效果确实差不多，不过每次在 livecd install 都相当于重装，无法用内部的缓存，全部重新下载，还是有点耗时的。install success 后再次 "),s("code",null,"nixos-enter"),e(" 试，还是一样的报错，只要用到 sudo 就会炸。鼓捣了大半天，reinstall 了好几次都无法解决，另一个管理说，在 "),s("code",null,"nixos-enter"),e(" 中这是正常现象，内核的表现是不一致的。我一直把 "),s("code",null,"nixos-enter"),e(" 当 "),s("code",null,"arch-chroot"),e(" 用，没想到这玩意这么捞。")],-1)),i[28]||(i[28]=s("ul",null,[s("li",null,[e("日后刷到了"),s("a",{href:"https://blog.lzc256.com/posts/recovering-sudo-in-nixos/",target:"_blank",rel:"noopener noreferrer"},"一篇博文"),e("，描述了另一个人是如何解决此问题的。我感觉这更像是 nixos 的 bug 而不是内核不一致。")])],-1)),i[29]||(i[29]=s("p",null,"这回重启就正常了，也不知道是其中的哪次 install 尝试起了作用。于是我成功进入系统开始激情编辑配置。",-1)),i[30]||(i[30]=s("h3",{id:"后记",tabindex:"-1"},[s("a",{class:"header-anchor",href:"#后记"},[s("span",null,"后记")])],-1)),i[31]||(i[31]=s("p",null,[e("第二天学校有实践课加上 cs2 出新图，没怎么折腾系统，尝试给电脑"),s("a",{href:"#%E6%98%BE%E5%8D%A1%E9%A9%B1%E5%8A%A8"},"装了个 nvidia 驱动"),e("和其他玩意就去睡觉了。")],-1)),i[32]||(i[32]=s("p",null,[e("第三天起床一开机，直接 dmesg 卡死无法切 tty。兄弟我还有课啊！于是带着去教室不听课，校园网认证还过不了，只好用手机开热点修。这次知道不能 "),s("code",null,"nixos-enter"),e(" 了，但是只能用小手机查资料，每次挂载输入一大串，用镜像输一大串，重新 install 等好久，试错成本偏高。加上我昨天配置改了很多，二分查找需要的次数也不可估量，因此还是非常慢的。（不能简单地放弃 NVIDIA 驱动，因为有 NixOS gaming 需求）")],-1)),i[33]||(i[33]=s("p",null,[e("二分查错过程中我发现每次 install 并不会重新写入 EFI 分区（配置里注释了启动项，但是 grub 菜单并没有消失），因此向群友提问。群友答日常 build 和 install 是不会擦除 EFI 的，只有 gc 时会。但是我并不在系统里，"),s("code",null,"nixos-enter"),e(" 如上文所述，并不能执行 gc 指令。")],-1)),s("p",null,[i[15]||(i[15]=e("后来怀疑是内核原因：我换了 zen 内核，按理需要用 dkms 的 NVIDIA 驱动，然而实际用的是 NVIDIA 闭源驱动。。换回原内核又发生了 ")),a(l,{to:"/articles/linux/problem.html#efi-%E7%A9%BA%E9%97%B4%E4%B8%8D%E8%B6%B3"},{default:n(()=>i[14]||(i[14]=[e("EFI 空间不足")])),_:1}),i[16]||(i[16]=e("的惨剧，又折腾许久。等我禁用了 NVIDIA 成功开机，都过了午饭时间了。然后一开机我就去")),i[17]||(i[17]=s("a",{href:"#iso-%E5%88%B6%E4%BD%9C"},"定制了一个 iso",-1)),i[18]||(i[18]=e("，太折磨了。"))]),i[34]||(i[34]=s("p",null,[e("下午折腾中文双拼输入法，详见"),s("a",{href:"#%E6%8B%BC%E9%9F%B3%E8%BE%93%E5%85%A5%E6%B3%95"},"输入法"),e("。")],-1)),i[35]||(i[35]=s("p",null,[e("又过了一天，我想起来 NVIDIA 驱动一直没开，而此时我已经做好了万全的准备，btrfs 打了快照，grub 加了禁用 nvidia 的启动项，自制了启动盘，是时候挑战 NVIDIA 驱动了！于是我开启了显卡驱动，果然又卡 dmesg 了。把 "),s("code",null,"hardware.nvidia.open = false;"),e(" 改成 "),s("code",null,"true"),e(" 以后又好了。正当我高兴，一天后的 rebuild 又让我吸了口凉气，问题并没有解决。")],-1)),i[36]||(i[36]=s("p",null,"这个问题一放就是两个月，总结了一点规律：",-1)),i[37]||(i[37]=s("ul",null,[s("li",null,"X11 的锅，卡 dmesg 是 X11 起不来的表现"),s("li",null,"从 windows 重启到 nixos 时卡住的概率更高"),s("li",null,"如果不进 windows，只使用 nixos，则基本不会遇到此问题")],-1)),i[38]||(i[38]=s("p",null,"反正现在我摆烂了，看到卡 dmesg 就 sysrq 重启。",-1))]),tab2:n(({value:t,isActive:r})=>[i[42]||(i[42]=s("p",null,"自从我装台式后就没有再用过 NixOS，因为 1. 之前的安装给我带来了很大的心理阴影 2. NixOS 安装需要多次 bootstrap，即使有声明式配置也一点都不简单 3. 大四下我正在享受最后的青春，天天在 windows galgame，确实没有装 NixOS 的动力。因此就这样过了半年。",-1)),i[43]||(i[43]=s("p",null,"202507 由于我买了家庭服务器，想装成 nixos 用，于是就重新先在我的主力机上回坑 nixos，调完配置再搞。那台服务器暂时先装了个 windows 调完 Ryzen Master 参数先跑着（）",-1)),i[44]||(i[44]=s("p",null,"我先是用我原先的同款配置，果然 nixos-install 时整天报网络 error；不过好在有了经验，知道国内几个镜像源要轮换着用，加之我的回坑大概过了半年不算太久，intel 显卡也不需要什么配置，于是就还算顺利地在主力机上装好了。",-1)),s("p",null,[i[40]||(i[40]=e("但是这是我第一次考虑使用一份配置安装多个 NixOS 主机，原先的屎山配置肯定是要拆的。然后我一咬牙，就花了几天时间把我的 ")),a(l,{to:"/gossip/va_view.html#tag-%E8%AE%BA"},{default:n(()=>i[39]||(i[39]=[e("tag 论")])),_:1}),i[41]||(i[41]=e("设想在我的配置里实现了。拆配置是痛苦的，拆完的成就感是满的；我甚至天天在公司摸鱼读文档拆配置，晚上带回家 rebuild 解决报错，小日子过得还不错。"))]),i[45]||(i[45]=s("p",null,"然后 20250726 把新配置写得差不多了，就在服务器上装好了 NixOS。期间也是切到主力机上改配置改了很多次，因为发现了各种各样的问题，包括 iso 也重做了很多次，笑死。总之没有遇到太多问题。",-1))]),tab3:n(({value:t,isActive:r})=>i[46]||(i[46]=[s("p",null,"由于许多配置都在 NixOS，而上班必须用 WSL（问就是某个公司软件不提供 Linux 版，而项目要用 Linux 跑），之前用 ArchWSL 不够爽，因此试着用一下 NixOS-WSL。（刚好摸摸鱼）",-1),s("p",null,"经过了配置 feature 化改造，现在想要筛选出不需要在我的这个设备上的配置非常简单。",-1)])),_:1}),i[68]||(i[68]=o(`<h2 id="学习" tabindex="-1"><a class="header-anchor" href="#学习"><span>学习</span></a></h2><p>如何学习 nix 呢？nix 没有强大的 wiki，遇到问题只能到处 google。但是也有一些好的资源。</p><ul><li><a href="https://nixos-cn.org/tutorials/installation/Subsystem.html" target="_blank" rel="noopener noreferrer">NixOS 中文</a>：安装教程与初步使用</li><li><a href="https://nixos-and-flakes.thiscute.world/zh/preface" target="_blank" rel="noopener noreferrer">NixOS 与 Flakes - thiscute</a>：进阶好书</li><li><a href="https://lantian.pub/article/modify-website/nixos-why.lantian/" target="_blank" rel="noopener noreferrer">Lan Tian @ Blog</a>：打包与高级用法</li><li><a href="https://discourse.nixos.org/c/learn/chinese/55" target="_blank" rel="noopener noreferrer">中文 discourse</a> &amp; <a href="https://t.me/nixos_zhcn" target="_blank" rel="noopener noreferrer">telegram group</a>：可能可以来问问题</li><li><a href="https://github.com/nix-community/awesome-nix" target="_blank" rel="noopener noreferrer">awesome-nix</a>：里面也有 for tutorials / developers 的链接。</li></ul><p>一个要点是理清 nix 的 一些事实标准，例如 flake， home manager，他们是什么，有什么用。好在那本 thiscute 的书完美解决了此问题。</p><p>还有一个学习方法是多看别人的 configuration，<s>并且大量摘抄</s>。我的配置在<a href="#%E9%85%8D%E7%BD%AE">下面</a>，还有一些：<a href="https://github.com/ryan4yin/nix-config" target="_blank" rel="noopener noreferrer">ryan4yin&#39;s config</a> <a href="https://git.ny4.dev/nyancat/flake/src/branch/master" target="_blank" rel="noopener noreferrer">nyancat</a> <a href="https://github.com/wimpysworld/nix-config" target="_blank" rel="noopener noreferrer">wimpysworld</a> <a href="https://github.com/jackdbd/nix-config" target="_blank" rel="noopener noreferrer">jackdbd</a> <a href="https://github.com/nmasur/dotfiles" target="_blank" rel="noopener noreferrer">nmasur</a> <a href="https://github.com/oo-infty/nixos-configurations" target="_blank" rel="noopener noreferrer">oo-infty</a></p><h3 id="基础" tabindex="-1"><a class="header-anchor" href="#基础"><span>基础</span></a></h3><p>2025 年 AI 已经非常强大，语法问题完全可以开 online search 问 AI。</p><ul><li>先阅读 <a href="https://nixos-cn.org/tutorials/lang/QuickOverview.html" target="_blank" rel="noopener noreferrer">NixOS 中文 - Nix 语言快速入门</a>。</li><li>条件判断：一般接触多的是 <code>if..then..else</code> 和 <code>lib.mkIf</code>。 <ul><li>两个 if 里条件只能是 bool，不能是其它类型。</li><li><code>lib.mkIf</code> 和 <code>if..then..else null;</code> 是不一样的！<code>lib.mkIf</code> 求值时会被转换成类似 <code>{ _type = &quot;if&quot;; condition = ...; content = ...; }</code> 的形式，方便求值时验证和 lazy。</li></ul></li><li><code>inherit x y;</code> = <code>x=x;y=y;</code></li><li>function 的 <code>@</code> 绑定：<code>bargs@{a, b, ...}:</code> is equivalent to <code>{a, b, ...}@bargs:</code></li><li><code>//</code> 用于两个 attrset 的合并，<strong>右边覆盖左边</strong>。</li><li>最常用的一些判断条件：<code>mkDefault</code> 和 <code>mkForce</code> 修改合并优先级，<code>mkBefore</code> <code>mkAfter</code> 修改 list 合并顺序，<code>mkIf</code> 条件控制某些属性的有和无，<code>optional</code> 根据条件返回 null 或 <code>[x]</code>，而 <code>optionals</code> 返回 null 或 x。</li><li>数据类型： <ul><li>数组：list。判断元素是否存在：<code>builtins.elem elem list</code>。</li></ul></li></ul><h3 id="常用命令" tabindex="-1"><a class="header-anchor" href="#常用命令"><span>常用命令</span></a></h3><div class="language-sh line-numbers-mode" data-highlighter="shiki" data-ext="sh" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">nix-prefetch-url</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> &lt;</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">ur</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">l&gt;                  </span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># fetch 并输出 sha256。在打包时经常用到。</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">nix-collect-garbage</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -d</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">                  # 删除所有配置的所有旧版本，并 GC。（彻底清理）</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">nix</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> flake</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> update</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> &lt;</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">inpu</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">t&gt;                </span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># update flake 想必大家天天用，但是 update 一个特定 input 应该用得很少吧</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="工具" tabindex="-1"><a class="header-anchor" href="#工具"><span>工具</span></a></h2><ul><li><a href="https://github.com/nix-community/nix-index" target="_blank" rel="noopener noreferrer">nix-index</a>：找包位置。<strong>实际上并不好用</strong>，因为 <ol><li>需要查找的时候经常是刚安装完软件的时候，还没有 updatedb。而 nixos 的手动 updatedb 耗时极长。</li><li>默认 locate 时也会搜索路径，nix 路径又基于 hash，因此会有很多 hash 污染搜索结果。</li></ol><ul><li>感觉真不如 <code>cd /nix/store &amp;&amp; fd xxx</code>。</li></ul></li><li><a href="https://github.com/utdemir/nix-tree" target="_blank" rel="noopener noreferrer">nix-tree</a>：交互式的依赖寻找，非常好用。打开以后按 <code>/</code> 查找。</li></ul><h3 id="搜索" tabindex="-1"><a class="header-anchor" href="#搜索"><span>搜索</span></a></h3><p>安装与配置中很重要的一环是学会搜索。即使 nixos 的文档比较内个，也有一些非常好用的网站用来查询所需信息。</p><ul><li><a href="https://search.nixos.org/packages" target="_blank" rel="noopener noreferrer">https://search.nixos.org/packages</a>：查找包。 <ul><li>主要也就看 Homepage 和 Source，分别对应项目 README 和 打包 nix 源码</li></ul></li><li><a href="https://search.nixos.org/options" target="_blank" rel="noopener noreferrer">https://search.nixos.org/options</a>：查找设置项</li><li><a href="https://home-manager-options.extranix.com/" target="_blank" rel="noopener noreferrer">https://home-manager-options.extranix.com/</a>：查找 home-manager 中的设置项</li><li><s><a href="https://noogle.dev/" target="_blank" rel="noopener noreferrer">https://noogle.dev/</a>：nix 语言学习查找</s>（其实很多定义都缺了，很捞）</li><li><a href="https://nur.nix-community.org/" target="_blank" rel="noopener noreferrer">https://nur.nix-community.org/</a>：NUR 包</li><li><a href="https://luoxu.torus.icu/" target="_blank" rel="noopener noreferrer">Nix 落絮</a></li></ul><h3 id="其他" tabindex="-1"><a class="header-anchor" href="#其他"><span>其他</span></a></h3><ul><li><a href="https://xtonix.tei.su/" target="_blank" rel="noopener noreferrer">x to nix</a>：将 json，xml，yaml 配置转为 nix 配置。（但是没啥必要，因为可以通过 <code>lib.importJSON</code> 或者其他相关函数自动转。已经有 json 就真没必要硬塞到 nix 里吧。）</li></ul><h2 id="配置" tabindex="-1"><a class="header-anchor" href="#配置"><span>配置</span></a></h2><p><a href="https://github.com/lxl66566/nixos-config" target="_blank" rel="noopener noreferrer">我的配置仓库</a></p>`,19)),s("p",null,[i[48]||(i[48]=e("202507 第二次入坑 NixOS 时，我将整个配置重新拆成类似 Rust feature gate 的形式，符合我的 ")),a(l,{to:"/gossip/va_view.html#tag-%E8%AE%BA"},{default:n(()=>i[47]||(i[47]=[e("tag 论")])),_:1}),i[49]||(i[49]=e("。这样我就可以在各种系统上方便地组合 feature，以定制最符合我的需求的配置。"))]),i[69]||(i[69]=o('<h3 id="linter-formatter" tabindex="-1"><a class="header-anchor" href="#linter-formatter"><span>linter / formatter</span></a></h3><p>nix 是一门图灵完备的函数式语言，写 nixos config 就是编程的过程。说到编程那肯定少不了 linter 和 formatter。而我是 all in vscode 人，我使用的插件如下：</p><ul><li><em>Nix IDE - Noortheen</em>：lsp，需要手动安装 <code>pkgs.nil</code></li><li><em>nixfmt - brettm12345</em>：formatter，需要手动安装 <code>pkgs.nixfmt-rfc-style</code></li></ul><h3 id="显卡驱动" tabindex="-1"><a class="header-anchor" href="#显卡驱动"><span>显卡驱动</span></a></h3>',4)),a(h,{id:"381",data:[{id:"NVIDIA"}]},{title0:n(({value:t,isActive:r})=>i[50]||(i[50]=[e("NVIDIA")])),tab0:n(({value:t,isActive:r})=>i[51]||(i[51]=[s("p",null,[e("官方给出了比较详细的 NixOS 显卡驱动教程("),s("a",{href:"https://nixos.wiki/wiki/Nvidia",target:"_blank",rel:"noopener noreferrer"},"NixOS Manual - Nvidia"),e(")，看就完了。我认为还存在一些缺点：")],-1),s("ol",null,[s("li",null,"有些复杂，例如双显卡需要手动查总线并写入 hardware-configuration."),s("li",null,"prime 功能有点残缺，官方给出的 example 里只有在启动时选择不同的启动项以应对外带和接电源两种情况，而不能动态调整性能模式：正常情况下应该是在游戏启动时启用显卡而在未游戏时关闭。")],-1),s("p",null,[e("还有我自己"),s("a",{href:"#%E5%90%8E%E8%AE%B0"},"折腾"),e("后想说的注意事项：使用 "),s("code",null,"hardware.nvidia.open = true;"),e("，使用官方内核。")],-1)])),_:1}),i[70]||(i[70]=o(`<h3 id="拼音输入法" tabindex="-1"><a class="header-anchor" href="#拼音输入法"><span>拼音输入法</span></a></h3><p>用英文有点习惯，要不是我打开博客想写论文我都想不到中文输入法没装。</p><p>我先尝试 arch 上用习惯的 fcitx5：</p><div class="language-nix line-numbers-mode" data-highlighter="shiki" data-ext="nix" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;">i18n</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;">defaultLocale</span><span style="--shiki-light:white;--shiki-dark:#FFFFFF;"> =</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;zh_CN.UTF-8&quot;</span><span style="--shiki-light:white;--shiki-dark:#FFFFFF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;">i18n</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;">inputMethod</span><span style="--shiki-light:white;--shiki-dark:#FFFFFF;"> =</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">  enabled</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> = </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;fcitx5&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">  fcitx5</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">addons</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> = </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">with</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;"> pkgs</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">; [</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;">    fcitx5-chinese-addons</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;">    fcitx5-mozc</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;">    fcitx5-gtk</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;">    fcitx5-rime</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;">    fcitx5-configtool</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">  ];</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span><span style="--shiki-light:white;--shiki-dark:#FFFFFF;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>然而这并不能使用，在输入法里切到了中文键盘，打出的一直都是英文。</p><p>然后我尝试用了一下 ibus：</p><div class="language-nix line-numbers-mode" data-highlighter="shiki" data-ext="nix" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;">i18n</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;">defaultLocale</span><span style="--shiki-light:white;--shiki-dark:#FFFFFF;"> =</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;zh_CN.UTF-8&quot;</span><span style="--shiki-light:white;--shiki-dark:#FFFFFF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;">i18n</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;">inputMethod</span><span style="--shiki-light:white;--shiki-dark:#FFFFFF;"> =</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">  enabled</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> = </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;ibus&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">  ibus</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">engines</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> = </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">with</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;"> pkgs</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;">ibus-engines</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">; [</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;">    rime</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;">    libpinyin</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">  ];</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span><span style="--shiki-light:white;--shiki-dark:#FFFFFF;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>用倒是能用了，但是我并不清楚 ibus 如何支持双拼。而且其自定义程度也不太行，切换输入法居然不能 <code>Ctrl + Shift</code> 而需要给实际键位，因此我还是折腾 fcitx。</p><p>跑了一次 <code>fcitx5-diagnose</code>，发现 locale 里显示的不太对，怎么全都是 <code>en_US.UTF-8</code>？明明已经设了 <code>i18n.defaultLocale</code>...后续设成这样：</p><div class="language-nix line-numbers-mode" data-highlighter="shiki" data-ext="nix" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;">defaultLocale</span><span style="--shiki-light:white;--shiki-dark:#FFFFFF;"> =</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;zh_CN.UTF-8&quot;</span><span style="--shiki-light:white;--shiki-dark:#FFFFFF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;">extraLocaleSettings</span><span style="--shiki-light:white;--shiki-dark:#FFFFFF;"> =</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">  LANG</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> = </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;zh_CN.UTF-8&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">  LC_ALL</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> = </span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;">defaultLocale</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span><span style="--shiki-light:white;--shiki-dark:#FFFFFF;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>莫名奇妙就好了，在输入法设置里可以找到双拼键盘，开起来就行。</p><p>ps. 根据<a href="https://t.me/nixos_zhcn/477206" target="_blank" rel="noopener noreferrer">群友描述</a>，只需要将 KDE 配置文件删除即可，与 defaultLocale 无关。</p><p>然后被 rime 党吹的有点心动，想试试 rime。刚好 ryan4yin 佬<a href="https://github.com/ryan4yin/nix-config/tree/main/overlays" target="_blank" rel="noopener noreferrer">就是 rime + 小鹤</a>，于是我便直接开抄配置。可能是 overlays 哪出了问题，rebuild 的时候并没有把数据移到 rimedata，我也百思不得其解。后来手动移过去试了一下，发现真难用啊（包括快捷键啥都不懂）。于是滚回了 fcitx5-chinese-addon。</p><p><code>fcitx5-configtool</code> 里双拼键盘下的“管理自定义词组”是坏的，点不开。我也懒得修了，把以前 archlinux 位于 <code>~/.local/share/fcitx5/pinyin/customphrase</code> 的词库搬出来，拿到 home-manager 里 source 一下就好了（需要 <a href="https://wiki.archlinux.org/title/Fcitx5#Emoji_show_abnormally_in_the_candidate_box" target="_blank" rel="noopener noreferrer">重启 fcitx5</a>：在 bash 里跑 <code>kill \`ps -A | grep fcitx5 | awk &#39;{print $1}&#39;\` &amp;&amp; fcitx5&amp;</code>），也符合 nixos 的原则。</p>`,14)),s("p",null,[i[53]||(i[53]=e("后来我不再使用任何 overlays，并且完全 fork 了自己的配置，才正式入坑了 Rime。")),a(l,{to:"/articles/input_method.html#rime"},{default:n(()=>i[52]||(i[52]=[e("相关文章")])),_:1})]),i[71]||(i[71]=s("h3",{id:"代理",tabindex:"-1"},[s("a",{class:"header-anchor",href:"#代理"},[s("span",null,"代理")])],-1)),s("p",null,[i[56]||(i[56]=e("我最开始使用 ")),a(l,{to:"/articles/proxy/proxy_software.html#v2raya"},{default:n(()=>i[54]||(i[54]=[e("v2rayA")])),_:1}),i[57]||(i[57]=e(" 过渡，然后就跑到 ")),a(l,{to:"/articles/proxy/proxy_software.html#dae"},{default:n(()=>i[55]||(i[55]=[e("dae")])),_:1}),i[58]||(i[58]=e(" 了。"))]),i[72]||(i[72]=o('<h3 id="备份" tabindex="-1"><a class="header-anchor" href="#备份"><span>备份</span></a></h3><p>nix 的配置显然用 git 备份的话非常舒适。起初我以为 <code>/etc/nixos</code> 不能放 <code>.git</code> 仓库。后来发现是不允许放未提交（dirty）的仓库。再后来我知道有配置可以强制 nixos 使用 dirty 仓库：</p><div class="language-nix line-numbers-mode" data-highlighter="shiki" data-ext="nix" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;">nix</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;">settings</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;">warn-dirty</span><span style="--shiki-light:white;--shiki-dark:#FFFFFF;"> =</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> false</span><span style="--shiki-light:white;--shiki-dark:#FFFFFF;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>这下终于可以不用 copy 到其他地方备份了。但是有一点需要注意：在 rebuild 前一定记得把新增的文件 <code>git add</code> 到暂存区！！否则会报 <em>No such file or directory</em>。</p><p>至于备份加密，由于我的隐私文件并不算非常隐私，所以用的是我自己写的 <a href="https://github.com/lxl66566/git-simple-encrypt" target="_blank" rel="noopener noreferrer">git-simple-encrypt</a>，仅需一个密码即可解锁。如果你有更高的安全需求可以看看 sops-nix 或 agenix。</p><h3 id="home-manager" tabindex="-1"><a class="header-anchor" href="#home-manager"><span>home manager</span></a></h3><p>我本来是不想用 home manager 的，全写在 <code>configuration.nix</code> 里也不麻烦。但是后来还是用了：</p><ol><li>假设滚挂了，方便 reinstall（把 import 注释掉即可；否则一个 <code>configuration.nix</code> 不好拆，我也不想一个 install 下载几十 GB）</li><li>有些配置文件确实不方便统一管，例如 KDE 的某些设置等。</li></ol><p>从 <code>configuration.nix</code> 转移到 home manager 也不麻烦，<a href="#%E5%AD%A6%E4%B9%A0">thiscute</a> 有很好的教程，并且它们的条目基本是兼容的。</p><p>但是进一步定制各种配置文件就没那么简单了，因为 <a href="https://nix-community.github.io/home-manager/index.xhtml" target="_blank" rel="noopener noreferrer">home-manager 的 manual</a> 就是一坨屎！建议直接用<a href="#%E6%90%9C%E7%B4%A2">第三方的 options 搜索</a>。</p><h3 id="plasma-manager" tabindex="-1"><a class="header-anchor" href="#plasma-manager"><span><a href="https://github.com/nix-community/plasma-manager" target="_blank" rel="noopener noreferrer">plasma manager</a></span></a></h3><p>在 nixos 下，很多 kde plasma6 的设置都不能在 conf 或 home manager 中定义。例如我尝试在 <code>home.nix</code> 中使用 <code>services.random-background</code> 更换壁纸，结果开机会显示 0.5s 壁纸然后被换回 kde 默认壁纸；还有包括<a href="https://discourse.nixos.org/t/stop-screen-locking-in-plasma/15303/3" target="_blank" rel="noopener noreferrer">锁屏时间设置</a>的问题等等等等。</p><p>顾名思义，plasma manager 就是为了应对此情况出现的。它能保存的 kde 配置不算多，毕竟 kde 世界配置文件无穷无尽。但在一定程度上还是有用的。</p><h3 id="gaming" tabindex="-1"><a class="header-anchor" href="#gaming"><span>Gaming</span></a></h3><ul><li><a href="https://www.reddit.com/r/NixOS/comments/1c7csct/gaming_on_nixos/" target="_blank" rel="noopener noreferrer">Gaming on nixos : r/NixOS</a></li><li><a href="https://github.com/fufexan/nix-gaming" target="_blank" rel="noopener noreferrer">github:fufexan/nix-gaming</a>：主要是 OSU 相关</li></ul><p>Linux 上游戏还是不太行。。。cs2 fps windows 140+，在 nix 上只有 50 左右。不过据群友说，在 vulkan 着色器编译完成后游戏可以大幅提高帧率。我暂时还未尝试。</p><p>不过平常玩点轻量级游戏问题不大，galgame，启动！你的下一台电脑又何必是游戏本！扯远了。</p><p>steam 游戏都能够点击即玩，proton 还是牛逼的。一些傻逼引擎的 galgame 无法在 wine 下正常运行，此时就需要安装<a href="#%E8%99%9A%E6%8B%9F%E6%9C%BA">虚拟机</a>了。</p>',18)),s("p",null,[i[60]||(i[60]=e("nix gaming 还有过不去的一关就是性能释放。。我这台电脑")),a(l,{to:"/articles/linux/problem.html#nixos-%E8%B0%83%E6%95%B4%E9%A3%8E%E6%89%87%E8%BD%AC%E9%80%9F"},{default:n(()=>i[59]||(i[59]=[e("风扇总是不转，无法调整风扇转速")])),_:1}),i[61]||(i[61]=e("，有点悲惨。风扇不转想打啥游戏都不行吧，立刻降频了。大量求助后仍然未果，所以立刻开寄。"))]),i[73]||(i[73]=o(`<h3 id="虚拟机" tabindex="-1"><a class="header-anchor" href="#虚拟机"><span>虚拟机</span></a></h3><p>参考我的配置中的 <a href="https://github.com/lxl66566/nixos-config/blob/main/others/vm.nix" target="_blank" rel="noopener noreferrer"><code>others/vm.nix</code></a> 安装 qemu kvm 及其运行库。</p><p>至于镜像我在 win10 和 win11，ltsc 和 tiny 里纠结了一下，选择了 tiny 11 23H3。可以看看<a href="https://www.iplaysoft.com/tiny11.html" target="_blank" rel="noopener noreferrer">教程</a>，里面还有中文字体包，反正我来者不拒。下载从 web archive 或教程给的地址任选，反正我用了前者。</p><p>安装后，打开 <code>Virtual Machine Manager</code>，创建新虚拟机，选择下载的 iso 镜像。需要注意，如果 auto detect os 检测不到，需要在下面取消勾选 auto detect os 后自行输入 win11。反正这个 UI 逻辑是挺傻逼的。至于传文件，打开 USB 直通，我的移动硬盘可以分别在两端挂载，这样也不需要考虑太多。</p><p>感想：</p><ul><li>tiny 11 感觉也不 tiny。。。安装完占了我 17G 空间，感觉还是得 win10 吧。</li><li>libvirt 也不好用，剪贴板和文件都没有傻瓜式解决方案。</li></ul><h3 id="快照" tabindex="-1"><a class="header-anchor" href="#快照"><span>快照</span></a></h3><details class="hint-container details"><summary>archived</summary><p>NixOS 官方的图形界面安装镜像并没有提供 btrfs 的选项，合理猜测大部分人安装都是用的 ext4 分区，因此 btrfs 的资料应该不多。况且 NixOS 本身就是一个强可复现系统，按理来说并不需要快照作为保护系统的手段。然而可复现是一回事，可复现的难易度又是一回事。<code>nixos-enter</code> 的缺陷、 minimal 镜像的折磨、外加 NVIDIA 驱动频繁崩溃，促使我用快照保护系统的安全。</p><p>在 nixos 上倒没有频繁打快照的必要，因为只要我有一个正常的快照，恢复后就可以从最新的配置文件 rebuild 回去（快照在这里起到的作用可能是 nixos-enter 的补充，使我能够使用盘里的缓存进行 rebuild），因此我选择不使用自动快照软件例如 snapper，而是手打。</p><p>nix 的根目录下都是符号链接，理论上有价值的快照理应是 nix 子卷快照而不是 root 快照。当然都打也可以。</p><div class="language-sh line-numbers-mode" data-highlighter="shiki" data-ext="sh" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">sudo</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> mkdir</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> /nix/.snapshot</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">sudo</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> btrfs</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> subvolume</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> snapshot</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> /nix</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> /nix/.snapshot/nix_20240629</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>但是我还没有尝试过快照的恢复，等用到再更新吧。</p></details><p>理论上确实没必要为 <code>/nix</code> 打快照；我现在的解法是放一个 <code>minimal.nix</code> 作为崩溃的恢复，由于软件不多，重装也能快速装好。</p><h3 id="root-on-tmpfs" tabindex="-1"><a class="header-anchor" href="#root-on-tmpfs"><span>root on tmpfs</span></a></h3><p>由于大部分内容都是软链接，nixos 上能玩一个很骚的操作：把 root 挂载成 tmpfs。好处是每次重启所有东西都会被清，可以随便运行一些喜欢到处拉屎的软件。</p><p>这里面最重要的东西是 impermanence，它就是一个 “mount mount 小工具”，可以将指定文件/文件夹 mount 到指定位置，这样它的修改也会同步到 source，并且比起 softlink 还可以跨子卷/分区。我看的教程是<a href="https://lantian.pub/article/modify-computer/nixos-impermanence.lantian/" target="_blank" rel="noopener noreferrer">Lan Tian @ Blog NixOS 系列（四）：“无状态”操作系统</a>，结果还是踩了亿点坑。</p><ol><li>犯了<a href="https://nixos.wiki/wiki/Impermanence" target="_blank" rel="noopener noreferrer">官方文档中置顶标红</a>的大忌：<strong>没有设 user 密码</strong>。（之前的 defaultPassword 删掉了）于是进不去系统。快照打的是 <code>/nix</code>，但是密码在 <code>/etc/shadow</code> 并不归 <code>/nix</code> 管；也没法直接改挂载选项把原先的 <code>/</code> 挂上，因为 <code>nixos-enter</code> 进去<a href="#nixos-%E5%AE%89%E8%A3%85">无法 rebuild</a>，<code>--bootloader</code> 也是 <code>nixos-rebuild</code> 的，<code>nixos-install</code> 并没有。 <ul><li>最后还是改挂载选项重新 <code>nixos-install</code> 了，得益于使用 home-manager 把我的一大堆个人软件分开，本次 install 并没有花费太多时间。install 完至少能先进系统，再修配置，重启就结束了。</li></ul></li><li>然后发现我的 <code>/etc/nixos</code> 配置本身没有被 impermanence。。。遂从原先的 <code>/</code> 里拷贝之，加入 impermanence，rebuild 即可。</li><li>不要把 <code>/etc/shadow</code> 或 <code>/etc/passwd</code> 加入持久化。我加入以后开不了机，无法登录。</li></ol><p>教程中把 <code>/var</code> 加入 impermanence，而我更喜欢用 btrfs 子卷管理。由于直接在 <code>/var</code> 创建子卷，子卷的 parent 会指向 <code>/</code>，所以我进了一次 live cd 创建子卷，保持 <code>var</code> 子卷与 <code>root</code>、<code>home</code> 等同级，然后把东西移过去，重启后写 <code>hardware-configuration.nix</code> 然后 rebuild 就行。</p><p>impermanence 在 NixOS 安装过程中是一个硬性的 bootstrap 来源；你必须成功安装 NixOS 后，才能获取原始的文件，进行持久化。然后教程里你需要手动将对应文件复制到 <code>/nix/impermanence</code> 下，这一步在 bootstraping 时也太麻烦了点，我思考以后想出一个好办法：在开启 root on tmpfs 时，将老的 <code>/</code> (root) 子卷挂到随便一个什么 <code>/fakeroot</code> 上；然后就可以用 impermanence 从 <code>/fakeroot</code> 里 mount 文件了，这样省去了手动 copy 文件的这一步骤，在我的配置中只需要修改一个 bool 值就可以自动切 root on tmpfs，将工作量降到了最低，非常舒服。</p><h3 id="iso-制作" tabindex="-1"><a class="header-anchor" href="#iso-制作"><span>ISO 制作</span></a></h3><p>官方的 ISO（不论 minimal 或图形界面的）都是一坨狗屎，图形界面安装没有 btrfs 而且 rebuild 会 fail，minimal 则是缺少工具（efibootmgr）并且无法匹配我的个人设置（手动挂一大堆 btrfs 子卷实在是有点折磨），所以还是自己做 iso 比较好。我自己做的 iso 有这些需求：</p><ol><li>代理支持。如果正常安装 NixOS 的 flake，是没有办法在没有代理的环境成功安装的，如果 iso 没有代理的话就要用 minimal 配置进行一次 bootstrap。有代理的话就可以一次性解决了。</li><li>btrfs 相关脚本。我在所有机器上使用同一份 btrfs 配置，但是手动 mount 一大堆子卷实在是太麻烦，因此需要内置一些脚本帮我快速创建并 mount 子卷，这样也方便滚挂了以后进 livecd 修。 <ul><li>使用 disko 一键分区是方便，但是如果你要在一块盘上装双系统不就挂比了吗？</li></ul></li><li>其他实用工具，例如 fish shell 等。</li></ol><p>制作 iso 可以用下面的方法将本机文件拷贝到镜像系统里：</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span>isoImage.contents = [</span></span>
<span class="line"><span>    {</span></span>
<span class="line"><span>      source = ./config/absx.dae;</span></span>
<span class="line"><span>      target = &quot;/config.dae&quot;;</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span>];</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>但是这里有个坑，就是拷贝到的 <code>/</code> 位置在镜像里其实是独立的 <code>/iso</code> 文件夹，导致了我的 dae service fail。后来将 <code>dae.configFile = &quot;/iso/config.dae&quot;;</code> 设置后代理才能正常启动。</p><p>还有关于 btrfs 脚本，我最开始时是直接写在 fishshell 的 interactiveShellInit 里；但是后来发现脚本写锅了需要修改时，整个 iso 里没有地方可以找到这个脚本内容并修改，这是 fishshell 的问题。没办法，我只好写好 bash 脚本并 source 到 /iso 下的指定位置；后来我直接使用 <code>pkgs.writeShellApplication</code> 做成 derivation 了，方便调用，脚本内容也可以在 iso 里 fd 出来修改。</p><p>最后我还在构建 iso 时，将整个本机的 nixos 文件夹 source 到了镜像内，方便在 dae 挂了没法 git clone 的时候也可以拿到我的配置（虽然可能过时）进行安装。这里也有 source 时需要排除 .git 文件夹和其他文件夹的问题，免得增加 iso 镜像大小。</p><p>做完了这些，现在我的 iso 就得心应手了。iso 定义可以<a href="https://github.com/lxl66566/nixos-config/blob/main/iso.nix" target="_blank" rel="noopener noreferrer">在配置里找到</a>。</p><h3 id="开发环境" tabindex="-1"><a class="header-anchor" href="#开发环境"><span>开发环境</span></a></h3><p>我一直使用 vscode，但是在 nixos 上，还是有点难用的。</p><ul><li>vscode 全自动同步过程中，有部分插件没有同步过来。</li><li>手动在 <code>home.nix</code> 里添加插件后，所有禁用的插件会被自动启用。</li><li>某些插件在非 feh 环境下无法运行；feh 环境下无法在终端使用 sudo。</li><li>无法使用 ssh 插件远程开发。</li></ul><h2 id="问题解决" tabindex="-1"><a class="header-anchor" href="#问题解决"><span>问题解决</span></a></h2><h3 id="太大了" tabindex="-1"><a class="header-anchor" href="#太大了"><span>太大了</span></a></h3><p>我要在 VPS 上安装我的 flake。但是太大了，VPS 被塞爆了，并且我在 copy path 时观察到一些例如 llvm，rustc 等我根本没有手动安装的软件，于是需要查哪些傻卵打包者引入了这些依赖。但是问题是我需要在不实际安装的情况下进行查询。</p><p>求助群友后，<a href="https://t.me/wElmForest" target="_blank" rel="noopener noreferrer">@wElmForest</a> 给出了一个解法：</p><div class="language-sh line-numbers-mode" data-highlighter="shiki" data-ext="sh" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">nix</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> why-depends</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> .#nixosConfigurations.</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">hostnam</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">e&gt;</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">.config.system.build.toplevel</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> nixpkgs#</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">依</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">赖&gt;</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># or</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">nix-tree</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> .#nixosConfigurations.</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">hostnam</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">e&gt;</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">.config.system.build.toplevel</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>实测是需要先使用 <code>nix why-depends</code> 进行 build 后，再用 <code>nix-tree</code> 进行查询，否则会爆 <code>nix-tree: user error (Invalid path: ... Make sure that it is built, or pass &#39;--derivation&#39; if you want to work on the derivation.)</code>。不过抛开这个 bug 不谈，nix-tree 还是好用的。</p><p>找到了一个占用 3G 多的罪魁祸首 prettybat，直接把它干掉了。</p><h2 id="劝退" tabindex="-1"><a class="header-anchor" href="#劝退"><span>劝退</span></a></h2><p>最后来说说劝退。NixOS 自身的问题还是不小的：</p>`,36)),s("ul",null,[i[63]||(i[63]=s("li",null,[e("文档稀烂，缺乏条目 "),s("ul",null,[s("li",null,"google 比文档多，学习靠社区解答")])],-1)),i[64]||(i[64]=s("li",null,"社区不合，drama 不断",-1)),i[65]||(i[65]=s("li",null,"报错模糊",-1)),s("li",null,[a(l,{to:"/coding/package_manager.html#nix"},{default:n(()=>i[62]||(i[62]=[e("包管理达不到预期")])),_:1})]),i[66]||(i[66]=s("li",null,[e("nix 开发，mkshell 实在是太烂了。 "),s("ul",null,[s("li",null,"居然做不到 alias！")])],-1))]),i[74]||(i[74]=o('<p>我在使用过程中也有一些想吐槽的（其实上面就有很多）：</p><ul><li>图形化安装界面垃圾</li><li>minimal 镜像缺功能</li><li>home manager 捞</li></ul><p>我的资历尚浅，只能够发出如此感叹。如果你希望看到更多对 nixos 的评价，可以看看 <a href="#external">external 2.</a>。</p><h2 id="external" tabindex="-1"><a class="header-anchor" href="#external"><span>external</span></a></h2><ol><li><a href="https://ayats.org/blog/no-flake-utils/" target="_blank" rel="noopener noreferrer">Why you don&#39;t need flake-utils</a></li><li><a href="https://thiscute.world/posts/my-experience-of-nixos/" target="_blank" rel="noopener noreferrer">OS as Code - 我的 NixOS 使用体会 - thiscute</a></li></ol>',5))])}const x=d(u,[["render",c],["__file","nix.html.vue"]]),b=JSON.parse('{"path":"/articles/linux/nix.html","title":"安装与配置（NixOS 篇）","lang":"zh-CN","frontmatter":{"date":"2024-06-28T00:00:00.000Z","icon":"regular fa-snowflake","category":["教程"],"tag":["Linux","桌面端"],"description":"安装与配置（NixOS 篇） 前言 早在去年我便说过我的下一个操作系统很有可能是 NixOS。202405 的 OS 课需要做 PPT 汇报，我的选题是包管理器杂谈，又吹了一波 nix，把我自己心吹得痒痒的。 在考试期间由于压抑的氛围和不情愿的学习，平常想做的事的欲望会被放大许多。但是我预料到 NixOS 的安装肯定会非常折磨（好预测！），所以只在 W...","head":[["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"安装与配置（NixOS 篇）\\",\\"image\\":[\\"\\"],\\"datePublished\\":\\"2024-06-28T00:00:00.000Z\\",\\"dateModified\\":\\"2025-08-22T12:37:19.000Z\\",\\"author\\":[]}"],["meta",{"property":"og:url","content":"https://absx.pages.dev/articles/linux/nix.html"}],["meta",{"property":"og:site_name","content":"绝对值_x 的博客"}],["meta",{"property":"og:title","content":"安装与配置（NixOS 篇）"}],["meta",{"property":"og:description","content":"安装与配置（NixOS 篇） 前言 早在去年我便说过我的下一个操作系统很有可能是 NixOS。202405 的 OS 课需要做 PPT 汇报，我的选题是包管理器杂谈，又吹了一波 nix，把我自己心吹得痒痒的。 在考试期间由于压抑的氛围和不情愿的学习，平常想做的事的欲望会被放大许多。但是我预料到 NixOS 的安装肯定会非常折磨（好预测！），所以只在 W..."}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:locale","content":"zh-CN"}],["meta",{"property":"og:updated_time","content":"2025-08-22T12:37:19.000Z"}],["meta",{"property":"article:tag","content":"桌面端"}],["meta",{"property":"article:tag","content":"Linux"}],["meta",{"property":"article:published_time","content":"2024-06-28T00:00:00.000Z"}],["meta",{"property":"article:modified_time","content":"2025-08-22T12:37:19.000Z"}]]},"git":{"createdTime":1719567019000,"updatedTime":1755866239000,"contributors":[{"name":"lxl66566","username":"lxl66566","email":"lxl66566@gmail.com","commits":34,"url":"https://github.com/lxl66566"}]},"readingTime":{"minutes":23.23,"words":6968},"filePathRelative":"articles/linux/nix.md","localizedDate":"2024年6月28日","excerpt":"\\n","autoDesc":true}');export{x as comp,b as data};
