<!doctype html>
<html lang="zh-CN" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-rc.20" />
    <meta name="theme" content="VuePress Theme Hope 2.0.0-rc.79" />
    <style>
      :root {
        --vp-c-bg: #fff;
      }

      [data-theme="dark"] {
        --vp-c-bg: #1b1b1f;
      }

      html,
      body {
        background: var(--vp-c-bg);
      }
    </style>
    <script>
      const userMode = localStorage.getItem("vuepress-theme-hope-scheme");
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;

      if (userMode === "dark" || (userMode !== "light" && systemDarkMode)) {
        document.documentElement.setAttribute("data-theme", "dark");
      }
    </script>
    <script type="application/ld+json">{"@context":"https://schema.org","@type":"Article","headline":"SPEED UP！与 galgame 解封包","image":["https://absx.pages.dev/images/articles/speedup/arc1.png"],"datePublished":"2024-07-27T00:00:00.000Z","dateModified":"2025-12-14T02:29:56.000Z","author":[]}</script><meta property="og:url" content="https://absx.pages.dev/articles/speedup.html"><meta property="og:site_name" content="绝对值_x 的博客"><meta property="og:title" content="SPEED UP！与 galgame 解封包"><meta property="og:description" content="SPEED UP！与 galgame 解封包 本文主要包含了我对 galgame 语音加速的探索全过程。各章节大致按照时间顺序排布。主要内容在：二试封包 和 dll wrapper v0 v1。 我打 已经有几年了，不过也只接触了几部能够语音加速的游戏：紫社全套和 GINKA（后来还玩了更多不一一列举了）。游玩这几部作品让我非常兴奋：使用二倍速播放音频..."><meta property="og:type" content="article"><meta property="og:image" content="https://absx.pages.dev/images/articles/speedup/arc1.png"><meta property="og:locale" content="zh-CN"><meta property="og:updated_time" content="2025-12-14T02:29:56.000Z"><meta property="article:tag" content="音频"><meta property="article:tag" content="游戏"><meta property="article:tag" content="Galgame"><meta property="article:tag" content="Windows"><meta property="article:published_time" content="2024-07-27T00:00:00.000Z"><meta property="article:modified_time" content="2025-12-14T02:29:56.000Z"><link rel="alternate" type="application/rss+xml" href="https://absx.pages.dev/rss.xml" title="绝对值_x 的博客 RSS Feed"><title>SPEED UP！与 galgame 解封包 | 绝对值_x 的博客</title><meta name="description" content="SPEED UP！与 galgame 解封包 本文主要包含了我对 galgame 语音加速的探索全过程。各章节大致按照时间顺序排布。主要内容在：二试封包 和 dll wrapper v0 v1。 我打 已经有几年了，不过也只接触了几部能够语音加速的游戏：紫社全套和 GINKA（后来还玩了更多不一一列举了）。游玩这几部作品让我非常兴奋：使用二倍速播放音频...">
    <link rel="preload" href="/assets/style-7VdN72V2.css" as="style"><link rel="stylesheet" href="/assets/style-7VdN72V2.css">
    <link rel="modulepreload" href="/assets/app-BD9KDSbJ.js"><link rel="modulepreload" href="/assets/speedup.html-c-28op8R.js"><link rel="modulepreload" href="/assets/ExpandableHint-qbsQgSOt.js">
    
  </head>
  <body>
    <div id="app"><!--[--><!--[--><!--[--><span tabindex="-1"></span><a href="#main-content" class="vp-skip-link sr-only">跳至主要內容</a><!--]--><!--[--><div class="theme-container external-link-icon pure has-toc" vp-container><!--[--><header id="navbar" class="vp-navbar" vp-navbar><div class="vp-navbar-start"><button type="button" class="vp-toggle-sidebar-button" title="Toggle Sidebar"><span class="icon"></span></button><!--[--><a class="route-link vp-brand" href="/" aria-label="带我回家"><img class="vp-nav-logo" src="/logo.jpg" alt><!----><span class="vp-site-name hide-in-pad">绝对值_x 的博客</span></a><!--]--></div><div class="vp-navbar-center"><!--[--><nav class="vp-nav-links"><div class="vp-nav-item hide-in-mobile"><a class="route-link auto-link" href="/coding/" aria-label="编程" iconsizing="height"><!--[--><i class="vp-icon fas fa-code" sizing="height"></i><!--]-->编程<!----></a></div><div class="vp-nav-item hide-in-mobile"><div class="vp-dropdown-wrapper"><button type="button" class="vp-dropdown-title" aria-label="爱好"><!--[--><i class="vp-icon fas fa-heart" sizing="height"></i>爱好<!--]--><span class="arrow"></span><ul class="vp-dropdown"><li class="vp-dropdown-item"><h4 class="vp-dropdown-subtitle">游戏</h4><ul class="vp-dropdown-subitems"><li class="vp-dropdown-subitem"><a class="route-link auto-link" href="/hobbies/galgame.html" aria-label="galgame" iconsizing="both"><!--[--><i class="vp-icon fas fa-plane fa-fw" sizing="both"></i><!--]-->galgame<!----></a></li><li class="vp-dropdown-subitem"><a class="route-link auto-link" href="/hobbies/rhythm_games.html" aria-label="音游" iconsizing="both"><!--[--><i class="vp-icon fas fa-keyboard fa-fw" sizing="both"></i><!--]-->音游<!----></a></li><li class="vp-dropdown-subitem"><a class="route-link auto-link" href="/hobbies/other_games/" aria-label="其他游戏" iconsizing="both"><!--[--><i class="vp-icon fas fa-gamepad fa-fw" sizing="both"></i><!--]-->其他游戏<!----></a></li></ul></li><li class="vp-dropdown-item"><h4 class="vp-dropdown-subtitle">艺术</h4><ul class="vp-dropdown-subitems"><li class="vp-dropdown-subitem"><a class="route-link auto-link" href="/hobbies/books.html" aria-label="读书" iconsizing="both"><!--[--><i class="vp-icon fas fa-book-open-reader fa-fw" sizing="both"></i><!--]-->读书<!----></a></li><li class="vp-dropdown-subitem"><a class="route-link auto-link" href="/hobbies/anime.html" aria-label="番剧" iconsizing="both"><!--[--><i class="vp-icon fas fa-play fa-fw" sizing="both"></i><!--]-->番剧<!----></a></li><li class="vp-dropdown-subitem"><a class="route-link auto-link" href="/hobbies/art.html" aria-label="其他艺术形式" iconsizing="both"><!--[--><i class="vp-icon fas fa-palette fa-fw" sizing="both"></i><!--]-->其他艺术形式<!----></a></li><li class="vp-dropdown-subitem"><a class="route-link auto-link" href="/hobbies/NSFW/" aria-label="NSFW" iconsizing="both"><!--[--><i class="vp-icon fas fa-h fa-fw" sizing="both"></i><!--]-->NSFW<!----></a></li></ul></li><li class="vp-dropdown-item"><h4 class="vp-dropdown-subtitle">其他</h4><ul class="vp-dropdown-subitems"><li class="vp-dropdown-subitem"><a class="route-link auto-link" href="/hobbies/snack.html" aria-label="零食区" iconsizing="both"><!--[--><i class="vp-icon fas fa-cookie-bite fa-fw" sizing="both"></i><!--]-->零食区<!----></a></li></ul></li></ul></button></div></div><div class="vp-nav-item hide-in-mobile"><div class="vp-dropdown-wrapper"><button type="button" class="vp-dropdown-title" aria-label="杂项"><!--[--><i class="vp-icon fas fa-plus" sizing="height"></i>杂项<!--]--><span class="arrow"></span><ul class="vp-dropdown"><li class="vp-dropdown-item"><a class="route-link auto-link" href="/farraginous/recommend_packages.html" aria-label="软件汇总" iconsizing="both"><!--[--><i class="vp-icon fas fa-cube fa-fw" sizing="both"></i><!--]-->软件汇总<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/farraginous/recommend_websites.html" aria-label="网址汇总" iconsizing="both"><!--[--><i class="vp-icon fas fa-earth-asia fa-fw" sizing="both"></i><!--]-->网址汇总<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/farraginous/college.html" aria-label="校内专栏" iconsizing="both"><!--[--><i class="vp-icon fas fa-graduation-cap fa-fw" sizing="both"></i><!--]-->校内专栏<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/farraginous/reciter.html" aria-label="背词器" iconsizing="both"><!--[--><i class="vp-icon fas fa-eye fa-fw" sizing="both"></i><!--]-->背词器<!----></a></li></ul></button></div></div><div class="vp-nav-item hide-in-mobile"><a class="route-link route-link-active auto-link" href="/articles/" aria-label="文章" iconsizing="height"><!--[--><i class="vp-icon fas fa-blog" sizing="height"></i><!--]-->文章<!----></a></div><div class="vp-nav-item hide-in-mobile"><a class="route-link auto-link" href="/learning/" aria-label="学习" iconsizing="height"><!--[--><i class="vp-icon fas fa-pen" sizing="height"></i><!--]-->学习<!----></a></div><div class="vp-nav-item hide-in-mobile"><a class="route-link auto-link" href="/gossip/" aria-label="闲聊" iconsizing="height"><!--[--><i class="vp-icon fas fa-comment" sizing="height"></i><!--]-->闲聊<!----></a></div><div class="vp-nav-item hide-in-mobile"><a class="route-link auto-link" href="/essay/" aria-label="随笔" iconsizing="height"><!--[--><i class="vp-icon fas fa-newspaper" sizing="height"></i><!--]-->随笔<!----></a></div><div class="vp-nav-item hide-in-mobile"><a class="route-link auto-link" href="/blog/" aria-label="博客" iconsizing="height"><!--[--><i class="vp-icon fas fa-blog" sizing="height"></i><!--]-->博客<!----></a></div></nav><!--]--></div><div class="vp-navbar-end"><!--[--><div class="vp-nav-item vp-action"><a class="vp-action-link" href="https://github.com/lxl66566/lxl66566.github.io" target="_blank" rel="noopener noreferrer" aria-label="GitHub"><svg xmlns="http://www.w3.org/2000/svg" class="icon github-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="github icon" name="github" style="width:1.25rem;height:1.25rem;vertical-align:middle;"><path d="M511.957 21.333C241.024 21.333 21.333 240.981 21.333 512c0 216.832 140.544 400.725 335.574 465.664 24.49 4.395 32.256-10.07 32.256-23.083 0-11.69.256-44.245 0-85.205-136.448 29.61-164.736-64.64-164.736-64.64-22.315-56.704-54.4-71.765-54.4-71.765-44.587-30.464 3.285-29.824 3.285-29.824 49.195 3.413 75.179 50.517 75.179 50.517 43.776 75.008 114.816 53.333 142.762 40.79 4.523-31.66 17.152-53.377 31.19-65.537-108.971-12.458-223.488-54.485-223.488-242.602 0-53.547 19.114-97.323 50.517-131.67-5.035-12.33-21.93-62.293 4.779-129.834 0 0 41.258-13.184 134.912 50.346a469.803 469.803 0 0 1 122.88-16.554c41.642.213 83.626 5.632 122.88 16.554 93.653-63.488 134.784-50.346 134.784-50.346 26.752 67.541 9.898 117.504 4.864 129.834 31.402 34.347 50.474 78.123 50.474 131.67 0 188.586-114.73 230.016-224.042 242.09 17.578 15.232 33.578 44.672 33.578 90.454v135.85c0 13.142 7.936 27.606 32.854 22.87C862.25 912.597 1002.667 728.747 1002.667 512c0-271.019-219.648-490.667-490.71-490.667z"></path></svg></a></div><div class="nav-item vp-action"><a class="vp-action-link" href="https://t.me/ab5_x" target="_blank" rel="noopener noreferrer" aria-label="telegram"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512" style="width:1.25rem;height:1.25rem;vertical-align:middle;"><path d="M248,8C111.033,8,0,119.033,0,256S111.033,504,248,504,496,392.967,496,256,384.967,8,248,8ZM362.952,176.66c-3.732,39.215-19.881,134.378-28.1,178.3-3.476,18.584-10.322,24.816-16.948,25.425-14.4,1.326-25.338-9.517-39.287-18.661-21.827-14.308-34.158-23.215-55.346-37.177-24.485-16.135-8.612-25,5.342-39.5,3.652-3.793,67.107-61.51,68.335-66.746.153-.655.3-3.1-1.154-4.384s-3.59-.849-5.135-.5q-3.283.746-104.608,69.142-14.845,10.194-26.894,9.934c-8.855-.191-25.888-5.006-38.551-9.123-15.531-5.048-27.875-7.717-26.8-16.291q.84-6.7,18.45-13.7,108.446-47.248,144.628-62.3c68.872-28.647,83.183-33.623,92.511-33.789,2.052-.034,6.639.474,9.61,2.885a10.452,10.452,0,0,1,3.53,6.716A43.765,43.765,0,0,1,362.952,176.66Z" fill="currentColor"></path></svg></a></div><div class="nav-item vp-action"><a class="vp-action-link" href="/rss.xml" target="_blank" rel="noopener noreferrer" aria-label="telegram"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1024 1024" style="width:1.25rem;height:1.25rem;vertical-align:middle;"><path d="M320.16155 831.918c0 70.738-57.344 128.082-128.082 128.082S63.99955 902.656 63.99955 831.918s57.344-128.082 128.082-128.082 128.08 57.346 128.08 128.082z m351.32 94.5c-16.708-309.2-264.37-557.174-573.9-573.9C79.31155 351.53 63.99955 366.21 63.99955 384.506v96.138c0 16.83 12.98 30.944 29.774 32.036 223.664 14.568 402.946 193.404 417.544 417.544 1.094 16.794 15.208 29.774 32.036 29.774h96.138c18.298 0.002 32.978-15.31 31.99-33.58z m288.498 0.576C943.19155 459.354 566.92955 80.89 97.00555 64.02 78.94555 63.372 63.99955 77.962 63.99955 96.032v96.136c0 17.25 13.67 31.29 30.906 31.998 382.358 15.678 689.254 322.632 704.93 704.93 0.706 17.236 14.746 30.906 31.998 30.906h96.136c18.068-0.002 32.658-14.948 32.01-33.008z" fill="currentColor"></path></svg></a></div><div class="vp-nav-item hide-in-mobile"><button type="button" class="vp-color-mode-switch" id="color-mode-switch"><svg xmlns="http://www.w3.org/2000/svg" class="icon auto-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="auto icon" name="auto" style="display:block;"><path d="M512 992C246.92 992 32 777.08 32 512S246.92 32 512 32s480 214.92 480 480-214.92 480-480 480zm0-840c-198.78 0-360 161.22-360 360 0 198.84 161.22 360 360 360s360-161.16 360-360c0-198.78-161.22-360-360-360zm0 660V212c165.72 0 300 134.34 300 300 0 165.72-134.28 300-300 300z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon dark-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="dark icon" name="dark" style="display:none;"><path d="M524.8 938.667h-4.267a439.893 439.893 0 0 1-313.173-134.4 446.293 446.293 0 0 1-11.093-597.334A432.213 432.213 0 0 1 366.933 90.027a42.667 42.667 0 0 1 45.227 9.386 42.667 42.667 0 0 1 10.24 42.667 358.4 358.4 0 0 0 82.773 375.893 361.387 361.387 0 0 0 376.747 82.774 42.667 42.667 0 0 1 54.187 55.04 433.493 433.493 0 0 1-99.84 154.88 438.613 438.613 0 0 1-311.467 128z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon light-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="light icon" name="light" style="display:none;"><path d="M952 552h-80a40 40 0 0 1 0-80h80a40 40 0 0 1 0 80zM801.88 280.08a41 41 0 0 1-57.96-57.96l57.96-58a41.04 41.04 0 0 1 58 58l-58 57.96zM512 752a240 240 0 1 1 0-480 240 240 0 0 1 0 480zm0-560a40 40 0 0 1-40-40V72a40 40 0 0 1 80 0v80a40 40 0 0 1-40 40zm-289.88 88.08-58-57.96a41.04 41.04 0 0 1 58-58l57.96 58a41 41 0 0 1-57.96 57.96zM192 512a40 40 0 0 1-40 40H72a40 40 0 0 1 0-80h80a40 40 0 0 1 40 40zm30.12 231.92a41 41 0 0 1 57.96 57.96l-57.96 58a41.04 41.04 0 0 1-58-58l58-57.96zM512 832a40 40 0 0 1 40 40v80a40 40 0 0 1-80 0v-80a40 40 0 0 1 40-40zm289.88-88.08 58 57.96a41.04 41.04 0 0 1-58 58l-57.96-58a41 41 0 0 1 57.96-57.96z"></path></svg></button></div><!--[--><button type="button" class="slimsearch-button" aria-label="搜索"><svg xmlns="http://www.w3.org/2000/svg" class="icon search-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="search icon"><path d="M192 480a256 256 0 1 1 512 0 256 256 0 0 1-512 0m631.776 362.496-143.2-143.168A318.464 318.464 0 0 0 768 480c0-176.736-143.264-320-320-320S128 303.264 128 480s143.264 320 320 320a318.016 318.016 0 0 0 184.16-58.592l146.336 146.368c12.512 12.48 32.768 12.48 45.28 0 12.48-12.512 12.48-32.768 0-45.28"></path></svg><div class="slimsearch-placeholder">搜索</div><div class="slimsearch-key-hints"><kbd class="slimsearch-key">Ctrl</kbd><kbd class="slimsearch-key">K</kbd></div></button><!--]--><!--]--><button type="button" class="vp-toggle-navbar-button" aria-label="Toggle Navbar" aria-expanded="false" aria-controls="nav-screen"><span><span class="vp-top"></span><span class="vp-middle"></span><span class="vp-bottom"></span></span></button></div></header><!----><!--]--><!----><div class="toggle-sidebar-wrapper"><span class="arrow start"></span></div><aside id="sidebar" class="vp-sidebar" vp-sidebar><!----><ul class="vp-sidebar-links"><li><section class="vp-sidebar-group"><p class="vp-sidebar-header"><!----><span class="vp-sidebar-title">经历</span><!----></p><ul class="vp-sidebar-links"><li><a class="route-link auto-link vp-sidebar-link" href="/articles/linux/" aria-label="linux" iconsizing="both"><!--[--><i class="vp-icon fas fa-brands fa-linux fa-fw" sizing="both"></i><!--]-->linux<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/articles/windows_setting.html" aria-label="设置 Windows" iconsizing="both"><!--[--><i class="vp-icon fas fa-computer fa-fw" sizing="both"></i><!--]-->设置 Windows<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/articles/mobile/" aria-label="关于手机" iconsizing="both"><!--[--><i class="vp-icon fas fa-mobile fa-fw" sizing="both"></i><!--]-->关于手机<!----></a></li></ul></section></li><li><section class="vp-sidebar-group"><p class="vp-sidebar-header active"><!----><span class="vp-sidebar-title">教程</span><!----></p><ul class="vp-sidebar-links"><li><a class="route-link auto-link vp-sidebar-link" href="/articles/proxy/" aria-label="代理" iconsizing="both"><!--[--><i class="vp-icon fas fa-diagram-project fa-fw" sizing="both"></i><!--]-->代理<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/articles/telegram.html" aria-label="TG 教程" iconsizing="both"><!--[--><i class="vp-icon fas fa-brands fa-telegram fa-fw" sizing="both"></i><!--]-->TG 教程<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/articles/markdown.html" aria-label="Markdown" iconsizing="both"><!--[--><i class="vp-icon fas fa-brands fa-markdown fa-fw" sizing="both"></i><!--]-->Markdown<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/articles/minimize_exe.html" aria-label="program minimize" iconsizing="both"><!--[--><i class="vp-icon fas fa-minimize fa-fw" sizing="both"></i><!--]-->program minimize<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/articles/cli_compress.html" aria-label="命令行压缩/解压" iconsizing="both"><!--[--><i class="vp-icon fas fa-compress fa-fw" sizing="both"></i><!--]-->命令行压缩/解压<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/articles/yt-dlp.html" aria-label="yt-dlp 使用教程" iconsizing="both"><!--[--><i class="vp-icon fas fa-download fa-fw" sizing="both"></i><!--]-->yt-dlp 使用教程<!----></a></li><li><a class="route-link route-link-active auto-link vp-sidebar-link active" href="/articles/speedup.html" aria-label="SPEED UP！与 galgame 解封包" iconsizing="both"><!--[--><i class="vp-icon fas fa-gamepad fa-fw" sizing="both"></i><!--]-->SPEED UP！与 galgame 解封包<!----></a></li></ul></section></li><li><section class="vp-sidebar-group"><p class="vp-sidebar-header"><!----><span class="vp-sidebar-title">推荐</span><!----></p><ul class="vp-sidebar-links"><li><a class="route-link auto-link vp-sidebar-link" href="/articles/time_record.html" aria-label="记录软件使用时长" iconsizing="both"><!--[--><i class="vp-icon fas fa-clock fa-fw" sizing="both"></i><!--]-->记录软件使用时长<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/articles/track_record.html" aria-label="运动轨迹记录软件横评" iconsizing="both"><!--[--><i class="vp-icon fas fa-route fa-fw" sizing="both"></i><!--]-->运动轨迹记录软件横评<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/articles/input_method.html" aria-label="输入法" iconsizing="both"><!--[--><i class="vp-icon fas fa-keyboard fa-fw" sizing="both"></i><!--]-->输入法<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/articles/ramdisk.html" aria-label="RAM Disk 横评与教程" iconsizing="both"><!--[--><i class="vp-icon fas fa-diagram-next fa-fw" sizing="both"></i><!--]-->RAM Disk 横评与教程<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/articles/note.html" aria-label="笔记软件横评" iconsizing="both"><!--[--><i class="vp-icon fas fa-note-sticky fa-fw" sizing="both"></i><!--]-->笔记软件横评<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/articles/reverse_proxy.html" aria-label="反向代理" iconsizing="both"><!--[--><i class="vp-icon fas fa-handshake-simple fa-fw" sizing="both"></i><!--]-->反向代理<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/articles/voice2text.html" aria-label="音频转文字" iconsizing="both"><!--[--><i class="vp-icon fas fa-file-audio fa-fw" sizing="both"></i><!--]-->音频转文字<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/articles/ocr.html" aria-label="OCR" iconsizing="both"><!--[--><i class="vp-icon fas fa-camera-rotate fa-fw" sizing="both"></i><!--]-->OCR<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/articles/pdf_reader.html" aria-label="PDF 阅读器横评" iconsizing="both"><!--[--><i class="vp-icon fas fa-file-pdf fa-fw" sizing="both"></i><!--]-->PDF 阅读器横评<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/articles/frp.html" aria-label="内网穿透" iconsizing="both"><!--[--><i class="vp-icon fas fa-slash fa-fw" sizing="both"></i><!--]-->内网穿透<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/articles/android_player.html" aria-label="Android 音乐播放器横评" iconsizing="both"><!--[--><i class="vp-icon fas fa-play fa-fw" sizing="both"></i><!--]-->Android 音乐播放器横评<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/articles/money.html" aria-label="理财，加密货币与区块链" iconsizing="both"><!--[--><i class="vp-icon fas fa-brands fa-bitcoin fa-fw" sizing="both"></i><!--]-->理财，加密货币与区块链<!----></a></li></ul></section></li><li><a class="route-link auto-link vp-sidebar-link" href="/articles/external.html" aria-label="外部文章分享" iconsizing="both"><!---->外部文章分享<!----></a></li></ul><!----></aside><!--[--><!--[--><main id="main-content" class="vp-page"><!--[--><!----><!----><nav class="vp-breadcrumb disable"></nav><div class="vp-page-title"><h1><i class="vp-icon fas fa-gamepad" sizing="height"></i>SPEED UP！与 galgame 解封包</h1><div class="page-info"><!----><!----><span class="page-date-info" aria-label="写作日期"><svg xmlns="http://www.w3.org/2000/svg" class="icon calendar-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="calendar icon" name="calendar"><path d="M716.4 110.137c0-18.753-14.72-33.473-33.472-33.473-18.753 0-33.473 14.72-33.473 33.473v33.473h66.993v-33.473zm-334.87 0c0-18.753-14.72-33.473-33.473-33.473s-33.52 14.72-33.52 33.473v33.473h66.993v-33.473zm468.81 33.52H716.4v100.465c0 18.753-14.72 33.473-33.472 33.473a33.145 33.145 0 01-33.473-33.473V143.657H381.53v100.465c0 18.753-14.72 33.473-33.473 33.473a33.145 33.145 0 01-33.473-33.473V143.657H180.6A134.314 134.314 0 0046.66 277.595v535.756A134.314 134.314 0 00180.6 947.289h669.74a134.36 134.36 0 00133.94-133.938V277.595a134.314 134.314 0 00-133.94-133.938zm33.473 267.877H147.126a33.145 33.145 0 01-33.473-33.473c0-18.752 14.72-33.473 33.473-33.473h736.687c18.752 0 33.472 14.72 33.472 33.473a33.145 33.145 0 01-33.472 33.473z"></path></svg><span data-allow-mismatch="text">2024年7月27日</span><meta property="datePublished" content="2024-07-27T00:00:00.000Z"></span><!----><span class="page-reading-time-info" aria-label="阅读时间"><svg xmlns="http://www.w3.org/2000/svg" class="icon timer-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="timer icon" name="timer"><path d="M799.387 122.15c4.402-2.978 7.38-7.897 7.38-13.463v-1.165c0-8.933-7.38-16.312-16.312-16.312H256.33c-8.933 0-16.311 7.38-16.311 16.312v1.165c0 5.825 2.977 10.874 7.637 13.592 4.143 194.44 97.22 354.963 220.201 392.763-122.204 37.542-214.893 196.511-220.2 389.397-4.661 5.049-7.638 11.651-7.638 19.03v5.825h566.49v-5.825c0-7.379-2.849-13.981-7.509-18.9-5.049-193.016-97.867-351.985-220.2-389.527 123.24-37.67 216.446-198.453 220.588-392.892zM531.16 450.445v352.632c117.674 1.553 211.787 40.778 211.787 88.676H304.097c0-48.286 95.149-87.382 213.728-88.676V450.445c-93.077-3.107-167.901-81.297-167.901-177.093 0-8.803 6.99-15.793 15.793-15.793 8.803 0 15.794 6.99 15.794 15.793 0 80.261 63.69 145.635 142.01 145.635s142.011-65.374 142.011-145.635c0-8.803 6.99-15.793 15.794-15.793s15.793 6.99 15.793 15.793c0 95.019-73.789 172.82-165.96 177.093z"></path></svg><span>大约 66 分钟</span><meta property="timeRequired" content="PT66M"></span><span class="page-category-info" aria-label="分类"><svg xmlns="http://www.w3.org/2000/svg" class="icon category-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="category icon" name="category"><path d="M148.41 106.992h282.176c22.263 0 40.31 18.048 40.31 40.31V429.48c0 22.263-18.047 40.31-40.31 40.31H148.41c-22.263 0-40.311-18.047-40.311-40.31V147.302c0-22.263 18.048-40.31 40.311-40.31zM147.556 553.478H429.73c22.263 0 40.311 18.048 40.311 40.31v282.176c0 22.263-18.048 40.312-40.31 40.312H147.555c-22.263 0-40.311-18.049-40.311-40.312V593.79c0-22.263 18.048-40.311 40.31-40.311zM593.927 106.992h282.176c22.263 0 40.31 18.048 40.31 40.31V429.48c0 22.263-18.047 40.31-40.31 40.31H593.927c-22.263 0-40.311-18.047-40.311-40.31V147.302c0-22.263 18.048-40.31 40.31-40.31zM730.22 920.502H623.926c-40.925 0-74.22-33.388-74.22-74.425V623.992c0-41.038 33.387-74.424 74.425-74.424h222.085c41.038 0 74.424 33.226 74.424 74.067v114.233c0 10.244-8.304 18.548-18.547 18.548s-18.548-8.304-18.548-18.548V623.635c0-20.388-16.746-36.974-37.33-36.974H624.13c-20.585 0-37.331 16.747-37.331 37.33v222.086c0 20.585 16.654 37.331 37.126 37.331H730.22c10.243 0 18.547 8.304 18.547 18.547 0 10.244-8.304 18.547-18.547 18.547z"></path></svg><!--[--><span class="page-category-item clickable" role="navigation">教程</span><span class="page-category-item clickable" role="navigation">探索</span><!--]--><meta property="articleSection" content="教程,探索"></span><span class="page-tag-info" aria-label="标签"><svg xmlns="http://www.w3.org/2000/svg" class="icon tag-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="tag icon" name="tag"><path d="M939.902 458.563L910.17 144.567c-1.507-16.272-14.465-29.13-30.737-30.737L565.438 84.098h-.402c-3.215 0-5.726 1.005-7.634 2.913l-470.39 470.39a10.004 10.004 0 000 14.164l365.423 365.424c1.909 1.908 4.42 2.913 7.132 2.913s5.223-1.005 7.132-2.913l470.39-470.39c2.01-2.11 3.014-5.023 2.813-8.036zm-240.067-72.121c-35.458 0-64.286-28.828-64.286-64.286s28.828-64.285 64.286-64.285 64.286 28.828 64.286 64.285-28.829 64.286-64.286 64.286z"></path></svg><!--[--><span class="page-tag-item clickable" role="navigation">Windows</span><span class="page-tag-item clickable" role="navigation">Galgame</span><span class="page-tag-item clickable" role="navigation">游戏</span><span class="page-tag-item clickable" role="navigation">音频</span><!--]--><meta property="keywords" content="Windows,Galgame,游戏,音频"></span></div><hr></div><!----><div class="" vp-content><!----><div id="markdown-content"><h1 id="speed-up-与-galgame-解封包" tabindex="-1"><a class="header-anchor" href="#speed-up-与-galgame-解封包"><span>SPEED UP！与 galgame 解封包</span></a></h1><p>本文主要包含了我对 galgame 语音加速的探索全过程。各章节大致按照时间顺序排布。主要内容在：<a href="#%E4%BA%8C%E8%AF%95%E5%B0%81%E5%8C%85">二试封包</a> 和 dll wrapper <a href="#dll-wrapper-v0">v0</a> <a href="#dll-wrapper-v1">v1</a>。</p><p>我打 <a class="route-link" href="/hobbies/galgame.html">galgame</a> 已经有几年了，不过也只接触了几部能够语音加速的游戏：紫社全套和 <em>GINKA</em>（后来还玩了更多不一一列举了）。游玩这几部作品让我非常兴奋：使用二倍速播放音频，我就能节省一半的游戏时间，<s>相当于延长了一倍的生命</s>。经历过加速后，再次玩其他语音速度极低的 galgame （真红真红真？）让我感觉像是在浪费生命。因此我尝试寻找能够让我节省时间的游戏语音加速方式。</p><h2 id="音频处理软件" tabindex="-1"><a class="header-anchor" href="#音频处理软件"><span>音频处理软件</span></a></h2><p>音频处理领域很多软件都是商业非自由软件，要交钱的，毕竟音频处理本身也是天坑。而我找不到能对其他 APP 进行音频加速的软件。</p><p>写在这里的只是我试过的一部分：</p><ul><li>Equalizer APO：提供了易于编辑的 GUI 界面，用户可以自己创建不同的效果器和 filter。不过无法做到音频加速或音量均衡。</li><li>Fxsound：开源效果器，可以让游戏加强脚步声等。不过延迟有点高，而且无法实现音频加速。</li></ul><h2 id="ce" tabindex="-1"><a class="header-anchor" href="#ce"><span>CE</span></a></h2><p>Cheat Engine 想必大家都不陌生，我也会使用 CE 进行 RPG galgame（兰斯系列）或者动效太多（型月）gal 的加速。CE 中有一个变速精灵的功能非常好用，用鼠标点几次即可轻松修改程序速度。但是 CE 不能加速音频（因为音频播放是调用操作系统 API），这也是 CE 的最大败笔。因此我需要另寻出路。</p><h2 id="解包与封包" tabindex="-1"><a class="header-anchor" href="#解包与封包"><span>解包与封包</span></a></h2><p>20240720 我尝试了一个想法：将 galgame 音频文件解包，加速后再封包回去。由于我不会逆向，因此使用的是 GARbro，这是一个非常泛用的，多目标 galgame 资源提取器。我使用 いろとりどりのセカイ HD 尝试，这个游戏把 <code>voice.bin</code> 单文件放在根目录下，非常明显，我很轻易地就提取出了游戏的所有 ogg 格式的语音。</p><p>那么我要如何将加速后的 ogg 封装回一个 <code>voice.bin</code> 呢？我被卡在了这一步下。GARbro 根据预设的解包规则检测出格式并解了包，但是却<strong>不告诉我这个包用的究竟是什么格式</strong>。Asuka Minato 也提醒：解包容易，但封包可能非常困难。因此我暂时打消了这个想法。<span title="你知道的太多了" data-v-3735ce50><!--[--><a href="#%E4%BA%8C%E8%AF%95%E5%B0%81%E5%8C%85">二试封包</a><!--]--></span></p><h2 id="pyaudio" tabindex="-1"><a class="header-anchor" href="#pyaudio"><span>pyaudio</span></a></h2><p>20240724 我进行了初次尝试，写一个 python 脚本建立了一个系统音频合成器到扬声器的音频流，在中间使用脚本进行音频加速。</p><p>首先安装一个 VB Cable，其作用是修改输入输出设备，防止音频合成器直接将音频输出到扬声器，覆盖掉我处理后的输入。然后脚本大概是这样：</p><div class="language-py line-numbers-mode" data-highlighter="shiki" data-ext="py" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">import</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> time</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">import</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> pyaudio</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 配置音频流参数</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#D19A66;">FORMAT</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> pyaudio.paInt16</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#D19A66;">CHANNELS</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 2</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#D19A66;">RATE</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 44100</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#D19A66;">CHUNK</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 1024</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#D19A66;">SPEED_FACTOR</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 1.5</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">p </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> pyaudio.</span><span style="--shiki-light:#383A42;--shiki-dark:#61AFEF;">PyAudio</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">def</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> list_audio_devices_and_return_vb_cable</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">():</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    info </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> p.</span><span style="--shiki-light:#383A42;--shiki-dark:#61AFEF;">get_host_api_info_by_index</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    num_devices </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> info.</span><span style="--shiki-light:#383A42;--shiki-dark:#61AFEF;">get</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;deviceCount&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    device_map </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {}</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    for</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> i </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">in</span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;"> range</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(num_devices):</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        device_info </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> p.</span><span style="--shiki-light:#383A42;--shiki-dark:#61AFEF;">get_device_info_by_host_api_device_index</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, i)</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        device_name </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> device_info.</span><span style="--shiki-light:#383A42;--shiki-dark:#61AFEF;">get</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;name&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        device_map[device_name] </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> i</span></span>
<span class="line"><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;">        print</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">            f</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;Device ID: </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">{</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">i</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">}</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> - Name: </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">{</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">device_info.</span><span style="--shiki-light:#383A42;--shiki-dark:#61AFEF;">get</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&#39;name&#39;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">}</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> - Input Channels: </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">{</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">device_info[</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&#39;maxInputChannels&#39;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">]</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">}</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">, Output Channels: </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">{</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">device_info[</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&#39;maxOutputChannels&#39;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">]</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">}</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        )</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    return</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">6</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">     # 直接返回 device id, for testing</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 获取设备索引</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">input_index, output_index </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#61AFEF;"> list_audio_devices_and_return_vb_cable</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()</span></span>
<span class="line"><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;">print</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">f</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;VB-Cable Input: </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">{</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">input_index</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">}</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">, VB-Cable Output: </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">{</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">output_index</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">}</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">input_stream </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> p.</span><span style="--shiki-light:#383A42;--shiki-dark:#61AFEF;">open</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span></span>
<span class="line"><span style="--shiki-light:#986801;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;">    format</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#D19A66;">FORMAT</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="--shiki-light:#986801;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;">    channels</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#D19A66;">CHANNELS</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="--shiki-light:#986801;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;">    rate</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#D19A66;">RATE</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    # rate=int(RATE * SPEED_FACTOR),</span></span>
<span class="line"><span style="--shiki-light:#986801;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;">    input</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">True</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="--shiki-light:#986801;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;">    frames_per_buffer</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#D19A66;">CHUNK</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="--shiki-light:#986801;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;">    input_device_index</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">input_index,</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">def</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> callback</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#986801;--shiki-light-font-style:inherit;--shiki-dark:#D19A66;--shiki-dark-font-style:italic;">in_data</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#986801;--shiki-light-font-style:inherit;--shiki-dark:#D19A66;--shiki-dark-font-style:italic;"> frame_count</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#986801;--shiki-light-font-style:inherit;--shiki-dark:#D19A66;--shiki-dark-font-style:italic;"> time_info</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#986801;--shiki-light-font-style:inherit;--shiki-dark:#D19A66;--shiki-dark-font-style:italic;"> status</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">):</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    out_data </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> input_stream.</span><span style="--shiki-light:#383A42;--shiki-dark:#61AFEF;">read</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(frame_count, </span><span style="--shiki-light:#986801;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;">exception_on_overflow</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">False</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    return</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (out_data, pyaudio.paContinue)</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">output_stream </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> p.</span><span style="--shiki-light:#383A42;--shiki-dark:#61AFEF;">open</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span></span>
<span class="line"><span style="--shiki-light:#986801;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;">    format</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#D19A66;">FORMAT</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="--shiki-light:#986801;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;">    channels</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#D19A66;">CHANNELS</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="--shiki-light:#986801;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;">    rate</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;">int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#383A42;--shiki-dark:#D19A66;">RATE</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> *</span><span style="--shiki-light:#383A42;--shiki-dark:#D19A66;"> SPEED_FACTOR</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    # rate=RATE,</span></span>
<span class="line"><span style="--shiki-light:#986801;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;">    output</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">True</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    # frames_per_buffer=int(CHUNK / SPEED_FACTOR),</span></span>
<span class="line"><span style="--shiki-light:#986801;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;">    frames_per_buffer</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#D19A66;">CHUNK</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="--shiki-light:#986801;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;">    output_device_index</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">output_index,</span></span>
<span class="line"><span style="--shiki-light:#986801;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;">    stream_callback</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">callback,</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 检查是否成功打开</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> input_stream.</span><span style="--shiki-light:#383A42;--shiki-dark:#61AFEF;">is_active</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">() </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">and</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> output_stream.</span><span style="--shiki-light:#383A42;--shiki-dark:#61AFEF;">is_active</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">():</span></span>
<span class="line"><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;">    print</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;输入和输出流已成功打开。&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">try</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">:</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    while</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> True</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">:</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        time.</span><span style="--shiki-light:#383A42;--shiki-dark:#61AFEF;">sleep</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">0.1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">except</span><span style="--shiki-light:#0184BC;--shiki-dark:#ABB2BF;"> KeyboardInterrupt</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">:</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    # 用户中断程序时，关闭音频流</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    input_stream.</span><span style="--shiki-light:#383A42;--shiki-dark:#61AFEF;">stop_stream</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    input_stream.</span><span style="--shiki-light:#383A42;--shiki-dark:#61AFEF;">close</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    output_stream.</span><span style="--shiki-light:#383A42;--shiki-dark:#61AFEF;">stop_stream</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    output_stream.</span><span style="--shiki-light:#383A42;--shiki-dark:#61AFEF;">close</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    p.</span><span style="--shiki-light:#383A42;--shiki-dark:#61AFEF;">terminate</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()</span></span>
<span class="line"><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;">    exit</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>音频的模型可以想象成拥有一个 trunk 缓冲区，音频先被输入到缓冲区，然后再播放出去，而这个缓冲区归我所有，我可以对其进行任意操作。</p><p>先列出所有音频设备，然后指定音频合成器作为输入流，扬声器作为输出流，定义了一个 callback 函数让输出流可以直接通过 callback 去请求输入（也可以不用 callback，将逻辑写在 while True 里）。至于音频加速则体现在 output stream 的 rate 上，因此实际上没有对音频进行任何处理，只是改变了输出速率。</p><p>实际测试中，音频输出速度和频率确实升高了，但是表现为 (输出一段加速的音频 -&gt; 静音一段时间) 的循环。这是因为 trunk 的输入速率是恒定的，pyaudio 会 wait trunk 填满。如果我加速把 trunk 的音频打出去，那么就会有一段时间，trunk 里不存在音频，所以没有输出。</p><p>把 CE 和此脚本一起使用也还是一样的效果，因为 CE 本身不能加速音频，也就无法加速程序对 trunk 的填充速度。因此此次尝试失败，感觉尝试的方向就是错的，没法通过音频倒逼游戏速度。</p><h2 id="tas" tabindex="-1"><a class="header-anchor" href="#tas"><span>TAS</span></a></h2><p>20240727 （也就是本文撰写时间），我突然想到，TAS 是把游戏慢放，那么反向 TAS 是否就能够加速游戏呢？并且 TAS 视频中游戏声音是正常的，显然 TAS 有自己的办法处理游戏音频速度，所以理论上一定是行得通的。</p><h3 id="libtas" tabindex="-1"><a class="header-anchor" href="#libtas"><span>libTAS</span></a></h3><p>首先我尝试了 libTAS，这是一个泛目标开源 tas 库+软件，许多其他 TAS 生态是建立在 libTAS 上的。libTAS 只能运行在 linux。libTAS 在 NixOS 上的打包不算太好，低了一个版本，也缺失了 libtas32.so 库导致没法运行 32 位 exe，需要手动用 <code>LIBTAS_SO_PATH</code> 拉；然后 libTAS 运行时会去找 libalsa，NixOS 的 dynamic link 管理又是混沌与邪恶的，因此我还需要大费周章手动用 <code>LD_LIBRARY_PATH</code> 把运行库拉进来。</p><p>这一切做好以后，游戏还是打不开，显示 <em>HD 不是一个有效的 binary</em>… （HD 是游戏路径上的一个词）我怀疑它 parse 参数出了问题，但是我没有证据，它也不输出它用的启动指令。</p><p>后来我自己打了 1.4.6 的 libTAS 包，然后自己打了一串超级长的启动指令：</p><div class="language-sh line-numbers-mode" data-highlighter="shiki" data-ext="sh" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">LD_LIBRARY_PATH</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">/tmp:/nix/store/1ry2s2jgqbl3w7w54b8biylwqdxy52zw-steam-fhs/usr/lib32/:LD_LIBRARY_PATH</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> LIBTAS_SO_PATH</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">/tmp/libtas.so</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> WINEPREFIX</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">/home/absx/.local/share/wineprefixes/origin</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> libTAS</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>嗯，steam-fhs 还是好用的。现在我的游戏已经起来了，但是我发现我不会用 libTAS，无法调速。。反正 README 说的快捷键，TAB 和 V 这些都是用不了的，在 Qt GUI 窗口里设置速度也没有任何效果。</p><p>尝试在 windows WSL2 里用 libTAS，结果还要起 wine，那跟我在 linux 没有任何区别。不测了。</p><h3 id="hourglass" tabindex="-1"><a class="header-anchor" href="#hourglass"><span>hourglass</span></a></h3><p>转战 windows，hourglass 也是一个泛用 TAS 工具，仅支持 win32，不过它已经非常老了。我只是想试试看，没想到 hourglass 真的可以让我的游戏跑起来，并且能够改变游戏音频速度！但是 hourglass 有一些致命的缺陷：</p><ol><li>不支持鼠标</li><li>减速有多档位可调；但是加速只有一个 fastforward 用于快进的，大概有 10 倍速并且不可调。这个速度还不如不听语音（骂人）。</li></ol><p>基于这些原因，hourglass 也无法使用。但它的存在是有意义的：它至少给了我一个成功的例子，告诉我前方并非是一片黑暗，我做的事情并不是毫无希望的。</p><h3 id="其他" tabindex="-1"><a class="header-anchor" href="#其他"><span>其他</span></a></h3><p>尝试其他 TAS，但几乎找不到其他泛用的 TAS 了。TAS 世界的 tools 大多还是针对某个游戏或某个模拟器，这种任意进程加速的工具真是少之又少。</p><ul><li>BizHawk：泛用 TAS 工具，但仅支持镜像加载，主要针对游戏机，不符合我的需求。 <ul><li>不过也有一些 galgame 是使用 CD 的，我只能说保留尝试的可能性。</li></ul></li><li>UniTAS：专门针对 unity 游戏，有的 galgame 使用 unity 引擎的可能可以尝试。不过真心不多。</li><li><a href="#hourglass-resurrection">Hourglass-Resurrection</a>：一个 hourglass fork，但是也已经停更了。没有提供二进制，我尝试自己构建也失败了（VS 除了点构建运行就啥也不会干了）。后面有更详细的尝试过程。</li></ul><h3 id="libspeedhack" tabindex="-1"><a class="header-anchor" href="#libspeedhack"><span><a href="https://github.com/evg-zhabotinsky/libspeedhack" target="_blank" rel="noopener noreferrer">libspeedhack</a></span></a></h3><p>20240729：虽然很麻烦，但是我还是为了仅存的一点希望去尝试一下 libspeedhack。作者已经消失两年了。我按照说明直接用，不出意外地出了意外： <code>libspeedhack32.so: undefined symbol: floor</code>. 然后去瞄了下 issue，果然有一个一样的问题，并且别人也修了，开了 pr 在构建时加了个 <code>-lm</code> 参数。然后我很开心，拉下来想构建，结果：</p><p>我们的 NixOS 实在是太棒啦！环境根本搞不起来，它的构建指令需要静态链接 + cross 32 位，什么 libclang，glibc_multi 的包直接加进去根本满足不了需求，再加上我根本不知道在 buildInputs 里能写哪些玩意，比如 glibc 就能写 <code>glibc.static</code>， glibc_multi 能写 <code>glibc_multi.dev</code>，这种有个点后面跟着啥玩意的我除了读 nix 源码也想不到要去哪查。</p><p>然后去我的 debian 云服务器上尝试构建，东西都装好了，然后没有数学库：<code>ld: cannot find -lm: No such file or directory</code>。我又把 <code>libm.so</code> 拿出来装到 <code>LD_LIBRARY_PATH</code> 里，继续构建，又会得到：</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span>/libc.a(malloc.o): relocation R_X86_64_TPOFF32 against &#39;tcache&#39; can not be used when making a shared object; recompile with -fPIC</span></span>
<span class="line"><span>ld: failed to set dynamic section sizes: bad value</span></span>
<span class="line"><span>collect2: 错误：ld 返回 1</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>一度让我想放弃。问了下 gpt-4o，让我不要把 libm.so 在构建时链进去，应该在运行时加载。于是我最后的尝试成功，修改它给的启动脚本：</p><div class="language-sh line-numbers-mode" data-highlighter="shiki" data-ext="sh" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">#!/usr/bin/env bash</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">rm</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -f</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> /tmp/speedhack_{pipe,log}</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">mkfifo</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> /tmp/speedhack_pipe</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">_libdir</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">/home/absx/lib</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">      # （我把东西存这里）</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">LD_LIBRARY_PATH</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;</span><span style="--shiki-light:#E45649;--shiki-dark:#98C379;">${</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">_libdir</span><span style="--shiki-light:#E45649;--shiki-dark:#98C379;">}</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">/lib:</span><span style="--shiki-light:#E45649;--shiki-dark:#98C379;">${</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">_libdir</span><span style="--shiki-light:#E45649;--shiki-dark:#98C379;">}</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">/lib64:</span><span style="--shiki-light:#E45649;--shiki-dark:#98C379;">${</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">_libdir</span><span style="--shiki-light:#E45649;--shiki-dark:#98C379;">}</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">/lib32</span><span style="--shiki-light:#E45649;--shiki-dark:#98C379;">${</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">LD_LIBRARY_PATH</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">:</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">+</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">:</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">$LD_LIBRARY_PATH</span><span style="--shiki-light:#E45649;--shiki-dark:#98C379;">}</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> \</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">LD_PRELOAD=</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;libspeedhack.so:</span><span style="--shiki-light:#E45649;--shiki-dark:#98C379;">${</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">_libdir</span><span style="--shiki-light:#E45649;--shiki-dark:#98C379;">}</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">/libm.so:</span><span style="--shiki-light:#E45649;--shiki-dark:#98C379;">${</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">_libdir</span><span style="--shiki-light:#E45649;--shiki-dark:#98C379;">}</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">/libm32.so:</span><span style="--shiki-light:#E45649;--shiki-dark:#98C379;">${</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">LD_PRELOAD</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">:</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">+</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">:</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">$LD_PRELOAD</span><span style="--shiki-light:#E45649;--shiki-dark:#98C379;">}</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;</span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;"> \</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">exec </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;">$@</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这样把 <code>libm.so</code> 作为 <code>LD_PRELOAD</code> 运行时加载进 <code>./start.sh wine xxx.exe</code> 即可。</p><p>游戏打开了，但是……我加速呢？我 <code>echo 2.0 &gt; /tmp/speedhack_pipe</code> 都要按冒烟了，所以我的加速呢？？不只声音，就连游戏本身也没有加速，就跟 libspeedhack 不存在一样地和谐。于是此次尝试又宣告失败，骂这个跑路项目也解决不了什么，还是不骂了。</p><blockquote><p>ps. 事实上，通过源码也能知道，Github 上的这些 libspeedhack、<a href="https://github.com/Letomaniy/Speed-Hack" target="_blank" rel="noopener noreferrer">Letomaniy/Speed-Hack</a>、<a href="https://github.com/Hirtol/speedhack-rs" target="_blank" rel="noopener noreferrer">Hirtol/speedhack-rs</a> 等 speedhack 并不涉及音频 api 的修改，因此不可能有音频加速效果。妄图通过简单的一点点源码实现加速只能说是天方夜谭。</p></blockquote><h2 id="speedy" tabindex="-1"><a class="header-anchor" href="#speedy"><span><a href="https://github.com/game1024/Speedy" target="_blank" rel="noopener noreferrer">Speedy</a></span></a></h2><p>一个简单点点点就能加速窗口的国人开源软件，比较电脑小白向。最高支持数千倍加速，体验还不错，但是跟 CE 一样，<a href="https://github.com/game1024/Speedy/issues/151" target="_blank" rel="noopener noreferrer">也不支持音频加速</a>。</p><h2 id="源码构建" tabindex="-1"><a class="header-anchor" href="#源码构建"><span>源码构建</span></a></h2><p>20240803：到了这一步，市面上的各种现有软件看起来已经是山穷水尽了，我开始把目光转向修改代码。</p><p>一个选择是读 wine 的音频 api 然后写点 lib 注入。另一个选择看起来成功率更大一些，那就是直接修改 hourglass 的代码，毕竟人家的功能可行性已经通过了验证。</p><p>hourglass 是 C++ 写成，调的都是 windows api，项目管理用 vs sln。我之前从未用 vs 写过 C/C++ 代码，而且 C++ 构建本来就是一坨，还是去构建已经不再维护的代码，因此预感此次修改也不会顺利。</p><h3 id="hourglass-resurrection" tabindex="-1"><a class="header-anchor" href="#hourglass-resurrection"><span><a href="https://github.com/lxl66566/Hourglass-Resurrection" target="_blank" rel="noopener noreferrer">Hourglass-Resurrection</a></span></a></h3><p>这是一份 7 年前的代码，Hourglass 的重生版。不抱希望搜了下 fork，没啥大修改，因此开始 clone。</p><p>想修改代码第一步就是跑过编译，因此我开始折腾编译。扔到 vs 2022，一编译，一大堆报错。这些报错还都挺抽象的，例如有个叫 <code>IDirectSoundSinkFactory</code> 的玩意找不到声明，但是我把它宏解了能看到声明。Google 也搜不到这玩意。</p><p>我看 Hourglass-Resurrection 有一个 <a href="https://ci.appveyor.com/project/Warepire/hourglass-resurrection/branch/master" target="_blank" rel="noopener noreferrer">7 年前跑的 CI</a> 是可以过构建的，用的是 msbuild。于是我下载 .Net sdk，发现：</p><ol><li>msbuild 本身不会在安装时被加入环境变量，要用绝对路径调用。</li><li>windows sdk 版本不匹配，于是我去下载了 10.0.22621，重新 build。</li><li>报 <code>error MSB6001: “CL.exe”的命令行开关无效。</code> 猜测应该是本机的 clang 太新导致的。</li></ol><p>我也想过装老版本 vs，下载后发现不同版本 vs 不能共存。于是打消念头。</p><p>不想再折腾本机，跑去写 Github CI。结果找的 install windows sdk CI 没一个能用的，我指定的 22621 version 要么找不到，要么就是脚本内部错误。然后我也不指定版本了，改用 <code>choco install visualstudio2022buildtools windows-sdk-10.0</code>，结果花了好几分钟安装后告诉我还是找不到 msbuild。。太经典了。</p><p>又继续啃了一会，给一堆 struct 和 macro 移形换位，编译不报错了，取而代之是链接爆了一大堆 error：<code>LNK2001 无法解析的外部符号</code>。。这下我是真没辙了。</p><h3 id="hourglass-win32" tabindex="-1"><a class="header-anchor" href="#hourglass-win32"><span><a href="https://github.com/TASEmulators/hourglass-win32" target="_blank" rel="noopener noreferrer">hourglass-win32</a></span></a></h3><p>这个是原版 hourglass 代码，年代更加久远了，距今有足足 14 年的历史。</p><p>用 vs 2022 打开，跑一次构建，没想到居然能够把 GUI 跑起来，已经很厉害了。不过逻辑是没有的，构建时出了挺多错误。</p><p>这些 error 看起来比 Hourglass-Resurrection 好读多了，我猜测是 C++ 编译器标准太高导致的编译低版本不兼容的问题。尝试降低 C++ 编译器版本，vs 告诉我：我们接受指定的最低版本是 C++14 😅。</p><h2 id="自己写" tabindex="-1"><a class="header-anchor" href="#自己写"><span>自己写</span></a></h2><p>干到现在我已经不想再折腾构建了，不如干脆读代码，然后开抄，写一个自己的注入 lib。我的想法很简单，只加速音频播放，不加速游戏本身（如果想要两个都加速，那就再开一个 CE）。</p><p>从读代码角度来说，Hourglass-Resurrection 还是比原版要好很多的，<s>虽然 C++ 项目一直都很难读</s>。最重要的显然是 <code>source\hooks\hooks\soundhooks.cpp</code>，它是整个音频加速的核心；并且可以看到文件在最后定义了注入/拦截（Intercept），将以下函数全部干掉了：</p><h4 id="winsound" tabindex="-1"><a class="header-anchor" href="#winsound"><span>WinSound</span></a></h4><ul><li>PlaySound 系列：PlaySoundA, PlaySoundW <ul><li>这是 windows 早期的简单音频播放 api，只需要提供文件名即可。W 和 A 指文件名的编码。由于我们不能直接获取到音频 buffer，因此只能将音频加速后保存到 temp 再调用函数。</li><li>但是 Hourglass-Resurrection 把这两个 api suppress 了，那我就干脆不管了，遇到问题再说。</li></ul></li><li>waveOut 系列，包含 waveOutWrite, waveOutGetPosition, waveOutReset, waveOutOpen。这几个貌似就没法操作 buffer 了，毕竟这个 api 就是操作 tick 用的，可能只能用 tick 魔法了。不过理论上应该也不难。 <ul><li>保留用 waveOutSetPlaybackRate 强改的可能。</li></ul></li><li>Beep 系列，MessageBeep 和 Beep。这也是 suppress 的，目的应该是 TAS 那边的，不用管。</li></ul><h4 id="directsound" tabindex="-1"><a class="header-anchor" href="#directsound"><span>DirectSound</span></a></h4><ul><li>DirectSoundCreate(8), DirectSoundEnumerate(A/W), DirectSoundCaptureEnumerate(A/W)，这几个是重点，毕竟游戏都调用的 DirectSound，因为可以叠加音频播放。 <ul><li>这些函数可就麻烦了，<strong>Hourglass-Resurrection 自己写了一个 DirectSound 的音频驱动程序</strong>，包括前面的 EmulatedDirectSoundBuffer 也是。我这才知道文件开头的一堆 magic number 是干什么用的。显然我没有自己写驱动水平。 <ul><li>所以如果不写驱动，那么需要 hook 的函数就不能是这些，这些函数是用于创建驱动用的。需要 hook 的应该是 <code>IDirectSoundBuffer::Lock/Unlock/SetFrequency</code> 等。</li></ul></li><li>往细想下去就更不得了了：学它直接操作 tick 可能并不能实现不变调加速。或许我听到的 Hourglass 的音频加速只是破碎的 buffer 拼成的音频；10 倍速下确实听不出音频究竟还是否完整。</li></ul></li></ul><p>而起初我并没有发现这些问题，我先写了点操作 buffer 的代码……</p><h3 id="rust" tabindex="-1"><a class="header-anchor" href="#rust"><span>rust</span></a></h3><p>我不想碰 C++（即使已有代码作参考），先用 rust 碰碰壁再说。</p><p>试了一下 <a href="https://github.com/darfink/detour-rs" target="_blank" rel="noopener noreferrer">detour-rs</a>，一个 detour 的 rs 实现，但是拉下来发现编译不过。issue 看到了一个 fork 解决了这个问题，才发觉 detour-rs 已经断更三年了。所以使用此 fork 版本的 <a href="https://github.com/Hpmason/retour-rs" target="_blank" rel="noopener noreferrer">retour-rs</a>。fork 版的文档也更详细，我用它的 example 配合文档推荐的 <a href="https://crates.io/crates/dll-syringe" target="_blank" rel="noopener noreferrer">dll-syringe</a> 跑了一下，成功注入了 MessageBoxW，完成了新手教程。</p><p>但接下来才是痛苦开始。<a href="https://rust.audio/" target="_blank" rel="noopener noreferrer">rust 音频处理生态</a>本来就挺烂的。我先尝试的肯定是<a href="https://crates.io/crates/rubato" target="_blank" rel="noopener noreferrer">rubato</a>，毕竟简介就是速率变换。结果这玩意并不咋样，几乎无文档，examples 里面几百行也没有解释。我把 wav 用 python 转成 f64 raw，跑一遍 example 再转回去，并不是一个可用的音频。</p><h3 id="dll-调库" tabindex="-1"><a class="header-anchor" href="#dll-调库"><span>dll 调库</span></a></h3><p>退一万步，如果用现有的 dll 库呢？我尝试了一下行业用得比较多的 <a href="https://codeberg.org/soundtouch/soundtouch.git" target="_blank" rel="noopener noreferrer">soundtouch</a>，<a href="https://gist.github.com/lxl66566/f7dc49be8a08f2746b4179ccd3b2b378" target="_blank" rel="noopener noreferrer">写了个 python 小脚本</a>做测试。soundtouch 的 api 设计就要好得多，用户只需要 put 和 receive 就行了。但是我用 <code>receiveSamples</code> (处理 float 数组) 系列测试就返回值为 0（应该要返回数组长度），数组没有被改动；用 <code>putSamples_i16</code> 系函数（i16 系是 float 系的包装，包了一层转换）甚至有 bug，直接 internal <code>OSError: exception: integer divide by zero</code>。非常郁闷。</p><h3 id="打击" tabindex="-1"><a class="header-anchor" href="#打击"><span>打击</span></a></h3><p>此时我终于读懂了 Hourglass-Resurrection 的代码是自己写 DirectSound 的驱动，并且也发现操作 tick 并不能实现真正的音频加速，最终的道路一定是 buffer。于是我陷入了消沉：做一个音频加速的复杂度已经远超出了我的想象，即使知晓了音频加速原理，也很难面对一大坨 windows sound api。我目前摸索的这些知识在脑子里并不能合到一起。</p><h2 id="二试封包" tabindex="-1"><a class="header-anchor" href="#二试封包"><span>二试封包</span></a></h2><p>转眼过了半年来到 2025，我在推 <em>空に刻んだパラレログラム</em> 时看到 xp3 格式的文件，又忍不住想起了拆包封包的思路。由于 xp3 是老牌（20+years）的广泛使用的格式，网上的资料非常多，可谓是帮了大忙。我先尝试用 GARbro 拆包，接着用<a href="https://github.com/awaken1ng/krkr-xp3" target="_blank" rel="noopener noreferrer">网上找的脚本</a>封回去。封完的包比原先的大了十多 MB，心里还是有一些不安的。打开游戏，发现居然可行！！游戏可以读到音频文件！</p><p>于是我激动得立刻开始 LLM 写脚本，用 ffmpeg 加速音频。写完运行，发现脚本解包有问题。我怀疑是这个 krkr-xp3 只支持 xp3 v1，而 galgame 用了 v2 打包。不过无伤大雅，我只需要封包能力即可，所以我利用 GARbro 解包后，改一下脚本，将包封回 xp3 即可。实测可以正常游玩。（详细方法，请点击下方表格中 xp3 展开查看）</p><p>上述操作让我可以倍速语音游玩所有具有 krkr 移植的 galgame，简直不要太爽。</p><p>尝到甜头后，我又开始审视起我仓库中的其他 galgame。下面的表格记录了我的游戏语音加速尝试与心得（时间顺序），可以点击对应条目查看详细内容。</p><p>因为我的每个 galgame 都会折腾一番音频加速，因此也写了不少工具。这些工具可以在我的 <a href="https://github.com/lxl66566" target="_blank" rel="noopener noreferrer">Github profile</a> 下方展开 <em>Galgame tools</em> 查看，下面的表格展开中有的代码里用到的指令就是这些工具。</p><div data-v-715116e9><div class="hint-container" data-v-715116e9 data-v-b518ef9c><div class="speech-bubble" data-v-b518ef9c><!-- 属性的默认值依然保留，但文本可以由父组件传入 --> 点击表格项目可以展开详细内容哦！</div><!--[--><table data-v-715116e9><thead data-v-715116e9><tr data-v-715116e9><!--[--><th data-v-715116e9>游戏名</th><th data-v-715116e9>游戏引擎</th><th data-v-715116e9>存档格式</th><th data-v-715116e9>成功拆包加速</th><!--]--></tr></thead><tbody data-v-715116e9><!--[--><!--[--><tr class="expandable list-item" data-v-16b26848><!--[--><td data-v-715116e9><!--[--><span data-v-715116e9>空に刻んだパラレログラム <br data-v-715116e9></span><span data-v-715116e9>玉响未来 <br data-v-715116e9></span><span data-v-715116e9>NEKOPARA <br data-v-715116e9></span><span data-v-715116e9>春音Alice＊Gram <br data-v-715116e9></span><span data-v-715116e9>白恋SAKURA＊GRAM <!----></span><!--]--></td><td data-v-715116e9>krkr</td><td data-v-715116e9>xp3</td><td data-v-715116e9>✅</td><!--]--></tr><!----><!--]--><!--[--><tr class="expandable list-item" data-v-16b26848><!--[--><td data-v-715116e9><!--[--><span data-v-715116e9>心之形心之色心之声 <br data-v-715116e9></span><span data-v-715116e9>Deep One <!----></span><!--]--></td><td data-v-715116e9>krkr</td><td data-v-715116e9>xp3(encrypted)</td><td data-v-715116e9>✅</td><!--]--></tr><!----><!--]--><!--[--><tr class="expandable list-item" data-v-16b26848><!--[--><td data-v-715116e9><!--[--><span data-v-715116e9>樱之刻 <br data-v-715116e9></span><span data-v-715116e9>FLIP * FLOP 系列 <br data-v-715116e9></span><span data-v-715116e9>终之空Remake <br data-v-715116e9></span><span data-v-715116e9>流星·世界演绎者 系列 <!----></span><!--]--></td><td data-v-715116e9>Artemis Engine</td><td data-v-715116e9>pfs</td><td data-v-715116e9>✅</td><!--]--></tr><!----><!--]--><!--[--><tr class="expandable list-item" data-v-16b26848><!--[--><td data-v-715116e9><!--[--><span data-v-715116e9>五彩斑斓的世界(HD 4K重置版) <br data-v-715116e9></span><span data-v-715116e9>樱花，萌放 <!----></span><!--]--></td><td data-v-715116e9>FVP</td><td data-v-715116e9>bin</td><td data-v-715116e9>✅</td><!--]--></tr><!----><!--]--><!--[--><tr class="expandable list-item" data-v-16b26848><!--[--><td data-v-715116e9><!--[--><span data-v-715116e9>魔法使之夜(remake, steam) <!----></span><!--]--></td><td data-v-715116e9></td><td data-v-715116e9>hfa</td><td data-v-715116e9>❌</td><!--]--></tr><!----><!--]--><!--[--><tr class="expandable list-item" data-v-16b26848><!--[--><td data-v-715116e9><!--[--><span data-v-715116e9>アンレス テルミナリア <br data-v-715116e9></span><span data-v-715116e9>猫忍えくすはーと 全系列 <!----></span><!--]--></td><td data-v-715116e9>Yu-Ris</td><td data-v-715116e9>ypf</td><td data-v-715116e9>✅</td><!--]--></tr><!----><!--]--><!--[--><tr class="expandable list-item" data-v-16b26848><!--[--><td data-v-715116e9><!--[--><span data-v-715116e9>廢村少女~誘惑迷離的籠之鄉~ <br data-v-715116e9></span><span data-v-715116e9>戦巫＜センナギ＞ ―穢れた契りと神ころも― <!----></span><!--]--></td><td data-v-715116e9>escude</td><td data-v-715116e9>bin</td><td data-v-715116e9>✅</td><!--]--></tr><!----><!--]--><!--[--><tr class="expandable list-item" data-v-16b26848><!--[--><td data-v-715116e9><!--[--><span data-v-715116e9>旭光のマリアージュ <!----></span><!--]--></td><td data-v-715116e9>unity</td><td data-v-715116e9>dat</td><td data-v-715116e9>✅</td><!--]--></tr><!----><!--]--><!--[--><tr class="expandable list-item" data-v-16b26848><!--[--><td data-v-715116e9><!--[--><span data-v-715116e9>千の刃涛、桃花染の皇姫 <br data-v-715116e9></span><span data-v-715116e9>ジュエリー・ハーツ・アカデミア <br data-v-715116e9></span><span data-v-715116e9>大图书馆的牧羊人 <br data-v-715116e9></span><span data-v-715116e9>大图书馆的牧羊人 -Dreaming Sheep- <!----></span><!--]--></td><td data-v-715116e9>bgi</td><td data-v-715116e9>arc</td><td data-v-715116e9>✅</td><!--]--></tr><!----><!--]--><!--[--><tr class="expandable list-item" data-v-16b26848><!--[--><td data-v-715116e9><!--[--><span data-v-715116e9>きまぐれテンプテーション <br data-v-715116e9></span><span data-v-715116e9>Butterfly Seeker <br data-v-715116e9></span><span data-v-715116e9>ふゆから、くるる。 <!----></span><!--]--></td><td data-v-715116e9>Silky’s engine</td><td data-v-715116e9>arc</td><td data-v-715116e9>✅</td><!--]--></tr><!----><!--]--><!--[--><tr class="expandable list-item" data-v-16b26848><!--[--><td data-v-715116e9><!--[--><span data-v-715116e9>想要传达给你的爱恋 <br data-v-715116e9></span><span data-v-715116e9>神明的选择！老师超适合当女孩子！ <!----></span><!--]--></td><td data-v-715116e9>SOFTPAL ADV SYSTEM</td><td data-v-715116e9>pac</td><td data-v-715116e9>✅</td><!--]--></tr><!----><!--]--><!--[--><tr class="expandable list-item" data-v-16b26848><!--[--><td data-v-715116e9><!--[--><span data-v-715116e9>装甲恶鬼村正 <!----></span><!--]--></td><td data-v-715116e9>Nitro+</td><td data-v-715116e9>npa</td><td data-v-715116e9>✅</td><!--]--></tr><!----><!--]--><!--[--><tr class="expandable list-item" data-v-16b26848><!--[--><td data-v-715116e9><!--[--><span data-v-715116e9>まほ×ろば -Witches spiritual home- <!----></span><!--]--></td><td data-v-715116e9>Yaneurao</td><td data-v-715116e9>dat</td><td data-v-715116e9>❌</td><!--]--></tr><!----><!--]--><!--[--><tr class="expandable list-item" data-v-16b26848><!--[--><td data-v-715116e9><!--[--><span data-v-715116e9>無限煉姦～恥辱にまみれし不死姫の輪舞～ <!----></span><!--]--></td><td data-v-715116e9>LC-ScriptEngine</td><td data-v-715116e9>lst,_</td><td data-v-715116e9>✅</td><!--]--></tr><!----><!--]--><!--[--><tr class="expandable list-item" data-v-16b26848><!--[--><td data-v-715116e9><!--[--><span data-v-715116e9>白昼夢の青写真 <br data-v-715116e9></span><span data-v-715116e9>ISLAND <!----></span><!--]--></td><td data-v-715116e9>CatSystem2</td><td data-v-715116e9>int</td><td data-v-715116e9>✅</td><!--]--></tr><!----><!--]--><!--[--><tr class="expandable list-item" data-v-16b26848><!--[--><td data-v-715116e9><!--[--><span data-v-715116e9>美少女万华镜 1-5 <!----></span><!--]--></td><td data-v-715116e9>QLIE</td><td data-v-715116e9>pack</td><td data-v-715116e9>✅</td><!--]--></tr><!----><!--]--><!--[--><tr class="expandable list-item" data-v-16b26848><!--[--><td data-v-715116e9><!--[--><span data-v-715116e9>スターライトBLUE～幼なじみで推しの娘が知らないうちに開発されていた～ <!----></span><!--]--></td><td data-v-715116e9>-</td><td data-v-715116e9>aos</td><td data-v-715116e9>✅</td><!--]--></tr><!----><!--]--><!--[--><tr class="expandable list-item" data-v-16b26848><!--[--><td data-v-715116e9><!--[--><span data-v-715116e9>AIR <!----></span><!--]--></td><td data-v-715116e9>AVG32</td><td data-v-715116e9>-,audio:KOE</td><td data-v-715116e9>✅</td><!--]--></tr><!----><!--]--><!--[--><tr class="expandable list-item" data-v-16b26848><!--[--><td data-v-715116e9><!--[--><span data-v-715116e9>传述之魔女 <!----></span><!--]--></td><td data-v-715116e9>TyranoScript:electron</td><td data-v-715116e9>asar</td><td data-v-715116e9>✅</td><!--]--></tr><!----><!--]--><!--[--><tr class="expandable list-item" data-v-16b26848><!--[--><td data-v-715116e9><!--[--><span data-v-715116e9>魔法少女的魔女审判 <!----></span><!--]--></td><td data-v-715116e9>unity2</td><td data-v-715116e9>UnityFS</td><td data-v-715116e9>❌</td><!--]--></tr><!----><!--]--><!--[--><tr class="expandable list-item" data-v-16b26848><!--[--><td data-v-715116e9><!--[--><span data-v-715116e9>恋狱～月狂病～《REBIRTH FHD SIZE EDITION》 <!----></span><!--]--></td><td data-v-715116e9>Luca System</td><td data-v-715116e9>PAK</td><td data-v-715116e9>✅</td><!--]--></tr><!----><!--]--><!--[--><tr class="expandable list-item" data-v-16b26848><!--[--><td data-v-715116e9><!--[--><span data-v-715116e9>CHAOS;HEAD NOAH <!----></span><!--]--></td><td data-v-715116e9>Ren&#39;Py</td><td data-v-715116e9></td><td data-v-715116e9>✅</td><!--]--></tr><!----><!--]--><!--]--></tbody></table><!--]--></div></div><h3 id="二试封包总结" tabindex="-1"><a class="header-anchor" href="#二试封包总结"><span>二试封包总结</span></a></h3><p>二试封包的成功确实给我带来了许多喜悦之情与实用价值。但是仍有一批引擎无法简单地通过这种方式进行加速。在面对它们使尽浑身解数仍无法战胜时，我内心里总有一股深深的无力感。因此我认为 <em>拆包-加速-封包</em> 只是旁门左道，只有注入才是正道。</p><p>不过由于能力不足，在接近一年的时间内，我的研究重心全部放在了解封包上。毕竟这对目前的我来说是唯一能实现语音加速的方法。</p><h2 id="音频-api-hook" tabindex="-1"><a class="header-anchor" href="#音频-api-hook"><span>音频 API hook</span></a></h2><p>公司某些傻逼软件促使我去 hook 它们，这次 hook 经验便成为了此次尝试的契机。</p><p>重新回到 <a href="#pyaudio">pyaudio</a> 章节，当前面临的最主要问题就是没法控制游戏本身往音频缓冲区里写入的速度。那我就想了，如果我使用 hook 注入音频 API，人为调整音频 API 的播放速率（可以通过调整播放 sample rate 达到目的），再用软件处理音高，这不就能实现音频加速了？</p><p>于是立刻开整。由于我 hook 公司软件，使用 rust retour 测试有点问题（字符串的问题），于是我这次使用了 C++。首先 vibe 了一个用 detours 的音频 API 注入 dll，然后再搞一个 injector。过程中发现 xmake 引三方包真的太好用了，之前编译 detours 那些指令可以全部扬掉，直接在 xmake 里 require 就行。于是又用 ftxui 给 injector vibe 了一个 TUI 界面方便选进程。repo: <a href="https://github.com/lxl66566/AudioSpeedHack-inject" target="_blank" rel="noopener noreferrer">AudioSpeedHack(inject)</a>。</p><p>但是回到家测试，实测并不能成功注入音频 API，我也不清楚为啥。我后来又自己搞了一个 debugger，注入音频 API 专门打日志用的，也没有任何输出，不管是游戏还是手写的调 dsound 播放音频的小脚本，都没有打出信息，也就是没有成功 hook 到。感觉还是不熟注入和过于依赖 vibe coding 的锅，但是目前的我也没有这方面的能力。</p><p>关于其他 hook lib：</p><ul><li><a href="https://github.com/stevemk14ebr/PolyHook_2_0" target="_blank" rel="noopener noreferrer">PolyHook2</a>：这货基本没有文档，蒜鸟蒜鸟。</li></ul><h2 id="dll-wrapper-v0" tabindex="-1"><a class="header-anchor" href="#dll-wrapper-v0"><span>dll wrapper V0</span></a></h2><p>沿用之前思路。如果不好 hook 音频，那么就直接改源码，编出一个 dsound wrapper 用会怎么样呢？</p><p>这些音频 API 都是闭源的，但是有一些开源第三方实现可以使用。</p><h3 id="dsound-dll" tabindex="-1"><a class="header-anchor" href="#dsound-dll"><span>dsound.dll</span></a></h3><p>当前有这些常见 dsound wrapper：</p><ul><li><a href="https://github.com/kcat/dsoal" target="_blank" rel="noopener noreferrer">dsoal</a></li><li><a href="https://www.indirectsound.com/" target="_blank" rel="noopener noreferrer">IndirectSound</a></li><li>Creative ALchemy</li></ul><p>它们主要是用来强制开启 windows 环绕声和其他音效的。其中只有 dsoal 是开源的，因此只能选择改它。</p><p><a href="https://github.com/lxl66566/dsoal" target="_blank" rel="noopener noreferrer">fork 了一个 dsoal</a>，<a href="https://github.com/lxl66566/dsoal/commit/3d378aab9bc797e73eae043e1431f11ee2a99bb2?diff=split" target="_blank" rel="noopener noreferrer">改了两个 frequency 值</a>，然后把 <code>dsound.dll</code> 编译出来。项目质量也确实不错，一次编译过，少有的不需要折腾构建的 C++ 项目。</p><p>可能还需要用 <a href="https://github.com/ThreeDeeJay/DSWRP/blob/main/DirectSound%20Wrapper%20Registry%20Patcher.cmd" target="_blank" rel="noopener noreferrer">DSWRP</a>（改注册表的脚本）让游戏可以从同目录加载 <code>dsound.dll</code>。不设可能也行，可以先尝试一下。</p><p>找了一些明确加载 dsound.dll 的游戏，按照 dsoal README 尝试，并没有什么卵用：游戏优先找 <code>C:\Windows\SysWOW64\dsound.dll</code>，强制其优先加载本地（同目录下） dsound.dll 需要把系统的 dll 改名。加载本地 dll 后游戏无法播放音频，也没有观察到 DSOAL_LOGFILE 的创建。</p><p>怀疑是编出来的 dll 有问题，用 dsoul 的 CI 编译了一下，看到出来 Win32 和 Win64 的两个产物，怀疑是游戏调的不是 64 位的 dll 的问题。把 Win32 产物放到游戏文件夹下，打开游戏，发现音频可以播放，速度和音高变为之前的 2 倍！符合预期。</p><p>然后就是编写程序将音高降回去。我先在前文 <a href="#pyaudio">pyaudio</a> 的基础上尝试，使用 librosa 降低音高：</p><div class="language-py line-numbers-mode" data-highlighter="shiki" data-ext="py" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#D19A66;">RATE</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 44100</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">def</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> callback</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#986801;--shiki-light-font-style:inherit;--shiki-dark:#D19A66;--shiki-dark-font-style:italic;">in_data</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#986801;--shiki-light-font-style:inherit;--shiki-dark:#D19A66;--shiki-dark-font-style:italic;"> frame_count</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#986801;--shiki-light-font-style:inherit;--shiki-dark:#D19A66;--shiki-dark-font-style:italic;"> time_info</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#986801;--shiki-light-font-style:inherit;--shiki-dark:#D19A66;--shiki-dark-font-style:italic;"> status</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">):</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    audio_data </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> input_stream.</span><span style="--shiki-light:#383A42;--shiki-dark:#61AFEF;">read</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(frame_count, </span><span style="--shiki-light:#986801;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;">exception_on_overflow</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">False</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    audio_array </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> np.</span><span style="--shiki-light:#383A42;--shiki-dark:#61AFEF;">frombuffer</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(audio_data, </span><span style="--shiki-light:#986801;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;">dtype</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">np.int16)</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    # i16 转 f32</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    audio_float </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> audio_array.</span><span style="--shiki-light:#383A42;--shiki-dark:#61AFEF;">astype</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(np.float32) </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">/</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 32768.0</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    # 使用 librosa 降低一个八度（-12个半音）</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    shifted_audio_float </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> librosa.effects.</span><span style="--shiki-light:#383A42;--shiki-dark:#61AFEF;">pitch_shift</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span></span>
<span class="line"><span style="--shiki-light:#986801;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;">        y</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">audio_float,</span></span>
<span class="line"><span style="--shiki-light:#986801;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;">        sr</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#D19A66;">RATE</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="--shiki-light:#986801;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;">        n_steps</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=-</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">12</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,  </span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 负数表示降低音调，-12个半音即一个八度</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    )</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    # f32 转回 int16</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    shifted_audio_int16 </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (shifted_audio_float </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">*</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 32767</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">).</span><span style="--shiki-light:#383A42;--shiki-dark:#61AFEF;">astype</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(np.int16)</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    # 转换回字节流</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    out_data </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> shifted_audio_int16.</span><span style="--shiki-light:#383A42;--shiki-dark:#61AFEF;">tobytes</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    return</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (out_data, pyaudio.paContinue)</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>音高确实降回去了，加速是完全可行的！！但是在 chunk 之间还是有许多割裂的部分（无声或噪音部分），对于 galgame 游玩体验的影响很大。我也尝试过缓冲区，但是仍然会出现割裂，只能归结于 librosa 降调后的数据点有问题，要么就是性能不够。</p><p>尝试 vibe 调研 + 抽奖一个 RIIR 版本，抽了几次抽到了一个使用 <a href="https://github.com/NathanRoyer/pitch_shift/blob/main/src/lib.rs" target="_blank" rel="noopener noreferrer">pitch_shift</a> 实现的音调降低、没有任何割裂的 rust 版本。这个版本还有一些小问题，比如音频有点失真，但是比起初版音频割裂要好太多了，至少是个能玩的水平了。然后就是调参，我把 pitch_shift 的 <code>WINDOW_DURATION_MS: usize</code> 从 50 调成 18，失真也减缓了很多，这个音质我感觉已经可以接受了。很高兴，去楼下买了手撕鸡吃（午饭 + 晚饭），回来<a href="https://t.me/withabsolutex/2522" target="_blank" rel="noopener noreferrer">发了一篇频道</a>庆祝。</p><p>然后就是漫长的程序优化了。</p><ul><li>我希望这个程序是傻瓜式的，可以帮人自动判断游戏是否调用了 dsound.dll，但是……尝试了下发现挺困难的，静态分析基本没辙，好多汉化组的 patch 可是会 spawn 其他 galgame 进程的。至于动态分析那又是 windows api on rust 那一套，感觉我能写一年，这个优化先放着。</li><li>为了同时支持不同的倍速，我可以提前编好一堆 dll，然后根据用户的选择释放出某一个。这要求这些 dll 在我的二进制里是整体压缩的，否则这个大小我无法接受。当然使用 <a href="https://docs.rs/include_assets/latest/include_assets/" target="_blank" rel="noopener noreferrer">include_assets</a> 是可以，这玩意强调了它是唯一一个做了 solid 压缩并且还支持 zstd 的。但是我又不想把所有 dll 存在 git 里，否则这个 git 仓库的大小我又不能接受；而且 include_assets 也说了它的缺陷是运行时会全部解压到内存……想来想去还是直接全程用 zip 比较好，这样仓库也不会太大，运行时也不需要全部解压。 <ul><li>然而 deflate 字典太小，压缩率实在是太差，被 zstd 和 lzma 爆杀了。想了想，还是用 include_assets 吧。</li></ul></li><li>程序同时支持 cli 和 tui，tui 的话我有思考过要不要用 ratatui 做，后面想想这个可以慢慢来，先用 terminal-menu 糊一个。 <ul><li>糊出来发现还挺好用的，这玩意有对 Vec&lt;&amp;str&gt; 专门做过优化，用起来还不错。</li></ul></li></ul><p>最终糊出了初版的 <a href="https://github.com/lxl66566/AudioSpeedHack/releases/tag/v0.1.0" target="_blank" rel="noopener noreferrer">AudioSpeedHack v0.1.0</a>。不过实际测下来问题还是挺多，详见 issue 与 TODO。</p><h3 id="mmdevapi-dll" tabindex="-1"><a class="header-anchor" href="#mmdevapi-dll"><span>MMDevAPI.dll</span></a></h3><p>于是我把目光投向了 unity 使用的 MMDevAPI.dll 上。这是因为 unity 目前还没有办法通过脚本封包，无法进行 SPEEDUP；而使用 unity 引擎制作的《魔法少女的魔女审判》是我一直很想推的 galgame。</p><p>微软实在是可恶，这个 dll 不像 dsound 有 dsoal，xaudio 有 faudio，它没有现成的 wrapper 源码。经过一番搜索，我决定参考 wine 的 MMDevAPI 进行修改。wine 的源码虽然不能直接编译成 windows x64/x86 dll 无缝替换，但是我可以丢给 LLM 参考和抽奖。我尝试使用 <a href="https://github.com/mavenlin/wrap_dll" target="_blank" rel="noopener noreferrer">wrap_dll</a> 导出 dll wrapper，然后将更改后的源码、所有导出的内容一起喂给 LLM，几轮对话通过编译。</p><p>编出的 dll 拿来测试，但是 unity 始终不会加载同目录下的 MMDevAPI.dll，估计是有什么安全机制。尝试把系统 System32 里的 MMDevAPI.dll 替换掉，打开游戏，成功观察到音频加速！再打开我的音高处理软件，就可以愉快游玩 SPEEDUP 版《魔法少女的魔女审判》了！！</p><p>这对我来说又是一次鼓舞：因为我之前折腾 <a href="#%E4%BA%8C%E8%AF%95%E5%B0%81%E5%8C%85">unity 封包</a>一直受挫，在深刻体会到解封包的局限性和无力感后，能找到一个可行的方向，实在是……意义党逢意义。</p><h3 id="遇到的问题" tabindex="-1"><a class="header-anchor" href="#遇到的问题"><span>遇到的问题</span></a></h3><p>在开发 dll wrapper 的时候也遇到了许多问题，这里记录一下。</p><h4 id="音质下降问题" tabindex="-1"><a class="header-anchor" href="#音质下降问题"><span>音质下降问题</span></a></h4><p>实际测试发现，AudioSpeedHack 每运行 20 分钟左右音质都会大幅下降，人声都带上了“钢管音”，需要重启。</p><p>一开始我想直接一步到位，因为 dll wrapper 的可行性已经确定，而之前阻碍我的一直是 hook 失败而不是加速算法有问题。然后我就尝试 vibe 了一个使用 soundtouch 直接对音频数据进行加速的 dll wrapper，可惜的是其无法正常使用。</p><p>dll wrapper 修改的逻辑不多，应该不是那里面的问题，那就只可能是我的音高降低程序的问题了。审查发现是 pitch_shift 库里的 f32 精度丢失问题，<a href="https://github.com/NathanRoyer/pitch_shift/pull/3" target="_blank" rel="noopener noreferrer">打了个 patch</a>。</p><h4 id="mmdevapi-dll-加载问题" tabindex="-1"><a class="header-anchor" href="#mmdevapi-dll-加载问题"><span>MMDevAPI.dll 加载问题</span></a></h4><p>这个也是老大难了，MMDevAPI 有 windows 系统保护，不会加载当前目录的 dll。</p><p>本来我以为保护在 <code>HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Session Manager\KnownDLLs</code> 里，但是这里面并没有找到。然后我尝试写了一个 hook，hook 掉程序的 LoadLibraryA/W，但是也没用，所以这个 dll 的系统保护涉及到更底层的机制。</p><p>注册表里搜 mmdevapi，搜出几个结果，然后我尝试把它们修改后搬到 HKEY_CURRENT_USER 表里，然后就可以用了。</p><h4 id="dsound-在-2-倍速以上循环播放" tabindex="-1"><a class="header-anchor" href="#dsound-在-2-倍速以上循环播放"><span>dsound 在 2 倍速以上循环播放</span></a></h4><p>使用 dsoal 修改而来的 dsound 会出现 2 倍速以上语音重复播放的问题，某一段 buffer 的语音会被重放，而且倍速越高，重放的频率越大，这几乎肯定是应用的音频数据填充 buffer 的速率不足的原因。查看 OpenAL 代码发现 AL_PITCH 有一个硬性限制：</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">/**</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"> * Source pitch.</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"> * Type:    ALfloat</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"> * Range:   [0.5 - 2.0]</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"> * Default: 1.0</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"> *</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"> * A multiplier for the sample rate of the source&#39;s buffer.</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"> */</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">#define</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> AL_PITCH</span><span style="--shiki-light:#986801;--shiki-dark:#E06C75;">                                 0x</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">1003</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>emmm，难道要我再改 OpenAL 代码吗？</p><p>后来不再基于 OpenAL，直接 hook dsound，结果还是发现有这个问题，原来这是 dsound 本身的限制啊。</p><p>有试过手动降采样，直接硬去掉一半数据点肯定不行，有混叠；用 speex 库做降采样吧，然后发现降采样后程序给的音频数据仍然是以 2.0 速率给出，说明这是一个比直接操作 buffer 还要更底层的限制。那我真没辙了。</p><h4 id="mmdevapi-特定倍速无声" tabindex="-1"><a class="header-anchor" href="#mmdevapi-特定倍速无声"><span>MMDevAPI 特定倍速无声</span></a></h4><p>最初版的 MMDevAPI 在 1.5 和 2.0 倍速下可以正常工作，但是 1.7 或 1.8 倍速就无声了。</p><p>LLM 提出应该是一些小数计算导致采样率没对上。然后增加了四舍五入机制，1.7、1.8 倍速就可以使用了；但是仍然有一些倍速，例如 2.3 倍速仍然无声，可能是程序还有一些问题。</p><p>暂时先放着了，现在全身心投入到 V1 的开发中。</p><h2 id="dll-wrapper-v1" tabindex="-1"><a class="header-anchor" href="#dll-wrapper-v1"><span>dll wrapper V1</span></a></h2><p>V0 已经勉强能用了，比如我用 V0 推完了魔裁，但是问题还是比较大的。</p><p>最大的问题还是音质，即使修了<a href="#%E9%9F%B3%E8%B4%A8%E4%B8%8B%E9%99%8D%E9%97%AE%E9%A2%98">音质下降</a>问题，pitch_shift 还是难担加速重任，其使用的经典相位声码器比较初级，在处理人声时效果较差，表现就是钢管音，我推 gal 基本都无法开外放，只能戴耳机，隔绝环境音拯救一下音质。</p><p>于是我又一次（已经数不清是第几次）将目光投向了 SoundTouch 上。如果我直接拿到 buffer 数据然后用 ST 对原始数据进行不变调加速呢？WSOLA 的效果还是相当值得信任的，毕竟天天解封包然后 ffmpeg 加速也是用的 WSOLA。</p><p>恰逢 Gemini 出了 3 pro，我便乘着 LLM 升级的西风开始了 V1 的迁移工作。</p><h3 id="dsound-dll-1" tabindex="-1"><a class="header-anchor" href="#dsound-dll-1"><span>dsound.dll</span></a></h3><p>由于有了 V0 的 code base，我不必从 0 开始让 LLM 生成，直接把 V0 code 和需求喂给它即可。经过几轮 review 和性能优化，直接成功加速。顺带分析了一下 APP 可能调用的函数，增大 hook 覆盖面，解决掉了 <a href="https://github.com/lxl66566/AudioSpeedHack/issues/3" target="_blank" rel="noopener noreferrer">issue #3</a>。Gemini 3 pro，神！</p><h3 id="mmdevapi-dll-1" tabindex="-1"><a class="header-anchor" href="#mmdevapi-dll-1"><span>MMDevAPI.dll</span></a></h3><p>首先将 dsound.dll 里使用的 SoundTouch 提取成一个单独的 AudioProcessor.h，方便复用。然后如法炮制。但是这次则没有 dsound.dll 那么好的运气了，这样写出的 dll 有两个问题：</p><ol><li>魔裁的背景音乐没问题，但是人声断续</li><li>在 <em>恋狱～月狂病～</em>/<em>ふゆから、くるる。</em> 上均有不同程度的卡顿、音量飘忽不定或静音问题。</li></ol><p>第一个问题好解决，随便尝试了下，给 ST 到声卡加了个缓冲区就解决了，甚至没有正经排查过。（根据后续日志，可以认为原因是 ST 会攒一定数据才会跑一次加速，默认参数 ST 的单次输出数据量可能超出声卡缓冲区大小。）</p><p>第二个问题就太棘手了，搞了好几天都查不出问题；即使给出 log，LLM 也会在几个错误解法上反复横跳。我尝试了很多方向：</p><ul><li>双缓冲，input 侧也放了一个 RingBuf。（后来发现完全没用，SoundTouch 内部已经有缓冲区了，自己会攒一定数据才进行一次加速。）</li><li>修改 input 缓冲的驱动数据量。（也没用，理由同上）</li><li>发现这个问题有点复杂，做个 logger 吧，把 APP 喂音频时，缓冲区状态和声卡状态都打出来。后续还加了更多打印的日志，比如 ST 每次处理的输入和输出量（然后才发现 ST 的工作逻辑）。</li><li>Backpressure 策略，GetCurrentPadding 不能进入“长时间一直返回 0”的循环，否则应用会快速输出数据顶爆 RingBuf。目前的策略是根据 output RingBuf 做二值化。</li><li>当前架构是专门开一个 Worker 线程，其一个职责是把输出缓冲区的数据喂给声卡。Worker 线程处理完数据后，因为系统调度原因实际 sleep 得比较久，硬件缓冲区就会见底导致卡顿。本来 Worker 线程是靠 sleep 处理的，这个精度太差了，16ms 够声卡爆炸好几次了。先优化成 timeBeginPeriod(1)，后来直接改成靠声卡的 event 驱动。</li><li>给 ST 的 output 加了一个写数据到 WAV 的过程用于调试。这时候的音频是连续非卡顿的，但也有高糊、音量不定问题。</li></ul><p>然而所有这些修改都没有解决问题。</p><p>直到我把 ST 的 input 也打到 WAV 里，发现从 input 开始音频就已经不对劲，然后才定位到问题根因：初始化 IAudioClient 时如果使用的是 <code>WAVEFORMATEXTENSIBLE</code> 而非 <code>WAVEFORMATEX</code>，则真正的格式信息存储在扩展部分的 SubFormat 中。当前 AudioProcessor 的格式处理错了，然后跟 ST 对异常响度处理的内部机制混在一起，导致问题不明显。</p><p>问题解决后，再做一下 dsound 兼容、调参平衡延迟和稳定性，就可以投入使用了。<s>立刻开打《ふゆから、くるる。》！不对我怎么还要上班 T_T</s></p><p>回家一测试，AudioSpeedHack 在我硬盘上的所有 18 个 galgame 的加速成功率是 <strong>100%</strong>。然后我还发现新版的 MMDevAPI 真的非常牛逼，只 MMDevAPI.dll 一个就实现了 100% 覆盖率，它就是 WASAPI 的化身。dsound 可有可无，不过可以作为叠加加速的工具，还是有用武之地的。</p><h2 id="番外篇-galgame-语音不中断" tabindex="-1"><a class="header-anchor" href="#番外篇-galgame-语音不中断"><span>番外篇：galgame 语音不中断</span></a></h2><p>做完 SPEEDUP，虽然我个人比较激动，然而发到 B 站和两个 gal 群没啥太大反响（当然也有非常喜欢的，同道中人说是）。gal 群复读道：<em>我更需要语音不中断</em>。于是尝试研究一下。</p><p>MMDevAPI 基本是无法完成这个需求的，因为 MMDevAPI 拿到的一般是游戏软件混音完毕后的音频，无法区分不同段的人声/BGM。而 dsound 时代一般会把混音交给 API，于是我可以在 dsound 内部拿到不同的 buffer，自然也可以区分人声和 BGM 了。</p><p>于是就从 dsound 入手。在开发（vibe）过程随便记录一点：</p><ul><li>基本架构就是把所有音频数据暂存到一个 FIFO 缓冲区里，每个时刻只允许一段音频播放。然后再实现一个 feeder 线程负责把音频喂给声卡。这个没啥问题。</li><li>欺骗游戏速度：这个是我的突发奇想，我完全可以套用之前 SPEEDUP 的成果，欺骗游戏语音播放的进度，让它飞速填满此段语音的缓冲 buffer。这样可以将后一句语音对前一句的影响降低至最小。 <ul><li><strong>只有在 SPEEDUP 状态下才能使用音频长度这个判据。</strong> 这个通常来说是<strong>最准确的判据</strong>。</li></ul></li><li>区分人声和语音： <ul><li>无法通过 DSBPLAY_LOOPING 判断人声，有的引擎会偷懒把所有音频都标上 DSBPLAY_LOOPING。</li><li>无法通过 buffer size 判断人声。有的引擎不管是啥音频都会申请一段固定长度的 buffer。 <ul><li>不过可以通过长度筛掉一部分 SE，SE 太短了。</li></ul></li><li>后来直接通过<a class="route-link" href="/coding/audio.html#%E4%BA%BA%E5%A3%B0%E5%88%A4%E5%AE%9A">音频处理里的人声特征判定</a>去做了。 <ul><li>初级频域分析的效果很差，我决定直接做纯时域分析，包含时长、连续高能量帧、低能量帧比率、动态范围等。</li></ul></li></ul></li><li>如何判断同一语音：每次 Play 判定语音并入队。一般 buffer 可以被 Lock 很多次，但是 Play 一般每段语音只有一次。</li></ul><p>经过一些测试，可以在 <em>ジュエリー・ハーツ・アカデミア</em> 上正常运行了……</p><p>が、事情真的有这么简单吗？当我将逻辑搬到 Artemis 上就出了问题。</p><ul><li>最大的问题其实是 APP 给音频的逻辑，给出的一些语音会在中间插入一段较长的静音，这点也是我 dump WAV 才发现的。我尝试了很多方法都无法解决这个问题，只好在入队时多做一次去 0 的处理。</li></ul><p>然后在 Artemis 上跑通以后，Krkr 又出了问题，而且一个比一个棘手。。。这时候我已经隐约感觉到了，搞语音不中断其实比加速还难。</p><ul><li>krkr 里所有语音、音效都是 0.5s 一个 buffer。如果按照当前做法，把 0.5s 判为 SE 则没有任何效果；把 0.5s 判为语音则每句话只说前 0.5s，并且由于每次点击/鼠标进入按钮/移出按钮都会触发 SE（即使已经把 SE 设为静音），会导致语音被 SE 抢占，延后几秒钟。</li><li>krkr 里 SE 的判定也比较难，之前的时域分析会将其判为 voice；而在 buffer 延长的机制下要通过时长判断 SE 更加困难。</li><li>在 krkr 的场合，SPEEDUP 效果无法达到预期，最多只能进行 2x 播放（这是已知问题，之前 dsound 的加速上限就是 2。）。所以一段 10s 的语音要等 5s 才能播放出来，如果此时跳转下一句就又被切断了。这是无法接受的。</li></ul></div><!----><!----><!----></div><footer class="vp-page-meta"><!----><div class="vp-meta-item git-info"><div class="update-time"><span class="vp-meta-label">最近更新：</span><time class="vp-meta-info" datetime="2025-12-14T02:29:56.000Z" data-allow-mismatch>2025/12/14 02:29</time></div></div></footer><nav class="vp-page-nav"><a class="route-link auto-link prev" href="/articles/yt-dlp.html" aria-label="yt-dlp 使用教程" iconsizing="both"><div class="hint"><span class="arrow start"></span>上一页</div><div class="link"><i class="vp-icon fas fa-download" sizing="height"></i>yt-dlp 使用教程</div></a><!----></nav><div id="comment" class="giscus-wrapper input-top vp-comment" vp-comment style="display:block;"><div style="display: flex;
align-items: center;
justify-content: center;
height: 96px"><span style="--loading-icon: url(&quot;data:image/svg+xml;utf8,%3Csvg xmlns=&#39;http://www.w3.org/2000/svg&#39; preserveAspectRatio=&#39;xMidYMid&#39; viewBox=&#39;25 25 50 50&#39;%3E%3CanimateTransform attributeName=&#39;transform&#39; type=&#39;rotate&#39; dur=&#39;2s&#39; keyTimes=&#39;0;1&#39; repeatCount=&#39;indefinite&#39; values=&#39;0;360&#39;%3E%3C/animateTransform%3E%3Ccircle cx=&#39;50&#39; cy=&#39;50&#39; r=&#39;20&#39; fill=&#39;none&#39; stroke=&#39;currentColor&#39; stroke-width=&#39;4&#39; stroke-linecap=&#39;round&#39;%3E%3Canimate attributeName=&#39;stroke-dasharray&#39; dur=&#39;1.5s&#39; keyTimes=&#39;0;0.5;1&#39; repeatCount=&#39;indefinite&#39; values=&#39;1,200;90,200;1,200&#39;%3E%3C/animate%3E%3Canimate attributeName=&#39;stroke-dashoffset&#39; dur=&#39;1.5s&#39; keyTimes=&#39;0;0.5;1&#39; repeatCount=&#39;indefinite&#39; values=&#39;0;-35px;-125px&#39;%3E%3C/animate%3E%3C/circle%3E%3C/svg%3E&quot;);
--icon-size: 48px;
display: inline-block;
width: var(--icon-size);
height: var(--icon-size);
background-color: currentcolor;
-webkit-mask-image: var(--loading-icon);
mask-image: var(--loading-icon);
"></span></div></div><!----><!--]--></main><!--]--><!--]--><!----></div><!--]--><!--]--><!--[--><!----><!----><!--[--><!--]--><!--]--><!--]--></div>
    <script type="module" src="/assets/app-BD9KDSbJ.js" defer></script>
  </body>
</html>
