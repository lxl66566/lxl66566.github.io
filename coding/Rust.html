<!doctype html>
<html lang="zh-CN" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-rc.20" />
    <meta name="theme" content="VuePress Theme Hope 2.0.0-rc.79" />
    <style>
      :root {
        --vp-c-bg: #fff;
      }

      [data-theme="dark"] {
        --vp-c-bg: #1b1b1f;
      }

      html,
      body {
        background: var(--vp-c-bg);
      }
    </style>
    <script>
      const userMode = localStorage.getItem("vuepress-theme-hope-scheme");
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;

      if (userMode === "dark" || (userMode !== "light" && systemDarkMode)) {
        document.documentElement.setAttribute("data-theme", "dark");
      }
    </script>
    <script type="application/ld+json">{"@context":"https://schema.org","@type":"Article","headline":"Rust","image":[""],"datePublished":"2022-05-04T00:00:00.000Z","dateModified":"2025-08-18T15:21:27.000Z","author":[]}</script><meta property="og:url" content="https://absx.pages.dev/coding/Rust.html"><meta property="og:site_name" content="绝对值_x 的博客"><meta property="og:title" content="Rust"><meta property="og:description" content="Rust 介绍 Rust 是一门系统编程语言，专注于安全，尤其是并发安全，支持函数式和命令式以及泛型等编程范式的多范式语言。Rust 在语法上和 C++类似，但是设计者想要在保证性能的同时提供更好的内存安全。——百度百科 rust 掀起了一股 RIIR (Rewrite it in Rust) 的热潮。 Awesome Alternatives in ..."><meta property="og:type" content="article"><meta property="og:locale" content="zh-CN"><meta property="og:updated_time" content="2025-08-18T15:21:27.000Z"><meta property="article:tag" content="编程语言"><meta property="article:published_time" content="2022-05-04T00:00:00.000Z"><meta property="article:modified_time" content="2025-08-18T15:21:27.000Z"><link rel="alternate" type="application/rss+xml" href="https://absx.pages.dev/rss.xml" title="绝对值_x 的博客 RSS Feed"><title>Rust | 绝对值_x 的博客</title><meta name="description" content="Rust 介绍 Rust 是一门系统编程语言，专注于安全，尤其是并发安全，支持函数式和命令式以及泛型等编程范式的多范式语言。Rust 在语法上和 C++类似，但是设计者想要在保证性能的同时提供更好的内存安全。——百度百科 rust 掀起了一股 RIIR (Rewrite it in Rust) 的热潮。 Awesome Alternatives in ...">
    <link rel="preload" href="/assets/style-CjBjj1cX.css" as="style"><link rel="stylesheet" href="/assets/style-CjBjj1cX.css">
    <link rel="modulepreload" href="/assets/app-BNA6FKU6.js"><link rel="modulepreload" href="/assets/Rust.html-nFnEsZ0z.js">
    
  </head>
  <body>
    <div id="app"><!--[--><!--[--><!--[--><span tabindex="-1"></span><a href="#main-content" class="vp-skip-link sr-only">跳至主要內容</a><!--]--><!--[--><div class="theme-container external-link-icon pure has-toc" vp-container><!--[--><header id="navbar" class="vp-navbar" vp-navbar><div class="vp-navbar-start"><button type="button" class="vp-toggle-sidebar-button" title="Toggle Sidebar"><span class="icon"></span></button><!--[--><a class="route-link vp-brand" href="/" aria-label="带我回家"><img class="vp-nav-logo" src="/logo.jpg" alt><!----><span class="vp-site-name hide-in-pad">绝对值_x 的博客</span></a><!--]--></div><div class="vp-navbar-center"><!--[--><nav class="vp-nav-links"><div class="vp-nav-item hide-in-mobile"><a class="route-link route-link-active auto-link" href="/coding/" aria-label="编程" iconsizing="height"><!--[--><i class="vp-icon fas fa-code" sizing="height"></i><!--]-->编程<!----></a></div><div class="vp-nav-item hide-in-mobile"><div class="vp-dropdown-wrapper"><button type="button" class="vp-dropdown-title" aria-label="爱好"><!--[--><i class="vp-icon fas fa-heart" sizing="height"></i>爱好<!--]--><span class="arrow"></span><ul class="vp-dropdown"><li class="vp-dropdown-item"><h4 class="vp-dropdown-subtitle">游戏</h4><ul class="vp-dropdown-subitems"><li class="vp-dropdown-subitem"><a class="route-link auto-link" href="/hobbies/galgame.html" aria-label="galgame" iconsizing="both"><!--[--><i class="vp-icon fas fa-plane fa-fw" sizing="both"></i><!--]-->galgame<!----></a></li><li class="vp-dropdown-subitem"><a class="route-link auto-link" href="/hobbies/rhythm_games.html" aria-label="音游" iconsizing="both"><!--[--><i class="vp-icon fas fa-keyboard fa-fw" sizing="both"></i><!--]-->音游<!----></a></li><li class="vp-dropdown-subitem"><a class="route-link auto-link" href="/hobbies/Minecraft.html" aria-label="我的世界" iconsizing="both"><!--[--><i class="vp-icon fas fa-tree fa-fw" sizing="both"></i><!--]-->我的世界<!----></a></li><li class="vp-dropdown-subitem"><a class="route-link auto-link" href="/hobbies/other_games/" aria-label="其他游戏" iconsizing="both"><!--[--><i class="vp-icon fas fa-gamepad fa-fw" sizing="both"></i><!--]-->其他游戏<!----></a></li></ul></li><li class="vp-dropdown-item"><h4 class="vp-dropdown-subtitle">艺术</h4><ul class="vp-dropdown-subitems"><li class="vp-dropdown-subitem"><a class="route-link auto-link" href="/hobbies/books.html" aria-label="读书" iconsizing="both"><!--[--><i class="vp-icon fas fa-book-open-reader fa-fw" sizing="both"></i><!--]-->读书<!----></a></li><li class="vp-dropdown-subitem"><a class="route-link auto-link" href="/hobbies/anime.html" aria-label="番剧" iconsizing="both"><!--[--><i class="vp-icon fas fa-play fa-fw" sizing="both"></i><!--]-->番剧<!----></a></li><li class="vp-dropdown-subitem"><a class="route-link auto-link" href="/hobbies/art.html" aria-label="其他艺术形式" iconsizing="both"><!--[--><i class="vp-icon fas fa-palette fa-fw" sizing="both"></i><!--]-->其他艺术形式<!----></a></li><li class="vp-dropdown-subitem"><a class="route-link auto-link" href="/hobbies/NSFW/" aria-label="NSFW" iconsizing="both"><!--[--><i class="vp-icon fas fa-h fa-fw" sizing="both"></i><!--]-->NSFW<!----></a></li></ul></li><li class="vp-dropdown-item"><h4 class="vp-dropdown-subtitle">其他</h4><ul class="vp-dropdown-subitems"><li class="vp-dropdown-subitem"><a class="route-link auto-link" href="/hobbies/snack.html" aria-label="零食区" iconsizing="both"><!--[--><i class="vp-icon fas fa-cookie-bite fa-fw" sizing="both"></i><!--]-->零食区<!----></a></li></ul></li></ul></button></div></div><div class="vp-nav-item hide-in-mobile"><div class="vp-dropdown-wrapper"><button type="button" class="vp-dropdown-title" aria-label="杂项"><!--[--><i class="vp-icon fas fa-plus" sizing="height"></i>杂项<!--]--><span class="arrow"></span><ul class="vp-dropdown"><li class="vp-dropdown-item"><a class="route-link auto-link" href="/farraginous/recommend_packages.html" aria-label="软件汇总" iconsizing="both"><!--[--><i class="vp-icon fas fa-cube fa-fw" sizing="both"></i><!--]-->软件汇总<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/farraginous/recommend_websites.html" aria-label="网址汇总" iconsizing="both"><!--[--><i class="vp-icon fas fa-earth-asia fa-fw" sizing="both"></i><!--]-->网址汇总<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/farraginous/college.html" aria-label="校内专栏" iconsizing="both"><!--[--><i class="vp-icon fas fa-graduation-cap fa-fw" sizing="both"></i><!--]-->校内专栏<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/farraginous/reciter.html" aria-label="背词器" iconsizing="both"><!--[--><i class="vp-icon fas fa-eye fa-fw" sizing="both"></i><!--]-->背词器<!----></a></li></ul></button></div></div><div class="vp-nav-item hide-in-mobile"><a class="route-link auto-link" href="/articles/" aria-label="文章" iconsizing="height"><!--[--><i class="vp-icon fas fa-blog" sizing="height"></i><!--]-->文章<!----></a></div><div class="vp-nav-item hide-in-mobile"><a class="route-link auto-link" href="/learning/" aria-label="学习" iconsizing="height"><!--[--><i class="vp-icon fas fa-pen" sizing="height"></i><!--]-->学习<!----></a></div><div class="vp-nav-item hide-in-mobile"><a class="route-link auto-link" href="/gossip/" aria-label="闲聊" iconsizing="height"><!--[--><i class="vp-icon fas fa-comment" sizing="height"></i><!--]-->闲聊<!----></a></div><div class="vp-nav-item hide-in-mobile"><a class="route-link auto-link" href="/essay/" aria-label="随笔" iconsizing="height"><!--[--><i class="vp-icon fas fa-newspaper" sizing="height"></i><!--]-->随笔<!----></a></div><div class="vp-nav-item hide-in-mobile"><a class="route-link auto-link" href="/blog/" aria-label="博客" iconsizing="height"><!--[--><i class="vp-icon fas fa-blog" sizing="height"></i><!--]-->博客<!----></a></div></nav><!--]--></div><div class="vp-navbar-end"><!--[--><div class="vp-nav-item vp-action"><a class="vp-action-link" href="https://github.com/lxl66566/lxl66566.github.io" target="_blank" rel="noopener noreferrer" aria-label="GitHub"><svg xmlns="http://www.w3.org/2000/svg" class="icon github-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="github icon" name="github" style="width:1.25rem;height:1.25rem;vertical-align:middle;"><path d="M511.957 21.333C241.024 21.333 21.333 240.981 21.333 512c0 216.832 140.544 400.725 335.574 465.664 24.49 4.395 32.256-10.07 32.256-23.083 0-11.69.256-44.245 0-85.205-136.448 29.61-164.736-64.64-164.736-64.64-22.315-56.704-54.4-71.765-54.4-71.765-44.587-30.464 3.285-29.824 3.285-29.824 49.195 3.413 75.179 50.517 75.179 50.517 43.776 75.008 114.816 53.333 142.762 40.79 4.523-31.66 17.152-53.377 31.19-65.537-108.971-12.458-223.488-54.485-223.488-242.602 0-53.547 19.114-97.323 50.517-131.67-5.035-12.33-21.93-62.293 4.779-129.834 0 0 41.258-13.184 134.912 50.346a469.803 469.803 0 0 1 122.88-16.554c41.642.213 83.626 5.632 122.88 16.554 93.653-63.488 134.784-50.346 134.784-50.346 26.752 67.541 9.898 117.504 4.864 129.834 31.402 34.347 50.474 78.123 50.474 131.67 0 188.586-114.73 230.016-224.042 242.09 17.578 15.232 33.578 44.672 33.578 90.454v135.85c0 13.142 7.936 27.606 32.854 22.87C862.25 912.597 1002.667 728.747 1002.667 512c0-271.019-219.648-490.667-490.71-490.667z"></path></svg></a></div><div class="nav-item vp-action"><a class="vp-action-link" href="https://t.me/ab5_x" target="_blank" rel="noopener noreferrer" aria-label="telegram"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512" style="width:1.25rem;height:1.25rem;vertical-align:middle;"><path d="M248,8C111.033,8,0,119.033,0,256S111.033,504,248,504,496,392.967,496,256,384.967,8,248,8ZM362.952,176.66c-3.732,39.215-19.881,134.378-28.1,178.3-3.476,18.584-10.322,24.816-16.948,25.425-14.4,1.326-25.338-9.517-39.287-18.661-21.827-14.308-34.158-23.215-55.346-37.177-24.485-16.135-8.612-25,5.342-39.5,3.652-3.793,67.107-61.51,68.335-66.746.153-.655.3-3.1-1.154-4.384s-3.59-.849-5.135-.5q-3.283.746-104.608,69.142-14.845,10.194-26.894,9.934c-8.855-.191-25.888-5.006-38.551-9.123-15.531-5.048-27.875-7.717-26.8-16.291q.84-6.7,18.45-13.7,108.446-47.248,144.628-62.3c68.872-28.647,83.183-33.623,92.511-33.789,2.052-.034,6.639.474,9.61,2.885a10.452,10.452,0,0,1,3.53,6.716A43.765,43.765,0,0,1,362.952,176.66Z" fill="currentColor"></path></svg></a></div><div class="nav-item vp-action"><a class="vp-action-link" href="/rss.xml" target="_blank" rel="noopener noreferrer" aria-label="telegram"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1024 1024" style="width:1.25rem;height:1.25rem;vertical-align:middle;"><path d="M320.16155 831.918c0 70.738-57.344 128.082-128.082 128.082S63.99955 902.656 63.99955 831.918s57.344-128.082 128.082-128.082 128.08 57.346 128.08 128.082z m351.32 94.5c-16.708-309.2-264.37-557.174-573.9-573.9C79.31155 351.53 63.99955 366.21 63.99955 384.506v96.138c0 16.83 12.98 30.944 29.774 32.036 223.664 14.568 402.946 193.404 417.544 417.544 1.094 16.794 15.208 29.774 32.036 29.774h96.138c18.298 0.002 32.978-15.31 31.99-33.58z m288.498 0.576C943.19155 459.354 566.92955 80.89 97.00555 64.02 78.94555 63.372 63.99955 77.962 63.99955 96.032v96.136c0 17.25 13.67 31.29 30.906 31.998 382.358 15.678 689.254 322.632 704.93 704.93 0.706 17.236 14.746 30.906 31.998 30.906h96.136c18.068-0.002 32.658-14.948 32.01-33.008z" fill="currentColor"></path></svg></a></div><div class="vp-nav-item hide-in-mobile"><button type="button" class="vp-color-mode-switch" id="color-mode-switch"><svg xmlns="http://www.w3.org/2000/svg" class="icon auto-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="auto icon" name="auto" style="display:block;"><path d="M512 992C246.92 992 32 777.08 32 512S246.92 32 512 32s480 214.92 480 480-214.92 480-480 480zm0-840c-198.78 0-360 161.22-360 360 0 198.84 161.22 360 360 360s360-161.16 360-360c0-198.78-161.22-360-360-360zm0 660V212c165.72 0 300 134.34 300 300 0 165.72-134.28 300-300 300z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon dark-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="dark icon" name="dark" style="display:none;"><path d="M524.8 938.667h-4.267a439.893 439.893 0 0 1-313.173-134.4 446.293 446.293 0 0 1-11.093-597.334A432.213 432.213 0 0 1 366.933 90.027a42.667 42.667 0 0 1 45.227 9.386 42.667 42.667 0 0 1 10.24 42.667 358.4 358.4 0 0 0 82.773 375.893 361.387 361.387 0 0 0 376.747 82.774 42.667 42.667 0 0 1 54.187 55.04 433.493 433.493 0 0 1-99.84 154.88 438.613 438.613 0 0 1-311.467 128z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon light-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="light icon" name="light" style="display:none;"><path d="M952 552h-80a40 40 0 0 1 0-80h80a40 40 0 0 1 0 80zM801.88 280.08a41 41 0 0 1-57.96-57.96l57.96-58a41.04 41.04 0 0 1 58 58l-58 57.96zM512 752a240 240 0 1 1 0-480 240 240 0 0 1 0 480zm0-560a40 40 0 0 1-40-40V72a40 40 0 0 1 80 0v80a40 40 0 0 1-40 40zm-289.88 88.08-58-57.96a41.04 41.04 0 0 1 58-58l57.96 58a41 41 0 0 1-57.96 57.96zM192 512a40 40 0 0 1-40 40H72a40 40 0 0 1 0-80h80a40 40 0 0 1 40 40zm30.12 231.92a41 41 0 0 1 57.96 57.96l-57.96 58a41.04 41.04 0 0 1-58-58l58-57.96zM512 832a40 40 0 0 1 40 40v80a40 40 0 0 1-80 0v-80a40 40 0 0 1 40-40zm289.88-88.08 58 57.96a41.04 41.04 0 0 1-58 58l-57.96-58a41 41 0 0 1 57.96-57.96z"></path></svg></button></div><!--[--><button type="button" class="slimsearch-button" aria-label="搜索"><svg xmlns="http://www.w3.org/2000/svg" class="icon search-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="search icon"><path d="M192 480a256 256 0 1 1 512 0 256 256 0 0 1-512 0m631.776 362.496-143.2-143.168A318.464 318.464 0 0 0 768 480c0-176.736-143.264-320-320-320S128 303.264 128 480s143.264 320 320 320a318.016 318.016 0 0 0 184.16-58.592l146.336 146.368c12.512 12.48 32.768 12.48 45.28 0 12.48-12.512 12.48-32.768 0-45.28"></path></svg><div class="slimsearch-placeholder">搜索</div><div class="slimsearch-key-hints"><kbd class="slimsearch-key">Ctrl</kbd><kbd class="slimsearch-key">K</kbd></div></button><!--]--><!--]--><button type="button" class="vp-toggle-navbar-button" aria-label="Toggle Navbar" aria-expanded="false" aria-controls="nav-screen"><span><span class="vp-top"></span><span class="vp-middle"></span><span class="vp-bottom"></span></span></button></div></header><!----><!--]--><!----><div class="toggle-sidebar-wrapper"><span class="arrow start"></span></div><aside id="sidebar" class="vp-sidebar" vp-sidebar><!----><ul class="vp-sidebar-links"><li><section class="vp-sidebar-group"><p class="vp-sidebar-header"><!----><span class="vp-sidebar-title">思考</span><!----></p><ul class="vp-sidebar-links"><li><a class="route-link auto-link vp-sidebar-link" href="/coding/philosophy_of_PL.html" aria-label="编程语言哲学胡言乱语" iconsizing="both"><!--[--><i class="vp-icon fas fa-question fa-fw" sizing="both"></i><!--]-->编程语言哲学胡言乱语<!----></a></li></ul></section></li><li><section class="vp-sidebar-group"><p class="vp-sidebar-header active"><!----><span class="vp-sidebar-title">语言</span><!----></p><ul class="vp-sidebar-links"><li><a class="route-link route-link-active auto-link vp-sidebar-link active" href="/coding/Rust.html" aria-label="Rust" iconsizing="both"><!--[--><i class="vp-icon fas fa-brands fa-rust fa-fw" sizing="both"></i><!--]-->Rust<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/coding/Cpp.html" aria-label="C++" iconsizing="both"><!--[--><i class="vp-icon fas fa-code fa-fw" sizing="both"></i><!--]-->C++<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/coding/python.html" aria-label="Python" iconsizing="both"><!--[--><i class="vp-icon fas fa-brands fa-python fa-fw" sizing="both"></i><!--]-->Python<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/coding/shell.html" aria-label="shell script" iconsizing="both"><!--[--><i class="vp-icon fas fa-fish fa-fw" sizing="both"></i><!--]-->shell script<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/coding/java.html" aria-label="Java" iconsizing="both"><!--[--><i class="vp-icon fas fa-brands fa-java fa-fw" sizing="both"></i><!--]-->Java<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/coding/tsjs.html" aria-label="TypeScript" iconsizing="both"><!--[--><i class="vp-icon fas fa-code fa-fw" sizing="both"></i><!--]-->TypeScript<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/coding/lua.html" aria-label="lua" iconsizing="both"><!--[--><i class="vp-icon fas fa-code fa-fw" sizing="both"></i><!--]-->lua<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/coding/csharp.html" aria-label="C#" iconsizing="both"><!--[--><i class="vp-icon fas fa-code fa-fw" sizing="both"></i><!--]-->C#<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/coding/kotlin.html" aria-label="kotlin" iconsizing="both"><!--[--><i class="vp-icon fas fa-code fa-fw" sizing="both"></i><!--]-->kotlin<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/coding/clojure.html" aria-label="Clojure" iconsizing="both"><!--[--><i class="vp-icon fas fa-code fa-fw" sizing="both"></i><!--]-->Clojure<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/coding/octave.html" aria-label="Matlab/Octave" iconsizing="both"><!--[--><i class="vp-icon fas fa-brands fa-octopus-deploy fa-fw" sizing="both"></i><!--]-->Matlab/Octave<!----></a></li></ul></section></li><li><section class="vp-sidebar-group"><p class="vp-sidebar-header"><!----><span class="vp-sidebar-title">工具</span><!----></p><ul class="vp-sidebar-links"><li><a class="route-link auto-link vp-sidebar-link" href="/coding/github.html" aria-label="Github" iconsizing="both"><!--[--><i class="vp-icon fas fa-brands fa-github fa-fw" sizing="both"></i><!--]-->Github<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/coding/Git.html" aria-label="Git" iconsizing="both"><!--[--><i class="vp-icon fas fa-brands fa-git-alt fa-fw" sizing="both"></i><!--]-->Git<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/coding/vscode.html" aria-label="VSCode" iconsizing="both"><!--[--><i class="vp-icon fas fa-file-pen fa-fw" sizing="both"></i><!--]-->VSCode<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/coding/vim.html" aria-label="vim" iconsizing="both"><!--[--><i class="vp-icon fas fa-keyboard fa-fw" sizing="both"></i><!--]-->vim<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/coding/sql.html" aria-label="数据库" iconsizing="both"><!--[--><i class="vp-icon fas fa-database fa-fw" sizing="both"></i><!--]-->数据库<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/coding/container.html" aria-label="容器" iconsizing="both"><!--[--><i class="vp-icon fas fa-box fa-fw" sizing="both"></i><!--]-->容器<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/coding/package_manager.html" aria-label="包管理器" iconsizing="both"><!--[--><i class="vp-icon fas fa-cubes fa-fw" sizing="both"></i><!--]-->包管理器<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/coding/snipets.html" aria-label="snipets" iconsizing="both"><!--[--><i class="vp-icon fas fa-burst fa-fw" sizing="both"></i><!--]-->snipets<!----></a></li></ul></section></li><li><section class="vp-sidebar-group"><p class="vp-sidebar-header"><!----><span class="vp-sidebar-title">前端</span><!----></p><ul class="vp-sidebar-links"><li><a class="route-link auto-link vp-sidebar-link" href="/coding/nodejs.html" aria-label="JS 运行时" iconsizing="both"><!--[--><i class="vp-icon fas fa-brands fa-node-js fa-fw" sizing="both"></i><!--]-->JS 运行时<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/coding/tsjs.html" aria-label="TypeScript" iconsizing="both"><!--[--><i class="vp-icon fas fa-code fa-fw" sizing="both"></i><!--]-->TypeScript<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/coding/css.html" aria-label="CSS" iconsizing="both"><!--[--><i class="vp-icon fas fa-brands fa-css fa-fw" sizing="both"></i><!--]-->CSS<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/coding/html.html" aria-label="html" iconsizing="both"><!--[--><i class="vp-icon fas fa-brands fa-html5 fa-fw" sizing="both"></i><!--]-->html<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/coding/vue.html" aria-label="Vue.js" iconsizing="both"><!--[--><i class="vp-icon fas fa-brands fa-vuejs fa-fw" sizing="both"></i><!--]-->Vue.js<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/coding/react.html" aria-label="React" iconsizing="both"><!--[--><i class="vp-icon fas fa-brands fa-react fa-fw" sizing="both"></i><!--]-->React<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/coding/solidjs.html" aria-label="SolidJS" iconsizing="both"><!--[--><i class="vp-icon fas fa-arrow-up-right-dots fa-fw" sizing="both"></i><!--]-->SolidJS<!----></a></li></ul></section></li><li><section class="vp-sidebar-group"><p class="vp-sidebar-header"><!----><span class="vp-sidebar-title">其他</span><!----></p><ul class="vp-sidebar-links"><li><a class="route-link auto-link vp-sidebar-link" href="/coding/bagu.html" aria-label="八股" iconsizing="both"><!--[--><i class="vp-icon fas fa-book-skull fa-fw" sizing="both"></i><!--]-->八股<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/coding/android.html" aria-label="Android" iconsizing="both"><!--[--><i class="vp-icon fas fa-brands fa-android fa-fw" sizing="both"></i><!--]-->Android<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/coding/algorithm.html" aria-label="算法" iconsizing="both"><!--[--><i class="vp-icon fas fa-wand-sparkles fa-fw" sizing="both"></i><!--]-->算法<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/coding/bot.html" aria-label="bot" iconsizing="both"><!--[--><i class="vp-icon fas fa-brands fa-bots fa-fw" sizing="both"></i><!--]-->bot<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/coding/audio.html" aria-label="音频处理" iconsizing="both"><!--[--><i class="vp-icon fas fa-volume-high fa-fw" sizing="both"></i><!--]-->音频处理<!----></a></li></ul></section></li></ul><!----></aside><!--[--><!--[--><main id="main-content" class="vp-page"><!--[--><!----><!----><nav class="vp-breadcrumb disable"></nav><div class="vp-page-title"><h1><i class="vp-icon fas fa-brands fa-rust" sizing="height"></i>Rust</h1><div class="page-info"><!----><!----><span class="page-date-info" aria-label="写作日期"><svg xmlns="http://www.w3.org/2000/svg" class="icon calendar-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="calendar icon" name="calendar"><path d="M716.4 110.137c0-18.753-14.72-33.473-33.472-33.473-18.753 0-33.473 14.72-33.473 33.473v33.473h66.993v-33.473zm-334.87 0c0-18.753-14.72-33.473-33.473-33.473s-33.52 14.72-33.52 33.473v33.473h66.993v-33.473zm468.81 33.52H716.4v100.465c0 18.753-14.72 33.473-33.472 33.473a33.145 33.145 0 01-33.473-33.473V143.657H381.53v100.465c0 18.753-14.72 33.473-33.473 33.473a33.145 33.145 0 01-33.473-33.473V143.657H180.6A134.314 134.314 0 0046.66 277.595v535.756A134.314 134.314 0 00180.6 947.289h669.74a134.36 134.36 0 00133.94-133.938V277.595a134.314 134.314 0 00-133.94-133.938zm33.473 267.877H147.126a33.145 33.145 0 01-33.473-33.473c0-18.752 14.72-33.473 33.473-33.473h736.687c18.752 0 33.472 14.72 33.472 33.473a33.145 33.145 0 01-33.472 33.473z"></path></svg><span data-allow-mismatch="text">2022年5月4日</span><meta property="datePublished" content="2022-05-04T00:00:00.000Z"></span><!----><span class="page-reading-time-info" aria-label="阅读时间"><svg xmlns="http://www.w3.org/2000/svg" class="icon timer-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="timer icon" name="timer"><path d="M799.387 122.15c4.402-2.978 7.38-7.897 7.38-13.463v-1.165c0-8.933-7.38-16.312-16.312-16.312H256.33c-8.933 0-16.311 7.38-16.311 16.312v1.165c0 5.825 2.977 10.874 7.637 13.592 4.143 194.44 97.22 354.963 220.201 392.763-122.204 37.542-214.893 196.511-220.2 389.397-4.661 5.049-7.638 11.651-7.638 19.03v5.825h566.49v-5.825c0-7.379-2.849-13.981-7.509-18.9-5.049-193.016-97.867-351.985-220.2-389.527 123.24-37.67 216.446-198.453 220.588-392.892zM531.16 450.445v352.632c117.674 1.553 211.787 40.778 211.787 88.676H304.097c0-48.286 95.149-87.382 213.728-88.676V450.445c-93.077-3.107-167.901-81.297-167.901-177.093 0-8.803 6.99-15.793 15.793-15.793 8.803 0 15.794 6.99 15.794 15.793 0 80.261 63.69 145.635 142.01 145.635s142.011-65.374 142.011-145.635c0-8.803 6.99-15.793 15.794-15.793s15.793 6.99 15.793 15.793c0 95.019-73.789 172.82-165.96 177.093z"></path></svg><span>大约 28 分钟</span><meta property="timeRequired" content="PT28M"></span><span class="page-category-info" aria-label="分类"><svg xmlns="http://www.w3.org/2000/svg" class="icon category-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="category icon" name="category"><path d="M148.41 106.992h282.176c22.263 0 40.31 18.048 40.31 40.31V429.48c0 22.263-18.047 40.31-40.31 40.31H148.41c-22.263 0-40.311-18.047-40.311-40.31V147.302c0-22.263 18.048-40.31 40.311-40.31zM147.556 553.478H429.73c22.263 0 40.311 18.048 40.311 40.31v282.176c0 22.263-18.048 40.312-40.31 40.312H147.555c-22.263 0-40.311-18.049-40.311-40.312V593.79c0-22.263 18.048-40.311 40.31-40.311zM593.927 106.992h282.176c22.263 0 40.31 18.048 40.31 40.31V429.48c0 22.263-18.047 40.31-40.31 40.31H593.927c-22.263 0-40.311-18.047-40.311-40.31V147.302c0-22.263 18.048-40.31 40.31-40.31zM730.22 920.502H623.926c-40.925 0-74.22-33.388-74.22-74.425V623.992c0-41.038 33.387-74.424 74.425-74.424h222.085c41.038 0 74.424 33.226 74.424 74.067v114.233c0 10.244-8.304 18.548-18.547 18.548s-18.548-8.304-18.548-18.548V623.635c0-20.388-16.746-36.974-37.33-36.974H624.13c-20.585 0-37.331 16.747-37.331 37.33v222.086c0 20.585 16.654 37.331 37.126 37.331H730.22c10.243 0 18.547 8.304 18.547 18.547 0 10.244-8.304 18.547-18.547 18.547z"></path></svg><!--[--><span class="page-category-item clickable" role="navigation">编程</span><!--]--><meta property="articleSection" content="编程"></span><span class="page-tag-info" aria-label="标签"><svg xmlns="http://www.w3.org/2000/svg" class="icon tag-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="tag icon" name="tag"><path d="M939.902 458.563L910.17 144.567c-1.507-16.272-14.465-29.13-30.737-30.737L565.438 84.098h-.402c-3.215 0-5.726 1.005-7.634 2.913l-470.39 470.39a10.004 10.004 0 000 14.164l365.423 365.424c1.909 1.908 4.42 2.913 7.132 2.913s5.223-1.005 7.132-2.913l470.39-470.39c2.01-2.11 3.014-5.023 2.813-8.036zm-240.067-72.121c-35.458 0-64.286-28.828-64.286-64.286s28.828-64.285 64.286-64.285 64.286 28.828 64.286 64.285-28.829 64.286-64.286 64.286z"></path></svg><!--[--><span class="page-tag-item clickable" role="navigation">编程语言</span><!--]--><meta property="keywords" content="编程语言"></span></div><hr></div><!----><div class="" vp-content><!----><div id="markdown-content"><h1 id="rust" tabindex="-1"><a class="header-anchor" href="#rust"><span>Rust</span></a></h1><h2 id="介绍" tabindex="-1"><a class="header-anchor" href="#介绍"><span>介绍</span></a></h2><p>Rust 是一门系统编程语言，专注于安全，尤其是并发安全，支持函数式和命令式以及泛型等编程范式的多范式语言。Rust 在语法上和 C++类似，但是设计者想要在保证性能的同时提供更好的内存安全。——<a href="https://baike.baidu.com/item/Rust%E8%AF%AD%E8%A8%80" target="_blank" rel="noopener noreferrer">百度百科</a></p><p>rust 掀起了一股 RIIR (Rewrite it in Rust) 的热潮。</p><p><a href="https://github.com/TaKO8Ki/awesome-alternatives-in-rust" target="_blank" rel="noopener noreferrer">Awesome Alternatives in Rust</a> | <a href="https://github.com/sts10/rust-command-line-utilities" target="_blank" rel="noopener noreferrer">A curated list of command-line utilities written in Rust</a> 收录了一些 rust 优秀应用。主要是 linux cli 工具。</p><h3 id="为什么推荐" tabindex="-1"><a class="header-anchor" href="#为什么推荐"><span>为什么推荐</span></a></h3><h4 id="优点" tabindex="-1"><a class="header-anchor" href="#优点"><span>优点</span></a></h4><ul><li>高性能（系统级语言）</li><li>安全，生命周期与所有权机制</li><li>开发社区激进，更新频繁，讨论环境良好（tg: <a href="https://t.me/rust_zh" target="_blank" rel="noopener noreferrer">@rust_zh</a>）</li><li>统一的代码格式、文档、测试、打包流程 <ul><li>唯一指定顶级包管理器：cargo</li></ul></li><li>易于打包</li><li>静态检查给力，能过 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>≈</mo></mrow><annotation encoding="application/x-tex">\approx</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4831em;"></span><span class="mrel">≈</span></span></span></span> 能跑</li></ul><h4 id="缺点" tabindex="-1"><a class="header-anchor" href="#缺点"><span>缺点</span></a></h4><ul><li>限制条件多，难以通过编译</li><li>学习曲线陡峭</li><li>开发周期长</li><li>GUI 库有待进步</li><li><a class="route-link" href="/gossip/fuckxxx.html#rust-%E6%9C%89%E5%A4%9A%E9%9A%BE%E7%94%A8">我的其他个人暴论</a></li></ul><h3 id="如何学习" tabindex="-1"><a class="header-anchor" href="#如何学习"><span>如何学习</span></a></h3><p><a href="https://www.rust-lang.org/zh-CN/" target="_blank" rel="noopener noreferrer">官网</a>有详细的 QA 与你所需要的一切。资料方面，rust 的学习资料非常多，列举几个我读过的：<a href="#external">external - book</a></p><ul><li>我在学习初期，先读资料，然后尝试用 Rust 去解 leetcode 上的<sup class="footnote-ref"><a href="#footnote1">[1]</a><a class="footnote-anchor" id="footnote-ref1"></a></sup>题目，看题解以后去<a href="https://doc.rust-lang.org/std/index.html" target="_blank" rel="noopener noreferrer">文档</a>进一步搜关键字和用法。</li><li>中后期就完全在做项目了，遇到不会的就去 <a href="https://t.me/rust_zh" target="_blank" rel="noopener noreferrer">Telegram 群</a>问。</li></ul><p>其他资料：</p><ul><li><a href="https://lib.rs/new" target="_blank" rel="noopener noreferrer">Rust new libraries and applications</a></li></ul><h2 id="开发环境" tabindex="-1"><a class="header-anchor" href="#开发环境"><span>开发环境</span></a></h2><h3 id="安装-rust" tabindex="-1"><a class="header-anchor" href="#安装-rust"><span>安装 rust</span></a></h3><p>rust 的安装与配置并不难。在 windows 上可以使用官方脚本一行安装 rustup 及 rust。linux 也可以选择用包管理器，详见 <a href="https://wiki.archlinuxcn.org/wiki/Rust" target="_blank" rel="noopener noreferrer">Archwiki</a>；但是最为推荐的还是 rustup，毕竟写 rust 会经常换工具链。</p><p>使用 rustup 的好处是支持交叉编译；方便切换 nightly。坏处是不通过包管理器更新，容易忘。</p><h3 id="开发" tabindex="-1"><a class="header-anchor" href="#开发"><span>开发</span></a></h3><p>然后我使用 <a class="route-link" href="/coding/vscode.html">vscode</a> 作为 IDE。安装插件：</p><ul><li><code>rust-analyzer</code>，开发必备</li><li>(optional) <code>Rust Feature Toggler</code>，方便切换 features</li><li>(optional) <s><code>crates</code></s> （已改名为 <code>Dependi</code> <sup class="footnote-ref"><a href="#footnote2">[2]</a><a class="footnote-anchor" id="footnote-ref2"></a></sup>），更好管理依赖版本</li></ul><p>还有一些能够优化开发体验的选项：</p><ol><li><a href="https://code.visualstudio.com/docs/languages/rust#_linting" target="_blank" rel="noopener noreferrer">使用 clippy</a> 作为 check 指令。</li><li>安装<a href="#%E6%89%A9%E5%B1%95">额外的 cargo 组件</a></li><li><s>切换 vscode <code>rust-analyzer</code> 插件为预发布版本</s> 算了，预发布经常出 bug。</li><li>设置 cargo fmt（<a href="https://github.com/lxl66566/git-simple-encrypt/blob/main/rustfmt.toml" target="_blank" rel="noopener noreferrer">我常用的</a>） <ul><li><a href="https://rust-lang.github.io/rustfmt/?version=v1.6.0&amp;search=#wrap_comments" target="_blank" rel="noopener noreferrer">开启注释自动换行</a>。由于其默认不开启且还停留在 unstable（五年啊！），因此需要自行写个 <code>rustfmt.toml</code> 开启。查看 <a href="#cargo">cargo</a> 小节获取更多 rustfmt 信息。</li><li>自动处理与合并 use 句</li></ul></li></ol><h2 id="语言基础" tabindex="-1"><a class="header-anchor" href="#语言基础"><span>语言基础</span></a></h2><h3 id="循环" tabindex="-1"><a class="header-anchor" href="#循环"><span>循环</span></a></h3><p>Rust 的 for 循环需要跟可迭代对象，例如：</p><div class="language-rs line-numbers-mode" data-highlighter="shiki" data-ext="rs" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">for</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> i</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> in</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">..</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">100</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {} </span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">// i in [0,99]</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">for</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> i</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> in</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">..=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">100.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">step_by</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">2</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) {} </span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">// i in { 0,2,4,6...,98,100 }</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>而类似 C++ 的 do while 循环可以写成：</p><div class="language-rs line-numbers-mode" data-highlighter="shiki" data-ext="rs" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">loop</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  // do something</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">  if</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> condition</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> { </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">break</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">; }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>loop 循环还可以 break 出一个值。</p><h3 id="输出" tabindex="-1"><a class="header-anchor" href="#输出"><span><a href="https://doc.rust-lang.org/rust-by-example/hello/print.html" target="_blank" rel="noopener noreferrer">输出</a></span></a></h3><p><code>dbg!()</code> 宏可以在 <code>stderr</code> 中输出调试信息，会消耗所有权。<code>dbg!</code> 返回值就是输入。<code>dbg!</code> 在 release 下也会输出。</p><p><code>ln</code> 代表结束空行。常用的就 <code>print(ln)!</code> <code>eprint(ln)!</code>，没了。<code>print</code> 系列宏不消耗所有权。<code>print!</code> 底层是 <code>write!</code>。</p><h3 id="输入" tabindex="-1"><a class="header-anchor" href="#输入"><span>输入</span></a></h3><p>输入需要使用标准库中的 <code>std::io</code>（或者其他非标准库），输入是各行的字符串，需要手动处理。</p><div class="language-rust line-numbers-mode" data-highlighter="shiki" data-ext="rust" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">use</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> std</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">::io;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">let</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> mut</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> s</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#0184BC;--shiki-dark:#E5C07B;"> String</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">::</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">new</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;">io</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">::</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">stdin</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">().</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">read_line</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(&amp;</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">mut</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> s</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">).</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">expect</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;failed to read&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">let</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> num</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">i32</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> s</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">trim</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">().</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">parse</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">().</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">unwrap</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(); </span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">// 转换类型过程</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="基础数据结构" tabindex="-1"><a class="header-anchor" href="#基础数据结构"><span>基础数据结构</span></a></h3><p><a href="https://skyao.io/learning-rust/docs/grammar/collection.html" target="_blank" rel="noopener noreferrer">这里</a>可能会有一些帮助。</p><ul><li>栈：Vec. 使用 <code>push()</code> &amp; <code>pop()</code> 管理栈。</li><li>（双端）队列：<a href="https://doc.rust-lang.org/std/collections/struct.VecDeque.html" target="_blank" rel="noopener noreferrer"><code>std::collections::VecDeque</code></a></li><li>优先队列（堆）：<a href="https://doc.rust-lang.org/std/collections/struct.BinaryHeap.html" target="_blank" rel="noopener noreferrer"><code>std::collections::BinaryHeap</code></a><ul><li><a href="https://internals.rust-lang.org/t/why-not-use-d-ary-heap-inside-rather-than-binary-heap/18765" target="_blank" rel="noopener noreferrer">Why not use d-ary heap inside rather than binary heap</a>，因此工程实践中可以不用 BinaryHeap。</li></ul></li><li>字典 / Object / map（键值对）：<a href="https://doc.rust-lang.org/std/collections/struct.HashMap.html" target="_blank" rel="noopener noreferrer"><code>std::collections::HashMap</code></a></li><li>链表：<a href="https://doc.rust-lang.org/std/collections/struct.LinkedList.html" target="_blank" rel="noopener noreferrer"><code>std::collections::LinkedList</code></a>，但是其功能在所有权机制下被削弱了（例如，无法删除一个 iter 的值 (safe)）。rust 并不推荐使用链表，如果确实需要完整链表，可以<s>自己写</s>去 <a href="https://crates.io" target="_blank" rel="noopener noreferrer">https://crates.io</a> 多翻翻。<a href="https://jasonkayzk.github.io/2022/02/20/%E4%BD%BF%E7%94%A8Rust%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AA%E5%8F%8C%E5%90%91%E9%93%BE%E8%A1%A8/" target="_blank" rel="noopener noreferrer">对于链表的实现，在 Rust 中有多种方式，比如：（摘自）</a><ul><li>使用 Box 实现（由于 Box 本身的限制，基本只能实现单向链表）；</li><li>使用 Rc + RefCell 实现（由于 RefCell 的限制，迭代器无法很好的实现）；</li><li>使用 Unsafe 实现；</li></ul></li></ul><p>不得不说手写数据结构确实是一个学习 rust 的好方式，自己写一遍，什么 *Cell 什么 Weak 全部都能吃透。</p><h3 id="container" tabindex="-1"><a class="header-anchor" href="#container"><span>container</span></a></h3><ul><li><a href="https://github.com/usagi/rust-memory-container-cs" target="_blank" rel="noopener noreferrer">Rust Memory Container Cheat-sheet</a></li></ul><h3 id="monad" tabindex="-1"><a class="header-anchor" href="#monad"><span>monad</span></a></h3><p>此处特指 <code>Option</code> 与 <code>Result</code> 两种。后面的方法可以不记，实际写到再查（IDE 下拉列表看函数签名）。</p><ul><li>取出值就是 <code>unwrap()</code>，有几个变体。注意会消耗所有权。</li><li>对内部映射，<code>map()</code> &amp; <code>map_err()</code></li><li>后面继续接 monad：<code>and_then()</code></li><li>取出值的引用，可变就 <code>as_mut()</code>，不可变就 <code>as_ref()</code>。 <ul><li>字符串特殊一点，<code>Option&lt;String&gt;</code> 转 <code>Option&lt;&amp;str&gt;</code> 需要 <code>as_deref()</code>。</li></ul></li><li>进阶一点，<code>Option&lt;Option&lt;T&gt;&gt;</code> 可以 <code>flatten()</code>，<code>Option&lt;Result&lt;T, E&gt;&gt;</code> 可以 <code>transpose()</code>，等等。可以读手册。</li></ul><h3 id="字符串" tabindex="-1"><a class="header-anchor" href="#字符串"><span>字符串</span></a></h3><p><em>Rust 的字符串所包含的问题实际上很多，此处只是冰山一角。</em></p><figure style="max-width:calc(0.8 * var(--content-width));" data-v-b469dc56><img alt="Rust string meme" src="/images/coding/rust/string_meme.jpg" loading="lazy" style="max-width:calc(0.8 * var(--content-width));" data-v-b469dc56><figcaption data-v-b469dc56>Rust string meme</figcaption></figure><p>最主要的就是 <code>&amp;str</code> 和 <code>String</code> 两种了，前者没有所有权，后者有。</p><ul><li>Rust 字符串默认支持分行。使用 \ 可以使多行字符串不换行。</li><li>Raw String：<code>r#&quot;\something&quot;#</code></li><li>字符串转换：<code>to_owned()</code> or <code>to_string()</code> converts <code>&amp;str</code> -&gt; <code>String</code>（造了一个所有权）。也可以用 <code>into()</code>，更简单，但是更不直观。</li><li><a href="https://iq.opengenus.org/rust-string-concat/" target="_blank" rel="noopener noreferrer">字符串连接</a></li></ul><h4 id="字符串修改" tabindex="-1"><a class="header-anchor" href="#字符串修改"><span>字符串修改</span></a></h4><p>在 Rust 语言中，字符串采用 utf-8 编码，字符长度不一，因此 Rust 不提供下标查找字符串的方法。这让字符串的修改需要一点点的技巧。</p><ol><li>转换为<code>Vec&lt;char&gt;</code>后修改 C++程序员认为这种方式非常亲切。之后若有需要，还可将<code>Vec&lt;char&gt;</code>重新转换为字符串。注意，Rust 中的 <code>char</code> 为 4 字节，转为 Vec 后，可进行 O(1) 查找。<div class="language-rust line-numbers-mode" data-highlighter="shiki" data-ext="rust" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">let</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> s1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">:</span><span style="--shiki-light:#0184BC;--shiki-dark:#E5C07B;">String</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#0184BC;--shiki-dark:#E5C07B;"> String</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">::</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">from</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;Hello我是绝对值_x&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">let</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> mut</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> a</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> : </span><span style="--shiki-light:#0184BC;--shiki-dark:#E5C07B;">Vec</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">char</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt; </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> s1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">chars</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">().</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">collect</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">a</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">5</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">] </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &#39;你&#39;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">let</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> s2</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> a</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">iter</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">().</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">collect</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">::&lt;</span><span style="--shiki-light:#0184BC;--shiki-dark:#E5C07B;">String</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt;();</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">assert_eq!</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">s2</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;Hello你是绝对值_x&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li>replace_range 函数<div class="language-rust line-numbers-mode" data-highlighter="shiki" data-ext="rust" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">let</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> mut</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> s1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">:</span><span style="--shiki-light:#0184BC;--shiki-dark:#E5C07B;">String</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#0184BC;--shiki-dark:#E5C07B;"> String</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">::</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">from</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;Hello我是绝对值_x&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">s1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">replace_range</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">5</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">..=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">7</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;你&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">assert_eq!</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">s1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;Hello你是绝对值_x&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>请注意，若替换范围不在 utf-8 字符的分割点上将会导致程序抛出 panic，因此不适用于变字节数的未知字符串的替换。</li><li>as_bytes_mut 方法(<strong>unsafe</strong>)<div class="language-rust line-numbers-mode" data-highlighter="shiki" data-ext="rust" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">let</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> mut</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> s1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">:</span><span style="--shiki-light:#0184BC;--shiki-dark:#E5C07B;">String</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#0184BC;--shiki-dark:#E5C07B;"> String</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">::</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">from</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;Hello我是绝对值_x&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">unsafe</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">  let</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> s1_bytes</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: &amp;</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">mut</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> [</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">u8</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">] </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> s1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">as_bytes_mut</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">  let</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> s2_bytes</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: &amp;[</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">u8</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">] </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;你&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">as_bytes</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">  for</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> i</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> in</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">..</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">3</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">{</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">    s1_bytes</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">i</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> + </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">5</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">] </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> s2_bytes</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">i</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">]</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">  }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">assert_eq!</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">s1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;Hello你是绝对值_x&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>该方法异常繁琐，同样也不适用于变字节数的未知字符串的替换，但是若替换范围不在 utf-8 字符的分割点上并不会触发 panic. 例如，将第 6 行代码改为<code>s1_bytes[i + 6] = s2_bytes[i]</code>的运行结果：<div class="language-rust" data-highlighter="shiki" data-ext="rust" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#0184BC;--shiki-dark:#E5C07B;">Hello</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">�你��绝对值_x</span></span></code></pre></div></li></ol><h4 id="其他字符串" tabindex="-1"><a class="header-anchor" href="#其他字符串"><span>其他字符串</span></a></h4><ul><li><code>std::path::{Path, PathBuf}</code> 是路径字符串。<code>Path</code> 没有所有权，<code>PathBuf</code> 有所有权。</li><li><code>url::Url</code> <span class="vp-badge info" style="">url</span> 是 url 字符串。</li></ul><h3 id="语法糖" tabindex="-1"><a class="header-anchor" href="#语法糖"><span>语法糖</span></a></h3><h4 id="问号" tabindex="-1"><a class="header-anchor" href="#问号"><span>问号</span></a></h4><div class="subtitle">——多用问号 人生会轻松很多</div><p>问号用于提前返回错误。<code>do_something_that_might_fail()?</code> 等价于</p><div class="language-rs line-numbers-mode" data-highlighter="shiki" data-ext="rs" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">match</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> do_something_that_might_fail</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">() {</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">  Ok</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">v</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) =&gt; </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">v</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">  Err</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">e</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) =&gt; </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">return</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> Err</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">e</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>问号不能在正常签名的闭包中使用，例如 <code>for_each</code>，<code>map</code> 等的参数。可以用 <code>try_for_each</code>，<code>try_map</code> 等（如果有的话）。</p><p>或者等他娘的 <a href="https://github.com/rust-lang/rust/issues/31436" target="_blank" rel="noopener noreferrer">try_blocks</a> 稳定。</p><h4 id="impl-trait" tabindex="-1"><a class="header-anchor" href="#impl-trait"><span>impl Trait</span></a></h4><p>匿名泛型，可以让你少写点东西。</p><div class="language-rs line-numbers-mode" data-highlighter="shiki" data-ext="rs" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">fn</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> print</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">a</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">impl</span><span style="--shiki-light:#0184BC;--shiki-dark:#E5C07B;"> IntoIterator</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#0184BC;--shiki-dark:#E5C07B;">Item</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> impl</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> fmt</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">::</span><span style="--shiki-light:#0184BC;--shiki-dark:#E5C07B;">Display</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt;) {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">    a</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">into_iter</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">().</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">for_each</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">|</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">s</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">|</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> println!</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;{}&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">s</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">));</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">// equals to:</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">fn</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> print</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#0184BC;--shiki-dark:#E5C07B;">T</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt;(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">a</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#0184BC;--shiki-dark:#E5C07B;">T</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">where</span></span>
<span class="line"><span style="--shiki-light:#0184BC;--shiki-dark:#E5C07B;">    T</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#0184BC;--shiki-dark:#E5C07B;">IntoIterator</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;">    T</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">::</span><span style="--shiki-light:#0184BC;--shiki-dark:#E5C07B;">Item</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;">fmt</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">::</span><span style="--shiki-light:#0184BC;--shiki-dark:#E5C07B;">Display</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">{</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">    a</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">into_iter</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">().</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">for_each</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">|</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">s</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">|</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> println!</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;{}&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">s</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">));</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="并发" tabindex="-1"><a class="header-anchor" href="#并发"><span>并发</span></a></h3><blockquote><p>如果你对 <em>async/await</em> 模型没有明确概念，可以看看<a href="https://course.rs/advance/async/getting-started.html" target="_blank" rel="noopener noreferrer">这篇文章</a>入门。<br> rust 提供 <em>async/await</em> 模型和线程模型。</p></blockquote><h4 id="future" tabindex="-1"><a class="header-anchor" href="#future"><span>Future</span></a></h4><p>每个 async 函数返回的都是一个 <code>Future&lt;Output = ...&gt;</code>。Rust 的 Future 不像其他语言那样创建即执行，而是需要通过 poll 执行并推进。</p><ul><li>手写 Future 要注意，如果返回 <code>Poll::Pending</code>，必需要在前面调一次 wake。</li><li>手动 <code>impl Future for Xxx</code> 比较复杂，要手写状态机，因此如果不是写底层库，一般就 <code>impl Xxx { async fn call() }</code>，虽然调用时不能直接 <code>.await</code> 而需要 <code>.call().await</code>，但是能够极大降低心智负担。</li></ul><h4 id="send-sync" tabindex="-1"><a class="header-anchor" href="#send-sync"><span>Send/Sync</span></a></h4><p>关于 Send/Sync 可以看<a href="https://kaisery.github.io/trpl-zh-cn/ch16-04-extensible-concurrency-sync-and-send.html" target="_blank" rel="noopener noreferrer">这里</a> 或者 <a href="#external">external articles 5.</a>。</p><ul><li>另一个理解是：Send：对象的 &amp;mut 和析构能在别的线程访问；Sync：对象的 &amp; 能在别的线程访问 ——<a href="https://t.me/c/1264662201/571556" target="_blank" rel="noopener noreferrer">包布丁</a></li></ul><p>关于 Wrappers，看这里即可（我想大家应该都看得懂）:</p><table><thead><tr><th>Struct</th><th>Trait</th></tr></thead><tbody><tr><td><code>Box&lt;T&gt;</code></td><td>Send(T) -&gt; Send, Sync(T) -&gt; Sync</td></tr><tr><td><code>Arc&lt;T&gt;</code></td><td>(Send + Sync)(T) -&gt; (Send + Sync)</td></tr><tr><td><code>Mutex&lt;T&gt;</code></td><td>Send(T) -&gt; (Send + Sync)</td></tr><tr><td><code>Rc</code></td><td>!Send + !Sync</td></tr><tr><td><code>Cell&lt;T&gt;</code>, <code>RefCell&lt;T&gt;</code></td><td>Send(T) -&gt; Send, !Sync</td></tr><tr><td><code>RwLock&lt;T&gt;</code></td><td>(Send + Sync)(T) -&gt; (Send + Sync), Send(T) -&gt; Send</td></tr></tbody></table><blockquote><p>此处暂不考虑 allocator.</p></blockquote><p>将这些类型列在一起，可以发现，标准库没有任何包装可以将 <code>!Send</code> 转为 <code>Send</code>。（貌似有一个 crate <a href="https://crates.io/crates/send_wrapper" target="_blank" rel="noopener noreferrer">send_wrapper</a> 可以做到）</p><h4 id="tokio" tabindex="-1"><a class="header-anchor" href="#tokio"><span>tokio</span></a></h4><p>说到并发，目前广泛使用的异步运行时是 tokio。一般 <code>features = [&quot;macros&quot;, &quot;rt&quot;, &quot;rt-multi-thread&quot;]</code> 是必加的。</p><p>关于 tokio 可以看<a href="https://rust-book.junmajinlong.com/ch100/01_understand_tokio_runtime.html" target="_blank" rel="noopener noreferrer">入门秘籍 13 章</a>。</p><ul><li>立即执行 Future 需要用 <code>spawn</code>。否则只会在 await 时执行。</li><li>计算密集型任务请用 <code>spawn_blocking</code>，性能提升巨大。spawn_blocking 的默认最大线程数也是很高的（<a href="https://github.com/tokio-rs/tokio/discussions/3858#discussioncomment-869878" target="_blank" rel="noopener noreferrer">约 512</a>），必要时也可以调小 blocking 池的大小，将任务更合理地分配给 physical thread。 <ul><li>也可以换用 <a href="#rayon">rayon</a>。</li></ul></li><li><code>tokio::fs</code> 比 <code>std::fs</code> 要慢很多（10 倍以上），如果你没有高并发 IO 需求请尽可能用 std::fs。</li></ul><h4 id="简单批处理" tabindex="-1"><a class="header-anchor" href="#简单批处理"><span>简单批处理</span></a></h4><p>在实际并发中经常碰到需要等待一批 Future 结束并获取返回值的情况。<code>join!</code> 不能 join 任意数量；tokio 有一个 <code>JoinSet</code>，但返回值是乱序的，并且 api 设计也不够易用。所以我们如何获取顺序的并行 Future 返回值呢？</p><p>答：用 <code>futures</code> / <code>futures_util</code> crate 的 <code>futures::stream::FuturesUnOrdered</code>。具体使用方法可以参考<a href="https://github.com/tensorlakeai/indexify/blob/5999be8514a4a6595aea72ec790cb526cc5ff0ac/src/blob_storage/disk.rs#L48" target="_blank" rel="noopener noreferrer">用例</a>。一般就是将每一个 task spawn，然后将 handle collect 到 FuturesUnOrdered 里再 <code>while let Some(x) = container.next().await</code> 即可。</p><h3 id="mod" tabindex="-1"><a class="header-anchor" href="#mod"><span>mod</span></a></h3><p>rust 的 mod 确实会让初学者摸不着头脑。建议先搜几篇文章看看，例如<a href="https://zhuanlan.zhihu.com/p/73544030" target="_blank" rel="noopener noreferrer">Rust 模块和文件 - [译]</a>，也可以问 AI。多写几次就完全掌握了。</p><ol><li>每一个 <strong><code>.rs</code> 文件</strong>、<strong><code>mod</code> 块</strong> 和 <strong>带有 <code>mod.rs</code> 的文件夹</strong> 都是模块。</li><li><code>lib.rs</code>（如果不是 lib target 则为 <code>main.rs</code>）是顶层模块(<code>crate</code>)，其他模块层级即为<strong>文件目录层级</strong>。</li><li>整个模块结构是一颗树。 <ul><li>初始时，只有 <code>lib.rs</code> 在模块树内，其他文件都在树外。</li><li>我们需要使用 <code>mod xxx</code> 将模块添加到模块树内。只有在模块树内的模块才会参与编译。</li><li>添加到模块树后，在某个模块使用另一个模块的定义需要用 <code>use xxx</code>。这里的 xxx 可以是模块树中的“绝对路径”（也就是从顶层模块开始查找，<code>crate::sub1::xxx</code>），也可以是“相对路径”（从当前模块开始查找，<code>super::sub2::xxx</code>）。</li></ul></li></ol><h3 id="其他" tabindex="-1"><a class="header-anchor" href="#其他"><span>其他</span></a></h3><ul><li>可以显式调用 <a href="https://kaisery.github.io/trpl-zh-cn/ch15-03-drop.html#%E9%80%9A%E8%BF%87-stdmemdrop-%E6%8F%90%E6%97%A9%E4%B8%A2%E5%BC%83%E5%80%BC" target="_blank" rel="noopener noreferrer"><code>std::mem::drop()</code></a> 释放值，不过一般使用代码块，让变量自动销毁，会更加清晰。<a href="https://xuanwo.io/reports/2022-41/" target="_blank" rel="noopener noreferrer">更多详细解释</a></li><li>不知道结构体多大？rust-analyzer 有选项能直接看，将光标放在结构体上，（vscode 中 Ctrl + Shift + P）选择 <em>view memory layout</em> 即可。</li></ul><h2 id="进阶" tabindex="-1"><a class="header-anchor" href="#进阶"><span>进阶</span></a></h2><h3 id="trait" tabindex="-1"><a class="header-anchor" href="#trait"><span>trait</span></a></h3><p>trait 可谓是 rust 核心，不是 OOP 胜似 OOP(?)，rust 学习的一大难点也是掌握 trait 的用法。</p><ul><li>trait 在一些方面有点像其他语言的 interface，但脱离了继承的限制，可以随时创建，随时 implement，trait 之间不需要有联系。</li><li>trait 可以为现有的结构<strong>附加方法</strong>，这是多数强类型语言所不具备的。</li><li>trait 简化了泛型的实现。（点名 C++ (&lt;20)）</li><li>trait 可以“继承”，指 impl 其他 trait 后才能 impl 这个 trait。最经典的就是 <code>Eq</code> 需要 <code>PartialEq</code>。</li><li>trait 本身也是一个类型，可以 <code>impl trait for trait</code>:<div class="language-rs line-numbers-mode" data-highlighter="shiki" data-ext="rs" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">pub</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> trait</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> Process</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">  fn</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> f</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(&amp;</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">self</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">pub</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> trait</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> Takable</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">  fn</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> take</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(&amp;</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">self</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">impl</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#0184BC;--shiki-dark:#E5C07B;">T</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt; </span><span style="--shiki-light:#0184BC;--shiki-dark:#E5C07B;">Takable</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> for</span><span style="--shiki-light:#0184BC;--shiki-dark:#E5C07B;"> T</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">where</span></span>
<span class="line"><span style="--shiki-light:#0184BC;--shiki-dark:#E5C07B;">  T</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#0184BC;--shiki-dark:#E5C07B;">Process</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">{</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">  fn</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> take</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(&amp;</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">self</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">    self</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">f</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">  }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>但是从其他模块调用 take 时需要 <code>use &lt;mod_name&gt;::Takable</code>。</li></ul></li><li><a href="https://juejin.cn/post/7302359255330504739" target="_blank" rel="noopener noreferrer">TAIT</a>：Trait alias.</li><li>AFIT：Async Functions in Traits，Rust 1.75 实现了这个语法糖，可以直接在 trait 里使用 async 函数，在 1.75 之前需要用 async-traits crate。 <ul><li>但是这并不意味着对于 rust &gt;= 1.75 就可以直接去掉 async-traits，因为 AFIT 的 trait 不能用于创建 dyn object。AFIT 解糖后的结果是 <code>-&gt; impl Future&lt;...&gt;</code>，其返回值大小未知，违反了 dyn object 需要 Object safe 的原则。而 async-traits 宏的输出是 <code>Pin&lt;Box&lt;dyn Future&gt;&gt;</code>，这是大小已知的。</li></ul></li></ul><h3 id="dyn-object" tabindex="-1"><a class="header-anchor" href="#dyn-object"><span>dyn object</span></a></h3><p>一个特殊的对象是 dyn object，表示实现了某个 trait 的任意对象。开销比特定类型对象大一点，但是非常好用。</p><p>一般要求 Sized，所以要么 <code>dyn object + Sized</code>，要么 <code>Box&lt;dyn object&gt;</code>。如果在 struct 内用，经常还需要加生命周期。虽然要求这么多，但是真正用到才发现好用。泛型写一大串不如直接 dyn 秒了。</p><ul><li>dyn 在写异步时非常好用。异步经常需要跟 <code>Pin&lt;Box&lt;T&gt;&gt;</code> 打交道，而我们不能直接从 <code>Pin&lt;Box&lt;T&gt;&gt;</code> 拿到 T，假设变换过程中随便加一个中间结构（例如 <code>std::iter::Map</code>），然后就会变成 <code>Map&lt;Pin&lt;Box&lt;T&gt;&gt;&gt;</code>，如果又要 awaitable 又会转成 <code>Pin&lt;Box&lt;Map&lt;Pin&lt;Box&lt;T&gt;&gt;&gt;&gt;&gt;</code>，套来套去泛型根本没法处理。</li></ul><h3 id="宏" tabindex="-1"><a class="header-anchor" href="#宏"><span>宏</span></a></h3><p>宏是很好用的东西，分为过程宏和声明宏。声明宏简单，常见用来写不定参数的函数/减少重复代码。过程宏就是纯 Token 处理，非常复杂，可以写装饰器。</p><p>学习宏，直接去看<a href="#%E5%A6%82%E4%BD%95%E5%AD%A6%E4%B9%A0">如何学习</a>中提到的小宏书。讲的很好。</p><p>调试宏可以用 <a href="#%E6%89%A9%E5%B1%95">cargo-expand</a>，不需要通过编译就能展开宏。</p><ul><li>不加 <code>#[macro_export]</code> 的话，定义的宏仅在当前 mod 可用。</li><li>在其他宏里调非卫生宏不能直接用，需要加 <code>$crate</code> 显式指定路径。</li><li>可以定义同名宏重载系统宏，但是注意不能在同名宏里调用被重载的系统宏，否则递归。<a href="https://github.com/Xavientois/die/pull/3/files" target="_blank" rel="noopener noreferrer">example</a></li><li><a href="https://docs.rs/safe_arch/latest/safe_arch/#a-note-on-working-with-cfg" target="_blank" rel="noopener noreferrer">A Note On Working With Cfg</a></li><li>有几个标签类型可以被重解释（<code>ident</code>, <code>tt</code> 等），非常强大。</li><li>匹配写不出来就上 <code>$(tt)*</code>，啥都能匹配。但是由于 tt 太强，需要注意边界条件，否则把所有 token 全吃了。</li></ul><h3 id="生命周期" tabindex="-1"><a class="header-anchor" href="#生命周期"><span>生命周期</span></a></h3><p>待续</p><ul><li><a href="https://doc.rust-lang.org/nomicon/subtyping.html#variance" target="_blank" rel="noopener noreferrer">协变逆变速查表</a></li></ul><h2 id="杂谈" tabindex="-1"><a class="header-anchor" href="#杂谈"><span>杂谈</span></a></h2><details class="hint-container details"><summary>嵌入外部资源</summary><p>有时候我们要将外部文件/可执行程序嵌入代码二进制中。<a href="https://crates.io/crates/rust-embed" target="_blank" rel="noopener noreferrer">rust-embed</a> 比较麻烦而且文档不太行，我决定用我自己的方式，带有 zstd 压缩（因为 zstd 解压快，可以尽可能减小运行时开销）。</p><p>引入一个 build-dependencies：</p><div class="language-toml line-numbers-mode" data-highlighter="shiki" data-ext="toml" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">build-dependencies</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">]</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">zstd</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> = </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;0.13&quot;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>然后写 <code>build.rs</code>，编译时将这些文件压缩为 zstd 包：</p><div class="language-rs line-numbers-mode" data-highlighter="shiki" data-ext="rs" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">use</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> std</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">::{env, </span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;">fs</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">::</span><span style="--shiki-light:#0184BC;--shiki-dark:#E5C07B;">File</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;">io</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">::</span><span style="--shiki-light:#0184BC;--shiki-dark:#E5C07B;">Write</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;">path</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">::</span><span style="--shiki-light:#0184BC;--shiki-dark:#E5C07B;">Path</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">};</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">use</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> zstd</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">::</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;">stream</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">::</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;">write</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">::</span><span style="--shiki-light:#0184BC;--shiki-dark:#E5C07B;">Encoder</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">fn</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> main</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">() {</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">    println!</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;cargo:rerun-if-changed=build.rs&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">    println!</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;cargo:rerun-if-changed=dwarfs-0.12.4.exe&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">    println!</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;cargo:rerun-if-changed=winfsp-x64-2.1.25156.dll&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    let</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> out_dir</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> env</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">::</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">var</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;OUT_DIR&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">).</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">unwrap</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    let</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> dest_path</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#0184BC;--shiki-dark:#E5C07B;"> Path</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">::</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">new</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(&amp;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">out_dir</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">).</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">join</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;dwarfs.exe.zst&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">    compress_to</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">include_bytes!</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;dwarfs-0.12.4.exe&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">), </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">dest_path</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    let</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> dest_path</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#0184BC;--shiki-dark:#E5C07B;"> Path</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">::</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">new</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(&amp;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">out_dir</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">).</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">join</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;winfsp-x64.dll.zst&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">    compress_to</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">include_bytes!</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;winfsp-x64-2.1.25156.dll&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">), </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">dest_path</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">fn</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> compress_to</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">input</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: &amp;[</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">u8</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">], </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">output</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">impl</span><span style="--shiki-light:#0184BC;--shiki-dark:#E5C07B;"> AsRef</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#0184BC;--shiki-dark:#E5C07B;">Path</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt;) {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    let</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> f</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#0184BC;--shiki-dark:#E5C07B;"> File</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">::</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">create</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">output</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">).</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">unwrap</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    let</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> mut</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> encoder</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#0184BC;--shiki-dark:#E5C07B;"> Encoder</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">::</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">new</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">f</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">19</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">).</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">unwrap</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">    encoder</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">write_all</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">input</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">).</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">unwrap</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">    encoder</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">finish</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">().</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">unwrap</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在程序中使用宏引入（因为 include_bytes! 必须接受 literal，所以不能用 fn 传入 path）：</p><div class="language-rs line-numbers-mode" data-highlighter="shiki" data-ext="rs" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">/// decompress the prebuilt zst file and write to a temp file.</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">macro_rules!</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> write_prebuilt_zstd</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    ($</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">zst_filename</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">:</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">expr</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, $</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">output_path</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">:</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">expr</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) =&gt; </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">{{
        let compressed_bytes = include_bytes!(concat!(env!(&quot;OUT_DIR&quot;), &quot;/&quot;, $zst_filename));
        let file = std::fs::File::create(&amp;$output_path).expect(&quot;create temp file failed&quot;);
        let mut decoder = zstd::stream::Decoder::new(std::io::Cursor::new(compressed_bytes))
            .expect(&quot;zstd decoder create failed&quot;);
        let mut writer = std::io::BufWriter::new(file);
        std::io::copy(&amp;mut decoder, &amp;mut writer).map(|_| $output_path)
    }}</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">write_prebuilt_zstd!</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;dwarfs.exe.zst&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">my_path</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)?;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这样就可以把嵌入进二进制里的内容解出来了。</p></details><details class="hint-container details"><summary>你不该用 Rust 做...</summary><p>有些东西就是大坑，劝你别往坑里跳。</p><ul><li>音频：虽然有万能解码器 <a href="https://github.com/pdeljanov/Symphonia" target="_blank" rel="noopener noreferrer">Symphonia</a>，但是编码器这块缺的可太多了，除了 wav 这种简单格式有 pure rust 的 hound，大部分编码器都还只有 bindings。</li><li>视频：就连音频都还是那个鸟样，还想要 pure rust 的视频编解码库？洗洗睡吧，老实滚回去用 ffmpeg。</li><li>加密：加密算法太多了！而且依赖于加密领域的专业知识。</li></ul></details><h2 id="cargo" tabindex="-1"><a class="header-anchor" href="#cargo"><span>Cargo</span></a></h2><p>rust 唯一官方指定包管理器：<code>cargo</code>，而且在一众语言包管理中是顶级的。</p><ul><li>cargo 的 dep 版本中，<code>xxx = 1.2.1</code> 指的其实是 <code>&gt;= 1.2.1, &lt;2.0.0</code>，与 npm 中的 <code>^1.2.1</code> 一致。(<a href="https://doc.rust-lang.org/cargo/reference/specifying-dependencies.html#specifying-dependencies-from-cratesio" target="_blank" rel="noopener noreferrer">ref</a>)</li></ul><h3 id="cargo-envs" tabindex="-1"><a class="header-anchor" href="#cargo-envs"><span><a href="https://doc.rust-lang.org/cargo/reference/environment-variables.html" target="_blank" rel="noopener noreferrer">cargo envs</a></span></a></h3><h3 id="常用-cargo-指令" tabindex="-1"><a class="header-anchor" href="#常用-cargo-指令"><span>常用 cargo 指令</span></a></h3><p>太常用的就不说了。</p><ul><li><code>cargo clippy --fix --all-targets --all-features --allow-staged --allow-dirty</code>：用于自动修复 clippy 问题的终极命令。</li><li><code>cargo tree -i xxx</code>：查询某个依赖的路径，弄清引入它的罪魁祸首。</li></ul><h3 id="我的配置" tabindex="-1"><a class="header-anchor" href="#我的配置"><span>我的配置</span></a></h3><p>创建 <code>~/.cargo/config.toml</code> 并写入：</p><div class="language-toml line-numbers-mode" data-highlighter="shiki" data-ext="toml" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 一些好用的 alias</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">alias</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">]</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">b</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> = </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;build --release&quot;</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">c</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> = </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;check&quot;</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">t</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> = </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;test -- --nocapture&quot;</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">r</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> = </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;run&quot;</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">u</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> = </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;update&quot;</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">f</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> = </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;clippy --fix --all-targets --all-features --allow-staged --allow-dirty&quot;</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">i</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> = </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;install --profile installation&quot;</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">bi</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> = </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;binstall -y&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 使用 sccache 缓存编译结果（需要安装 sccache）</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">build</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">]</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">rustc-wrapper</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> = </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;sccache&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 使用 cargo install 使用的命令</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">profile</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">installation</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">]</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">lto</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> = </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">true</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">inherits</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> = </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;release&quot;</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">codegen-units</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> = </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">1</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">rustflags</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> = [</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;-C&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;target-cpu=native&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">]</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 默认不带调试符号，减小编译大小</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">profile</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">dev</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">]</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">debug</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> = </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">false</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>然后由于现在大家都用 CI release，因此 <code>[profile.release]</code> 要写在项目里而不能写全局。</p><h3 id="fmt" tabindex="-1"><a class="header-anchor" href="#fmt"><span>fmt</span></a></h3><p>在 <code>rustfmt.toml</code> 里写代码的格式化选项。我一般会开这些：</p><div class="language-toml line-numbers-mode" data-highlighter="shiki" data-ext="toml" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">group_imports</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">       = </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;StdExternalCrate&quot;</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">imports_granularity</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> = </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;Crate&quot;</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">merge_derives</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">       = </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">true</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">unstable_features</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">   = </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">true</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">wrap_comments</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">       = </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">true</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>懒的话也可以直接抄<a href="https://github.com/compio-rs/winio/blob/master/rustfmt.toml" target="_blank" rel="noopener noreferrer">前辈的</a>。</p><h3 id="构建" tabindex="-1"><a class="header-anchor" href="#构建"><span>构建</span></a></h3><p>cargo build 在全局获取包与依赖的源码，并编译到 target 里。rust 的包构建体积膨胀非常厉害，而且同一份源码的编译产物可能不同<sup class="footnote-ref"><a href="#footnote3">[3]</a><a class="footnote-anchor" id="footnote-ref3"></a></sup>，因此没有全局缓存，还是需要为每个仓库都编出中间产物。</p><p>不过可以试试 <a href="https://github.com/mozilla/sccache/" target="_blank" rel="noopener noreferrer">sccache</a> 全局缓存。</p><h3 id="扩展" tabindex="-1"><a class="header-anchor" href="#扩展"><span>扩展</span></a></h3><p>cargo 扩展跟 git 扩展很像，只要是名为 <code>cargo-xxx</code> 的可执行文件都能视作 cargo 扩展。这些扩展与 cargo 一起组成了整个<strong>优秀的</strong> rust 工具链生态。以下列举一些常用的 cargo 扩展应用。</p><!-- prettier-ignore --><table><thead><tr><th>名字</th><th>简介</th></tr></thead><tbody><tr><td><a href="https://github.com/rust-lang/miri" target="_blank" rel="noopener noreferrer">miri</a></td><td><code>rustup +nightly component add miri</code>，用于更严格的测试，检测内存泄漏与不安全，死锁等</td></tr><tr><td><a href="https://github.com/cargo-bins/cargo-binstall" target="_blank" rel="noopener noreferrer">cargo-binstall</a></td><td>安装 binary，减少从源码编译</td></tr><tr><td><a href="https://github.com/RazrFalcon/cargo-bloat" target="_blank" rel="noopener noreferrer">cargo-bloat</a></td><td>Find out what takes most of the space in your executable.</td></tr><tr><td><a href="https://github.com/dtolnay/cargo-expand" target="_blank" rel="noopener noreferrer">cargo-expand</a></td><td>展开宏</td></tr><tr><td><a href="https://github.com/foresterre/cargo-msrv" target="_blank" rel="noopener noreferrer">cargo-msrv</a></td><td>Find the minimum supported Rust version (MSRV) for your project</td></tr><tr><td><a href="https://github.com/Kobzol/cargo-wizard" target="_blank" rel="noopener noreferrer">cargo-wizard</a></td><td>提供编译模板以配置为最大性能、快速编译时间或最小二进制大小。感觉一般。</td></tr><tr><td><a href="https://github.com/flamegraph-rs/flamegraph" target="_blank" rel="noopener noreferrer">flamegraph</a></td><td>benchmark 火焰图</td></tr><tr><td><a href="https://github.com/rust-lang/cargo-bisect-rustc" target="_blank" rel="noopener noreferrer">cargo-bisect-rustc</a></td><td>二分查找哪个 rustc nightly 版本引入了错误</td></tr><tr><td><a href="https://github.com/Boshen/cargo-shear" target="_blank" rel="noopener noreferrer">cargo-shear</a> / <a href="https://github.com/bnjbvr/cargo-machete" target="_blank" rel="noopener noreferrer">cargo-machete</a></td><td>Remove unused Rust dependencies</td></tr><tr><td><a href="https://github.com/nextest-rs/nextest" target="_blank" rel="noopener noreferrer">cargo-nextest</a></td><td>好用的 test 工具，有超时失败，log 筛选等特性</td></tr><tr><td><a href="https://github.com/RustSec/rustsec/tree/main/cargo-audit" target="_blank" rel="noopener noreferrer">cargo-audit</a></td><td>查依赖漏洞</td></tr><tr><td><a href="https://crates.io/crates/cargo-hakari" target="_blank" rel="noopener noreferrer">cargo-hakari</a></td><td>加速构建的黑科技</td></tr><tr><td><a href="https://github.com/lusingander/cargo-selector" target="_blank" rel="noopener noreferrer">cargo-selector</a></td><td>TUI 快速选择运行目标</td></tr><tr><td><a href="https://github.com/holmgr/cargo-sweep" target="_blank" rel="noopener noreferrer">cargo-sweep</a></td><td>部分清理编译产物</td></tr><tr><td><a href="https://github.com/jplatte/cargo-depgraph" target="_blank" rel="noopener noreferrer">cargo-depgraph</a></td><td>看依赖关系。比 cargo tree 等等好用</td></tr><tr><td><a href="https://github.com/obi1kenobi/cargo-semver-checks" target="_blank" rel="noopener noreferrer">cargo-semver-checks</a></td><td>检查 API 是否遵循 semver 规范</td></tr></tbody></table><h2 id="库" tabindex="-1"><a class="header-anchor" href="#库"><span>库</span></a></h2><h3 id="评价" tabindex="-1"><a class="header-anchor" href="#评价"><span>评价</span></a></h3><p>多看热门项目用的库，是发现好用的库的好方法。还有一个方法是水群。</p><p>有一些库几乎成为业界标准，必需掌握。</p><!-- prettier-ignore --><table><thead><tr><th>库名</th><th>简介</th></tr></thead><tbody><tr><td>anyhow / thiserror</td><td>错误处理，anyhow 用于 bin，thiserror 用于 lib</td></tr><tr><td>tokio</td><td>异步</td></tr><tr><td>serde</td><td>序列化</td></tr><tr><td>reqwest<sup class="footnote-ref"><a href="#footnote4">[4]</a><a class="footnote-anchor" id="footnote-ref4"></a></sup></td><td>简单网络</td></tr><tr><td>clap / palc</td><td>命令行工具，后者是为了减小二进制体积而使用的</td></tr><tr><td>tempfile</td><td>创建自动销毁的临时文件夹</td></tr><tr><td>rayon</td><td>CPU 负载并发</td></tr><tr><td>indicatif</td><td>progress bar</td></tr><tr><td>colored / simply-colored</td><td>命令行颜色输出，后者更适合用于 no_std</td></tr><tr><td>rand / smallrand</td><td>随机数，后者更适合用于 no_std</td></tr></tbody></table><p>另外一些库则是我用过然后觉得好用。</p><!-- prettier-ignore --><table><thead><tr><th>库名</th><th>简介</th></tr></thead><tbody><tr><td>memchr</td><td>字符串查找</td></tr><tr><td>assert2 / pretty_assertions</td><td>全兼容的好看的 assert</td></tr><tr><td><s>die-exit</s></td><td><s>错误处理并退出</s>，不过我现在不用了</td></tr><tr><td>tap</td><td>函数式工具，在链式中途拿取引用操作而不影响返回值</td></tr><tr><td>enum-tools</td><td>提供 enum 的常用方法</td></tr><tr><td>pollster</td><td>小而美，专注于 <em>在同步环境运行异步函数</em> 一件事，打破同步与异步间隔，<strong>强烈推荐</strong></td></tr><tr><td>expect-test</td><td>自动更新 test 中 assert_eq 的期望值</td></tr><tr><td>const-hex</td><td><code>Vec&lt;u8&gt;</code> -&gt; hex str</td></tr><tr><td>constime</td><td>计算编译期值，用一个非常简单易用的宏</td></tr><tr><td>inquire</td><td>用户命令行交互</td></tr><tr><td>samply</td><td>profiler (support flamegraph, <a href="https://www.youtube.com/watch?v=M_EniM_IfnQ&amp;t=210s" target="_blank" rel="noopener noreferrer">tutorial video</a>)</td></tr><tr><td>binrw</td><td>二进制内容的序列化 / 反序列化 <a href="https://www.zhihu.com/question/604594191/answer/3121708902" target="_blank" rel="noopener noreferrer">src</a></td></tr></tbody></table><p><a href="https://blessed.rs/crates" target="_blank" rel="noopener noreferrer">这里</a>还有一个常用库的列表可以参考。</p><p>当然，也有一些<strong>避雷条目一生黑</strong>：</p><!-- prettier-ignore --><table><thead><tr><th>库名</th><th>吐槽</th></tr></thead><tbody><tr><td>teloxide</td><td>Telegram bot 库，但是没有文档，只有一点最简单的 example；遇到各种问题没有解决方法；API 经常 break 并且设计得很丑</td></tr><tr><td>rusqlite</td><td>绑定了 openssl！不要用它，要玩 sqlite 请左转 <a href="#sqlx">sqlx</a></td></tr><tr><td>listeners</td><td>有严重的性能问题 <a href="https://github.com/GyulyVGC/listeners/issues/25" target="_blank" rel="noopener noreferrer">ref</a></td></tr></tbody></table><h3 id="clap" tabindex="-1"><a class="header-anchor" href="#clap"><span>clap</span></a></h3><p>一般我都用 <code>features = [&quot;derive&quot;]</code>，使用更方便，但是文档更难找，因为文档默认用的是动态添加成员。<s><a href="https://github.com/lxl66566/wordinfo/blob/main/src/cli.rs" target="_blank" rel="noopener noreferrer">wordinfo</a> 的 Cli 简直是我的 clap 毕生所学（，折腾了非常久。</s></p><p>clap derive 一般都会将 Cli 实例设为 static LazyLock，可以免去到处传参之苦。带来的问题是写测试变得更加困难，因为不同的测试可能有不同的初始参数，而测试是并发的，没法表达不同的 Cli 状态（而且 LazyLock 的话就是只读了）。所以如果 rust 有一个好用的 context 实践的话就好了。</p><p>我们可能对命令行有更多自定义的验证，这时候最好 impl Cli 添加自定义的 <code>fn validate(&amp;self)</code>，并且在 parse 后调用。不要用 clap 自带的 <code>value_parser</code>，<a href="https://t.me/withabsolutex/2367" target="_blank" rel="noopener noreferrer">那个是一坨大便</a>。</p><h3 id="once-cell" tabindex="-1"><a class="header-anchor" href="#once-cell"><span>once_cell</span></a></h3><p>创建 Lazy 或 OnceCell 的 static 变量。在 rustc 1.80.0 以前这是 unstable，但是现已 stabilized（<code>std::sync::LazyLock</code>）。</p><h3 id="错误处理" tabindex="-1"><a class="header-anchor" href="#错误处理"><span>错误处理</span></a></h3><p>rust 界流传着 <em>bin 用 anyhow，lib 用 thiserror</em> 的谚语。它们两个的目的是完全相反的。一个是细化，一个是归一。</p><ul><li>anyhow 可以将所有错误归为一类往外抛，并且还有额外信息（context）支持。 <ul><li>anyhow 比较“重”，会增大你的二进制大小。如果你不需要用它的一些额外特性（例如 context），也可以 <code>type Result&lt;T&gt; = std::result::Result&lt;T, Box&lt;dyn std::error::Error + Send + Sync&gt;&gt;;</code>。</li></ul></li><li>thiserror 比较轻量，用来细分自定义的 error 类型，可以自动 derive From another error。 <ul><li>不能在两个错误类型中同时 from 同一个 Error。如果确实需要，可能要手动再分 Enum 作为 suberror。</li></ul></li><li>还有一个比较新的竞争者是 snafu，它的目的类似于 thiserror，但是对于需要 context 的错误外抛具有更简便的写法。</li></ul><h3 id="serde" tabindex="-1"><a class="header-anchor" href="#serde"><span>serde</span></a></h3><p>除了直接 derive 外，serde 一般用得多的技巧还有：</p><ul><li><code>#[serde(rename = &quot;xx&quot;)]</code> 和 <code>#[serde(rename_all = &quot;kebab-case&quot;)]</code>，自定义序列化的名称与格式。更多宏可以看<a href="https://serde.rs/field-attrs.html" target="_blank" rel="noopener noreferrer">doc Field attributes</a>。</li><li>对于需要在缺失时使用 empty 的容器对象，<code>#[serde(default)]</code> 是个不错的选择。</li><li>如果有的结构需要手写 parser，可以顺带实现 serialize trait，代码不会太多。</li><li>serde 提供了 <a href="https://serde.rs/remote-derive.html" target="_blank" rel="noopener noreferrer">remote derive</a>，也就是为第三方 crate 里的 struct derive(Serialize, Deserialize)。</li></ul><h3 id="rayon" tabindex="-1"><a class="header-anchor" href="#rayon"><span>rayon</span></a></h3><p>rayon 现在已经几乎统治了 rust CPU 负载型的并发。使用 rayon 可以非常方便地写出多线程程序，榨干你的 CPU，并且无需引用任何异步运行时。</p><p>rayon 的基础示例可以读 doc 或让 AI 给 example，不再赘述。</p><p>rayon 的生态也不错，一个常用的是 indicatif (<code>features = [&quot;rayon&quot;]</code>)，它可以让 rayon 并发处理时显示易于阅读的进度条，这在一般耗时较长的 CPU 负载场景下是非常好用的。</p><div class="language-rust line-numbers-mode" data-highlighter="shiki" data-ext="rust" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">use</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> indicatif</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">::{</span><span style="--shiki-light:#0184BC;--shiki-dark:#E5C07B;">ParallelProgressIterator</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#0184BC;--shiki-dark:#E5C07B;">ProgressBar</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#0184BC;--shiki-dark:#E5C07B;">ProgressStyle</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">};</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">let</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> process_pb</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#0184BC;--shiki-dark:#E5C07B;"> ProgressBar</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">::</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">new</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">files</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">len</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">() </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">as</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> u64</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">process_pb</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">set_style</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;">    ProgressStyle</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">::</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">default_bar</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        .</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">template</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;{spinner:.green} [{elapsed_precise}] [{bar:40.cyan/blue}] {pos}/{len} ({eta}) {msg}&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        .</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">expect</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;Internal Error: Failed to set progress bar style&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        .</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">progress_chars</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;#&gt;-&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">),</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">files</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    .</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">into_par_iter</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    .</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">progress_with</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">process_pb</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">clone</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">())</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    .</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">for_each</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">|</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">entry</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">|</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {...});</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">process_pb</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">finish_with_message</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;Processing complete!&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="sqlx" tabindex="-1"><a class="header-anchor" href="#sqlx"><span>sqlx</span></a></h3><p>如果你写 SQL 比较熟练，不需 ORM，那么 sqlx 就非常适合你。尤其是在当前 Rust 还没有任何特别好用的 ORM 的环境下，sqlx 更是一个不差的选择。</p><p>说到 sqlx 就不得不提，它是强制类型的，因此在编译时就需要获取数据库表信息，例如 sqlite 情况下用户需要为其提供一个模板 sqlite。但是（假设用户没有装 sqlite cli）创建一个 sqlite 本身就需要 sqlx，就遇到了鸡/蛋问题。而且修改 schema.sql 也有可能忘记重新构建模板 sqlite。这时候就要用一个 build.rs 在 schema 初始化或改变时自动更新模板 sqlite。这个 build.rs 我写在了<a href="https://gist.github.com/lxl66566/85de8095cd6644396a901440af2e10f8" target="_blank" rel="noopener noreferrer">这里</a>。</p><h2 id="打包" tabindex="-1"><a class="header-anchor" href="#打包"><span>打包</span></a></h2><p>说到打包就不得不提万恶的 openssl，我已经<a href="https://t.me/withabsolutex/1609" target="_blank" rel="noopener noreferrer">喷了无数次</a>，<a href="https://t.me/withabsolutex/1859" target="_blank" rel="noopener noreferrer">无数次</a>，无数次<sup class="footnote-ref"><a href="#footnote5">[5]</a><a class="footnote-anchor" id="footnote-ref5"></a></sup>…。很多库会提供 rustls feature 来绕过 openssl，例如 reqwest；但是也有库根本不提供，例如 rusqlite。所以 openssl 的问题还是得去解决。</p><h3 id="最小化二进制" tabindex="-1"><a class="header-anchor" href="#最小化二进制"><span><a href="https://github.com/johnthagen/min-sized-rust" target="_blank" rel="noopener noreferrer">最小化二进制</a></span></a></h3><p>一般这样够用了。<s>我虽然敏感，但没有 no-std 那么极端。</s></p><div class="language-toml line-numbers-mode" data-highlighter="shiki" data-ext="toml" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">profile</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">release</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">]</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">strip</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> = </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">true</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">opt-level</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> = </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;z&quot;</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">lto</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> = </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">true</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">panic</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> = </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;abort&quot;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>或者也可以看看 <a href="#%E6%89%A9%E5%B1%95">cargo-wizard</a>。</p><h3 id="交叉编译" tabindex="-1"><a class="header-anchor" href="#交叉编译"><span>交叉编译</span></a></h3><div class="language-sh line-numbers-mode" data-highlighter="shiki" data-ext="sh" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">rustup</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> target</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> add</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> x86_64-unknown-linux-musl</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">cargo</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> build</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> --release</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> --target</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> x86_64-unknown-linux-musl</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>我也写过 <a href="https://github.com/lxl66566/rust-simple-release" target="_blank" rel="noopener noreferrer">rust release CI</a>，深知交叉编译在 link 阶段很容易出问题。解法有两个，一个是用工具链对应的链接器，还有一个就是 cargo-zigbuild，蛮好用的。不过注意，windows 和 macos 不能用 cargo-zigbuild；然后这玩意也经常出问题，要做好心理预期，我也骂了很多次。</p><h3 id="release" tabindex="-1"><a class="header-anchor" href="#release"><span>release</span></a></h3><p>说到 release，我<strong>首推我自己写的 <a href="https://github.com/lxl66566/rust-simple-release" target="_blank" rel="noopener noreferrer">rust simple release</a></strong>，优势是配置非常简单 + hack openssl，可以专注代码而无需折腾 CI。（结果折腾 CI 的变成我了，天天跟 cargo-zigbuild 打）</p><p>再说到我之前用的 <a href="https://github.com/marketplace/actions/build-and-upload-rust-binary-to-github-releases" target="_blank" rel="noopener noreferrer">taiki-e/upload-rust-binary-action</a>，我也用了很久，说句实话还行，但是它内部用的 cross docker container，如果有除了 rust 的其他依赖，或者遇到傻逼 openssl 的问题就没辙了。</p><p><a href="https://github.com/houseabsolute/actions-rust-cross" target="_blank" rel="noopener noreferrer">cross action</a>：使用 docker 容器进行 build，但是不提供压缩产物。</p><h2 id="发布" tabindex="-1"><a class="header-anchor" href="#发布"><span>发布</span></a></h2><p>将包发布到 crates.io 上也是极其方便的。直接 <code>cargo publish</code> 即可。</p><p>不过我不建议使用 CI 进行 publish。<a href="https://t.me/withabsolutex/1827" target="_blank" rel="noopener noreferrer">具体原因</a></p><h2 id="测试" tabindex="-1"><a class="header-anchor" href="#测试"><span>测试</span></a></h2><p>assert 有 <code>assert!()</code> 和 <code>debug_assert!()</code> 之分，前者在 release 下仍然会进行 assert，而后者不会。</p><p><a href="https://github.com/de-vri-es/assert2-rs" target="_blank" rel="noopener noreferrer">assert2</a> 是一个全兼容 assert 的更好看的第三方库，是 <a href="https://crates.io/crates/pretty_assertions" target="_blank" rel="noopener noreferrer">pretty_assertions</a> 进化版。</p><p>关于测试看<a href="https://course.rs/test/write-tests.html" target="_blank" rel="noopener noreferrer">这一篇</a>就够了。小总结/补充：</p><ul><li><code>#[cfg(test)]</code> 指非 test 情况下忽略代码，不会被编译。后面一般接 <code>mod test{ use super::*; ...}</code>。</li><li><code>#[test]</code> 后接函数，名称随意，就是真正的测试函数。</li><li>如果 target 是 bin，则写在 doc 中的测试不会被运行。</li><li><code>cargo test</code> 默认不打印 <em>stdout</em> 输出，想打印需要 <code>cargo test -- --show-output</code>。</li><li>所有的 test 是并行测试的，如果你的程序里有用到 global mutable static 变量/系统外部依赖，请务必注意不同测试之间是否会互相影响。</li><li>测试中常用的库： <ul><li>serial_test：让指定的测试串行运行。</li></ul></li></ul><h2 id="benchmark" tabindex="-1"><a class="header-anchor" href="#benchmark"><span>benchmark</span></a></h2><p>cargo bench 是 rust 自带的 benchmark，但是还在 nightly 阶段。学习可以参考<a href="https://course.rs/test/benchmark.html" target="_blank" rel="noopener noreferrer">这篇文章</a>，讲的不错。</p><p>criterion 是 rust 界最知名的第三方 benchmark 库，它可以在 stable 下使用，并且有更多的功能，例如其默认自带 3s 的 warming up，随机抽样和稳定的耗时，比 cargo bench 好用。不过也有些缺点，例如不能写在文件内部做 unit bench。一个 criterion 的例子：</p><div class="language-rust line-numbers-mode" data-highlighter="shiki" data-ext="rust" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">use</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> criterion</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">::{</span><span style="--shiki-light:#0184BC;--shiki-dark:#E5C07B;">Criterion</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, black_box, criterion_group, criterion_main};</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">use</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> sha2</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">::{</span><span style="--shiki-light:#0184BC;--shiki-dark:#E5C07B;">Digest</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#0184BC;--shiki-dark:#E5C07B;">Sha256</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">};</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">fn</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> bench_md5</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">c</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: &amp;</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">mut</span><span style="--shiki-light:#0184BC;--shiki-dark:#E5C07B;"> Criterion</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    let</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> data</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> b&quot;hello world&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">    c</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">bench_function</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;md5&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">|</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">b</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">|</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">        b</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">iter</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">||</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">            black_box</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;">md5</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">::</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">compute</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">data</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">));</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        })</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    });</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">fn</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> bench_sha256</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">c</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: &amp;</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">mut</span><span style="--shiki-light:#0184BC;--shiki-dark:#E5C07B;"> Criterion</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) {...}</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">criterion_group!</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">benches</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">bench_md5</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">bench_sha256</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">criterion_main!</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">benches</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="用户界面" tabindex="-1"><a class="header-anchor" href="#用户界面"><span>用户界面</span></a></h2><h3 id="gui" tabindex="-1"><a class="header-anchor" href="#gui"><span>GUI</span></a></h3><p>GUI 是 rust 日经问题了。</p><p>一些 GUI 框架：</p><ul><li>tauri：electron 的竞品，据说很灵车（许多群友都说过了）。 <ul><li>2022 年我试了一下，连 example 都跑不过。</li><li>2024 尝试，还不错。主要是前端工具链是 GUI 界最顶级的那一批，爆杀各类原生 UI。</li><li><a href="https://mp.weixin.qq.com/s/UxmJxU4-fv9GeRxl2fzOGw" target="_blank" rel="noopener noreferrer">得物商家客服从 Electron 迁移到 Tauri 的技术实践</a></li><li><a href="https://github.com/yetone/tauri-bug-reproducer" target="_blank" rel="noopener noreferrer">tauri-bug-reproducer</a>，T 黑头子（</li></ul></li><li><a href="https://github.com/emilk/egui" target="_blank" rel="noopener noreferrer">egui</a>：原生 GUI，有<a href="https://www.reddit.com/r/rust/comments/1c69mrj" target="_blank" rel="noopener noreferrer">大项目</a>。 <ul><li><a href="https://t.me/withabsolutex/2203" target="_blank" rel="noopener noreferrer">20250123 我用了一次 egui 0.3.0，太灵车了</a>，建议别用。</li><li>窗口 API，还有布局等等都很差，很多地方还要自己拿 size 算（还有缩放坑），太原始，前端一个 flex 全搞定了。而且 API 变化太大，AI 没法输出有效信息，这也是比较致命的。</li></ul></li><li><a href="https://github.com/slint-ui/slint" target="_blank" rel="noopener noreferrer">slint</a>：嗯写 DSL</li><li><a href="https://github.com/DioxusLabs/dioxus" target="_blank" rel="noopener noreferrer">dioxus</a>：也是嗯写 DSL。release 0.5.0 时火了一把</li><li><a href="https://github.com/gabdube/native-windows-gui" target="_blank" rel="noopener noreferrer">native-windows-gui</a>：非跨平台</li><li><a href="https://github.com/compio-rs/winio" target="_blank" rel="noopener noreferrer">winio</a>：<s>莓软的愚人节玩笑</s></li><li><a href="https://docs.rs/sciter-rs/latest/sciter/" target="_blank" rel="noopener noreferrer">sciter</a>：web 界面渲染</li></ul><p><a href="https://www.cnblogs.com/nolca/p/17795473.html" target="_blank" rel="noopener noreferrer">这里</a>有一些 issue/star 数对比。<a href="https://areweguiyet.com/" target="_blank" rel="noopener noreferrer">Are we GUI Yet?</a>是更多 GUI 框架简介。</p><p>我早期尝试过一下 iced，用不明白，不用了。反正自从我开始<a class="route-link" href="/coding/#%E5%89%8D%E7%AB%AF">写前端</a>后我就不再写其他非前端 GUI 了，实在是太 naive 太难受了。</p><p><em>他们之中有哪个能达到 electron 80% 的可用程度，称为可用。</em></p><div style="text-align:right;"><p>——<em><a href="https://github.com/magic-akari" target="_blank" rel="noopener noreferrer">阿卡琳</a></em></p></div><h3 id="tui" tabindex="-1"><a class="header-anchor" href="#tui"><span>TUI</span></a></h3><p>比起 GUI，rust 重心还是在 CLI 和 TUI 上。</p><h4 id="ratatui" tabindex="-1"><a class="header-anchor" href="#ratatui"><span><a href="https://github.com/ratatui-org/ratatui" target="_blank" rel="noopener noreferrer">ratatui</a></span></a></h4><p>一个广泛使用的 TUI 框架，教程还不错。</p><p>我读源码花了挺久时间。如果只想快速上手，建议狠狠抄<a href="https://github.com/ratatui-org/templates/tree/main/simple-async" target="_blank" rel="noopener noreferrer">这个 example</a>。</p><p>用着发现个 bug，顺带 pr 了几行<sup class="footnote-ref"><a href="#footnote6">[6]</a><a class="footnote-anchor" id="footnote-ref6"></a></sup>。</p><p>然后 <a href="https://github.com/veeso/tui-realm/" target="_blank" rel="noopener noreferrer">tui-realm</a> 是基于其做的一个高层 TUI 框架，或许可以一试。</p><h2 id="嵌入向量数据库" tabindex="-1"><a class="header-anchor" href="#嵌入向量数据库"><span>嵌入向量数据库</span></a></h2><p>我需要 rust 侧的轻量嵌入式向量数据库解决方案，要求是 10,000,000 个向量内查最近邻。（每个向量还有附带额外信息）</p><p>简单看了一下。我不希望将所有数据先加载到内存，最好的方案应该是 <a href="https://www.oschina.net/news/304024" target="_blank" rel="noopener noreferrer">DiskANN</a>，不过这玩意目前还没有 rust 的实现。</p><ul><li><a href="https://github.com/asg017/sqlite-vec" target="_blank" rel="noopener noreferrer">sqlite-vec</a>：sqlite 跨平台扩展，但是现在并不支持最近邻算法。</li></ul><h2 id="r18n" tabindex="-1"><a class="header-anchor" href="#r18n"><span>r18n</span></a></h2><p>去 luoxu <a href="https://luoxu.archlinuxcn.org/#g=1264662201&amp;q=i18n" target="_blank" rel="noopener noreferrer">随便一搜</a>，发现 i18n 模型是个自古以来的难题。</p><p>我也找了一些看，包括 <code>rust-i18n</code>, <code>r18</code>, <code>i18n-embed</code>, <code>fluent-rs</code>，最后还是感觉 <code>rust-i18n</code> 文档清晰，模型简单，比较适合我的项目。</p><h2 id="external" tabindex="-1"><a class="header-anchor" href="#external"><span>external</span></a></h2><p>books:</p><ol><li><a href="https://course.rs/about-book.html" target="_blank" rel="noopener noreferrer">Rust 语言圣经</a>：圣经，文风上乘，质量高。</li><li><a href="https://tourofrust.com/00_zh-cn.html" target="_blank" rel="noopener noreferrer">tour of rust</a>：交互授课式，基础入门。</li><li><a href="https://doc.rust-lang.org/rust-by-example/index.html" target="_blank" rel="noopener noreferrer">rust by example</a>：注重例子。</li><li><a href="https://zjp-cn.github.io/tlborm/introduction.html" target="_blank" rel="noopener noreferrer">小宏书</a>：专门介绍 rust macro</li><li><a href="https://marabos.nl/atomics/" target="_blank" rel="noopener noreferrer">Rust Atomics and Locks</a>：底层并发原理入门</li><li><a href="https://rust-book.junmajinlong.com/about.html" target="_blank" rel="noopener noreferrer">Rust 入门秘籍</a>：一本既简洁又深入的书，非常值得一看（特别是 tokio 相关章节）。</li><li><a href="https://learn.lianglianglee.com/%E4%B8%93%E6%A0%8F/%E9%99%88%E5%A4%A9%20%C2%B7%20Rust%20%E7%BC%96%E7%A8%8B%E7%AC%AC%E4%B8%80%E8%AF%BE/00%20%E5%BC%80%E7%AF%87%E8%AF%8D%20%E8%AE%A9Rust%E6%88%90%E4%B8%BA%E4%BD%A0%E7%9A%84%E4%B8%8B%E4%B8%80%E9%97%A8%E4%B8%BB%E5%8A%9B%E8%AF%AD%E8%A8%80.md" target="_blank" rel="noopener noreferrer">Rust 编程第一课 - 陈天</a>：比较进阶的书，写得很好，着重讲述了难点和实战</li><li><a href="https://github.com/alexpusch/rust-magic-patterns" target="_blank" rel="noopener noreferrer">Rust magic patterns</a>：针对某些狭小的知识点的深入分析</li></ol><p>articles:</p><ol><li><a href="https://silente.top/posts/Rust-Learning-Smart-Pointers/" target="_blank" rel="noopener noreferrer">Rust Learning Smart Pointers</a></li><li><a href="https://nihil.cc/posts/rust_closure_and_y/" target="_blank" rel="noopener noreferrer">Rust 中的闭包递归与 Y 组合子</a></li><li>随机 <a href="https://dtolnay.github.io/rust-quiz/" target="_blank" rel="noopener noreferrer">Rust Quiz - dtolnay</a> / <a href="https://boxyuwu.github.io/rust-quiz/" target="_blank" rel="noopener noreferrer">Rust Quiz - boxyuwu</a>：想成为语言律师吗？</li><li><a href="https://zhuanlan.zhihu.com/p/404818051" target="_blank" rel="noopener noreferrer">为什么 Rust 需要 Pin, Unpin ？（中文翻译）</a></li><li><a href="https://zhuanlan.zhihu.com/p/64699643" target="_blank" rel="noopener noreferrer">如何理解 rust 中的 Sync、Send？</a></li><li><a href="https://folyd.com/blog/rust-pin-unpin/" target="_blank" rel="noopener noreferrer">Rust 的 Pin 与 Unpin</a></li><li><a href="https://rustcc.cn/article?id=d3954670-a58a-427d-9c0c-6666051f5cc7" target="_blank" rel="noopener noreferrer">static, const, let 声明变量有什么区别？</a></li><li><a href="https://www.shuttle.rs/blog/2024/04/18/using-traits-generics-rust" target="_blank" rel="noopener noreferrer">An introduction to advanced Rust traits and generics</a></li><li><a href="https://bingowith.me/2021/05/09/translation-async-what-is-blocking/" target="_blank" rel="noopener noreferrer">[翻译] async: 什么是 blocking</a></li><li><a href="https://www.ihcblog.com/rust-runtime-design-1/" target="_blank" rel="noopener noreferrer">Rust Runtime 设计与实现-科普篇</a> 及后续系列文章</li><li><a href="https://lucumr.pocoo.org/2024/5/16/macro-vtable-magic/" target="_blank" rel="noopener noreferrer">Using Rust Macros for Custom VTables</a>：如何创建一个 runtime object</li><li><a href="https://www.youtube.com/live/P7wLTy59-f0" target="_blank" rel="noopener noreferrer">金枪鱼之夜：基于完成的 Rust 异步：compio 项目及其经验</a></li><li><a href="https://zhuanlan.zhihu.com/p/670166312" target="_blank" rel="noopener noreferrer">用 Rust 搞科研的两年</a></li><li><a href="https://weihanglo.tw/posts/2024/the-missing-parts-in-cargo/" target="_blank" rel="noopener noreferrer">The missing parts in Cargo</a></li><li><a href="https://matklad.github.io/2021/09/04/fast-rust-builds.html" target="_blank" rel="noopener noreferrer">Fast Rust Builds</a></li><li><a href="https://nihil.cc/posts/phantom_index_type/" target="_blank" rel="noopener noreferrer">幽灵索引类型与匿名结构体</a></li><li><a href="https://github.com/pretzelhammer/rust-blog/blob/master/posts/translations/zh-hans/common-rust-lifetime-misconceptions.md" target="_blank" rel="noopener noreferrer">Rust 中常见的有关生命周期的误解</a></li></ol><hr class="footnotes-sep"><section class="footnotes"><ol class="footnotes-list"><li id="footnote1" class="footnote-item"><p>由于 rust 的 I/O 较为麻烦，leetcode （比起 <em>洛谷</em> 等）能免去 I/O 之苦。 <a href="#footnote-ref1" class="footnote-backref">↩︎</a></p></li><li id="footnote2" class="footnote-item"><p><a href="https://t.me/QC_Grove/734" target="_blank" rel="noopener noreferrer">https://t.me/QC_Grove/734</a> <a href="#footnote-ref2" class="footnote-backref">↩︎</a></p></li><li id="footnote3" class="footnote-item"><p>哪怕同一个编译器同一个包 rust 的编译是有副作用的，比如 env 宏 build script 乃至 proc macro，都是能任意副作用的 (<a href="https://t.me/c/1264662201/550767" target="_blank" rel="noopener noreferrer">ref</a>) <a href="#footnote-ref3" class="footnote-backref">↩︎</a></p></li><li id="footnote4" class="footnote-item"><p>为避免傻逼 openssl 造成的影响，建议添加 <code>feature = [&quot;rustls-tls&quot;]</code>。 <a href="#footnote-ref4" class="footnote-backref">↩︎</a></p></li><li id="footnote5" class="footnote-item"><p>openssl 不仅编译的工具链垃圾，性能也垃圾，打不过 pure rust 的 rustls，打不过<a href="https://gist.github.com/lxl66566/073843cce77477ef61be8b9260e0ccf1" target="_blank" rel="noopener noreferrer">手写的 simd</a>。这种垃圾还有什么存在的必要吗？ <a href="#footnote-ref5" class="footnote-backref">↩︎</a></p></li><li id="footnote6" class="footnote-item"><p><a href="https://t.me/withabsolutex/1441" target="_blank" rel="noopener noreferrer">review 还挺严格的</a>，但是 member 说话又好听 <a href="#footnote-ref6" class="footnote-backref">↩︎</a></p></li></ol></section></div><!----><!----><!----></div><footer class="vp-page-meta"><!----><div class="vp-meta-item git-info"><div class="update-time"><span class="vp-meta-label">最近更新：</span><time class="vp-meta-info" datetime="2025-08-18T15:21:27.000Z" data-allow-mismatch>2025/8/18 15:21</time></div></div></footer><nav class="vp-page-nav"><!----><a class="route-link auto-link next" href="/coding/Cpp.html" aria-label="C++" iconsizing="both"><div class="hint">下一页<span class="arrow end"></span></div><div class="link">C++<i class="vp-icon fas fa-code" sizing="height"></i></div></a></nav><div id="comment" class="giscus-wrapper input-top vp-comment" vp-comment style="display:block;"><div style="display: flex;
align-items: center;
justify-content: center;
height: 96px"><span style="--loading-icon: url(&quot;data:image/svg+xml;utf8,%3Csvg xmlns=&#39;http://www.w3.org/2000/svg&#39; preserveAspectRatio=&#39;xMidYMid&#39; viewBox=&#39;25 25 50 50&#39;%3E%3CanimateTransform attributeName=&#39;transform&#39; type=&#39;rotate&#39; dur=&#39;2s&#39; keyTimes=&#39;0;1&#39; repeatCount=&#39;indefinite&#39; values=&#39;0;360&#39;%3E%3C/animateTransform%3E%3Ccircle cx=&#39;50&#39; cy=&#39;50&#39; r=&#39;20&#39; fill=&#39;none&#39; stroke=&#39;currentColor&#39; stroke-width=&#39;4&#39; stroke-linecap=&#39;round&#39;%3E%3Canimate attributeName=&#39;stroke-dasharray&#39; dur=&#39;1.5s&#39; keyTimes=&#39;0;0.5;1&#39; repeatCount=&#39;indefinite&#39; values=&#39;1,200;90,200;1,200&#39;%3E%3C/animate%3E%3Canimate attributeName=&#39;stroke-dashoffset&#39; dur=&#39;1.5s&#39; keyTimes=&#39;0;0.5;1&#39; repeatCount=&#39;indefinite&#39; values=&#39;0;-35px;-125px&#39;%3E%3C/animate%3E%3C/circle%3E%3C/svg%3E&quot;);
--icon-size: 48px;
display: inline-block;
width: var(--icon-size);
height: var(--icon-size);
background-color: currentcolor;
-webkit-mask-image: var(--loading-icon);
mask-image: var(--loading-icon);
"></span></div></div><!----><!--]--></main><!--]--><!--]--><!----></div><!--]--><!--]--><!--[--><!----><!----><!--[--><!--]--><!--]--><!--]--></div>
    <script type="module" src="/assets/app-BNA6FKU6.js" defer></script>
  </body>
</html>
